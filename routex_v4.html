<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="handheldfriendly" content="true">
<meta name="handheldfriendly" content="true">
<meta name="theme-color" content="#3a4757">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>RouteX – Drive Easy, Delivery Happy</title>
<link rel="manifest" href="manifest.webmanifest">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.min.css"/>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=DM+Sans:wght@300;400;500;600&family=Noto+Sans+Tamil:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
/* ── TOKENS ── */
:root{
  /* light theme refined palette */
  --bg:#ffffff;--surface:#f8f9fa;--card:#ffffff;--border:#dee2e6;
  --accent:#3a4757;--yellow:#f0dc50;--green:#22c77a;--red:#e53935;
  --blue:#2d7ff9;--text:#1e2a35;--muted:#6c757d;
  --gold:#d7b56d;--gold2:#f4dd9b;
  --shadow:rgba(58,71,87,.09);--glass:rgba(255,255,255,.9);--gb:rgba(255,255,255,.92);
  --grad1:rgba(240,220,80,.04);--grad2:rgba(58,71,87,.02);--grad3:rgba(34,199,122,.03);
  --royalGlow:rgba(215,181,109,.2);
}
[data-theme=dark]{
  --bg:#0d0f15;--surface:#141720;--card:#1a1d28;--border:#252836;
  --accent:#f0dc50;--yellow:#f0dc50;--green:#00e08a;--red:#ff4444;
  --blue:#4d9fff;--text:#e5e8f0;--muted:#5a6278;
  --gold:#d7b56d;--gold2:#f4dd9b;
  --shadow:rgba(0,0,0,.45);--glass:rgba(20,23,32,.8);--gb:rgba(255,255,255,.07);
  --grad1:rgba(240,220,80,.04);--grad2:rgba(255,255,255,.02);--grad3:rgba(0,224,138,.04);
  --royalGlow:rgba(240,220,80,.18);
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;overflow:hidden;}
html.mobile,body.mobile{overflow:auto;height:auto;}
body{font-family:'DM Sans',sans-serif;background:linear-gradient(135deg,var(--bg) 0%,var(--surface) 100%);color:var(--text);display:flex;flex-direction:column;transition:background .3s,color .3s;}
body.lang-ta{font-family:'Noto Sans Tamil','DM Sans',sans-serif;}

/* ══ LANGUAGE SELECTOR ══ */
#lang-overlay{
  position:fixed;inset:0;z-index:999999;
  background:linear-gradient(135deg,var(--bg) 0%,var(--surface) 40%,#f0f4f8 100%);
  display:flex;align-items:center;justify-content:center;
  transition:opacity .5s ease;
}
[data-theme=dark] #lang-overlay{background:linear-gradient(135deg,#0d0f15 0%,#141720 60%,#0a0c12 100%);}
.lang-box{
  text-align:center;padding:48px 40px;max-width:460px;width:100%;
  background:rgba(255,255,255,.7);backdrop-filter:blur(24px);
  border:1px solid rgba(255,255,255,.9);border-radius:28px;
  box-shadow:0 32px 80px rgba(58,71,87,.12);
  animation:langBoxIn .6s cubic-bezier(.22,1,.36,1) both;
}
[data-theme=dark] .lang-box{background:rgba(26,29,40,.85);border-color:rgba(255,255,255,.07);}
@keyframes langBoxIn{from{opacity:0;transform:translateY(28px) scale(.96)}to{opacity:1;transform:none}}
.lang-truck-row{display:flex;justify-content:center;margin-bottom:20px;}
.lang-truck-svg{width:68px;height:68px;animation:float 6s ease-in-out infinite;filter:drop-shadow(0 8px 24px rgba(58,71,87,.2));}
.lang-brand{font-family:'Nunito',sans-serif;font-weight:900;font-size:36px;color:var(--accent);letter-spacing:-1.5px;margin-bottom:6px;}
.lang-welcome{font-size:15px;color:var(--muted);margin-bottom:8px;line-height:1.5;}
.lang-welcome-ta{font-family:'Noto Sans Tamil',sans-serif;font-size:14px;color:var(--muted);margin-bottom:28px;line-height:1.6;}
.lang-divider{display:flex;align-items:center;gap:10px;margin-bottom:24px;}
.lang-divider::before,.lang-divider::after{content:'';flex:1;height:1px;background:var(--border);}
.lang-divider span{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;font-weight:700;white-space:nowrap;}
.lang-cards{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:0;}
.lang-card{
  padding:22px 16px;border:2px solid var(--border);border-radius:16px;
  background:var(--card);cursor:pointer;transition:all .25s cubic-bezier(.22,1,.36,1);
  position:relative;overflow:hidden;
}
.lang-card::before{
  content:'';position:absolute;inset:0;
  background:linear-gradient(135deg,var(--grad1),transparent);
  opacity:0;transition:opacity .3s;
}
.lang-card:hover::before{opacity:1;}
.lang-card:hover{border-color:var(--accent);transform:translateY(-4px);box-shadow:0 16px 40px var(--shadow);}
.lang-card.selected{border-color:var(--accent);background:linear-gradient(135deg,rgba(58,71,87,.06),rgba(58,71,87,.02));box-shadow:0 8px 28px var(--shadow);}
[data-theme=dark] .lang-card.selected{background:linear-gradient(135deg,rgba(240,220,80,.08),rgba(240,220,80,.02));}
.lang-flag{font-size:32px;margin-bottom:10px;display:block;}
.lang-name{font-family:'Nunito',sans-serif;font-weight:900;font-size:17px;color:var(--accent);display:block;margin-bottom:4px;}
.lang-native{font-size:13px;color:var(--muted);display:block;}
.lang-native-ta{font-family:'Noto Sans Tamil',sans-serif;font-size:13px;}
.lang-confirm-btn{
  width:100%;margin-top:20px;padding:14px;background:var(--accent);color:var(--bg);border:none;
  border-radius:12px;font-family:'Nunito',sans-serif;font-weight:900;font-size:15px;
  cursor:pointer;transition:all .25s;opacity:0;pointer-events:none;
  box-shadow:0 6px 20px var(--shadow);
}
.lang-confirm-btn.visible{opacity:1;pointer-events:auto;animation:btnPop .3s cubic-bezier(.34,1.56,.64,1) both;}
.lang-confirm-btn:hover{transform:translateY(-2px);box-shadow:0 12px 32px var(--shadow);}
@keyframes btnPop{from{transform:scale(.9)}to{transform:scale(1)}}

/* ── AUTH ── */
#auth-overlay{
  position:fixed;inset:0;z-index:99999;
  background:linear-gradient(160deg,var(--bg) 0%,var(--surface) 60%,var(--bg) 100%);
  display:flex;align-items:center;justify-content:center;
  transition:opacity .4s;overflow-y:auto;padding:20px;
}
.auth-box{
  background:rgba(255,255,255,.72);backdrop-filter:blur(28px);
  border:1px solid rgba(255,255,255,.85);border-radius:24px;
  padding:36px 32px;width:100%;max-width:380px;
  box-shadow:0 24px 64px var(--shadow),inset 0 1px 0 rgba(255,255,255,.8);
  animation:authIn .5s cubic-bezier(.22,1,.36,1) both;
  position:relative;overflow:hidden;
}
[data-theme=dark] .auth-box{background:rgba(26,29,40,.85);border-color:rgba(255,255,255,.07);}
.auth-box::before{
  content:'';position:absolute;top:-60px;right:-60px;
  width:200px;height:200px;border-radius:50%;
  background:radial-gradient(circle,var(--grad1),transparent 70%);
  pointer-events:none;
}
@keyframes authIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:none}}
.auth-logo-row{display:flex;align-items:center;gap:10px;justify-content:center;margin-bottom:6px;}
.auth-truck-svg{width:44px;height:44px;animation:float 6s ease-in-out infinite;}
.auth-brand{font-family:'Nunito',sans-serif;font-weight:900;font-size:26px;color:var(--accent);letter-spacing:-1px;}
.auth-tag{text-align:center;font-size:12px;color:var(--muted);margin-bottom:26px;}
.tab-row{display:flex;background:var(--surface);border-radius:10px;padding:3px;gap:3px;margin-bottom:20px;}
.atab{flex:1;padding:8px;border:none;background:transparent;border-radius:8px;font-family:'Nunito',sans-serif;font-weight:700;font-size:13px;color:var(--muted);cursor:pointer;transition:all .2s;}
.atab.on{background:var(--card);color:var(--accent);box-shadow:0 2px 8px var(--shadow);}
.auth-field{position:relative;margin-bottom:20px;display:flex;flex-direction:column;}
.auth-field input{
  width:100%;padding:13px 16px;border:1.5px solid var(--border);border-radius:11px;
  background:rgba(255,255,255,.6);backdrop-filter:blur(8px);
  color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;
  transition:border-color .2s,box-shadow .2s;outline:none;
}
[data-theme=dark] .auth-field input{background:rgba(255,255,255,.04);}
.auth-field input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(58,71,87,.08);}
[data-theme=dark] .auth-field input:focus{box-shadow:0 0 0 3px rgba(240,220,80,.08);}
.auth-field label{
  /* keep label above input in login form to avoid overlap */
  position:static;
  margin-bottom:4px;
  background:transparent;
  padding:0;
  font-size:12px;font-weight:700;color:var(--muted);
  text-transform:none;letter-spacing:0;
}
.auth-err{color:var(--red);font-size:12px;margin-bottom:10px;text-align:center;display:none;padding:8px;background:rgba(229,57,53,.08);border-radius:8px;}
.auth-btn{
  width:100%;padding:14px;background:var(--accent);color:var(--bg);border:none;
  border-radius:11px;font-family:'Nunito',sans-serif;font-weight:900;font-size:15px;
  cursor:pointer;transition:all .22s;margin-top:4px;
  box-shadow:0 4px 16px var(--shadow);
}
.auth-btn:hover{opacity:.88;transform:translateY(-1px);box-shadow:0 8px 24px var(--shadow);}
.otp-wrap{margin-bottom:16px;}
.otp-hint{font-size:13px;color:var(--muted);text-align:center;margin-bottom:14px;line-height:1.5;}
.otp-demo{
  display:none;
  background:rgba(34,199,122,.1);border:1px dashed var(--green);
  border-radius:8px;padding:8px 12px;font-size:12px;font-weight:700;
  color:var(--green);text-align:center;margin-bottom:14px;
}
.otp-row{display:flex;gap:10px;justify-content:center;width:100%;}
.otp-box{
  width:56px;height:60px;border:2px solid var(--border);border-radius:12px;
  background:rgba(255,255,255,.6);backdrop-filter:blur(8px);
  color:var(--text);font-family:'Nunito',sans-serif;
  font-size:24px;font-weight:900;text-align:center;outline:none;
  transition:border-color .2s,transform .1s,box-shadow .2s;flex-shrink:0;
}
[data-theme=dark] .otp-box{background:rgba(255,255,255,.04);}
.otp-box:focus{border-color:var(--accent);transform:scale(1.05);box-shadow:0 0 0 3px rgba(58,71,87,.1);}
.otp-box.filled{border-color:var(--green);background:rgba(34,199,122,.06);}
.auth-back{display:block;text-align:center;margin-top:14px;font-size:12px;color:var(--muted);cursor:pointer;}
.auth-back:hover{color:var(--accent);}
.resend-row{text-align:center;margin-top:10px;font-size:12px;color:var(--muted);}
.resend-btn{color:var(--blue);cursor:pointer;font-weight:700;}
.resend-btn:hover{text-decoration:underline;}

/* Mobile responsiveness */
@media (max-width: 800px){
  .auth-box{max-width:92%;padding:20px 16px;border-radius:14px;}
  .logo-txt{font-size:16px}
  nav{padding:0 12px;height:56px}
  .nav-tabs{display:none} /* hide full nav on mobile */
  .nav-right{display:flex;gap:8px;align-items:center}
  .auth-field input{padding:12px;border-radius:10px;font-size:15px}
  .auth-btn{padding:12px;font-size:15px}
  .otp-box{width:44px;height:52px;font-size:20px}
  .otp-row{gap:8px}
  .route-alerts{left:10px;right:10px;max-width:unset}
  .ai-assistant-panel{width:100%;right:0;left:0;border-radius:12px 12px 0 0}
}

@media (max-width: 480px){
  .auth-box{padding:18px 12px}
  .logo-svg{width:28px;height:28px}
  .logo-txt{font-size:14px}
  .auth-field label{font-size:13px}
  .auth-err{font-size:13px;padding:6px}
  .help-fab{right:12px;bottom:12px}
}

/* responsive adjustments for mobile devices */
@media (max-width: 800px) {
  html,body {overflow:auto;height:auto;}
  .page {overflow:auto;}
  #dashboard{flex-direction:column;}
  .sidebar, .opt-side {width:100%;min-width:0;border-right:none;border-bottom:1px solid var(--border);}
  .map-wrap{height:calc(100vh - 58px);}
  .map-ctrls{top:auto;bottom:12px;flex-direction:row;flex-wrap:wrap;}
  .map-chips{left:10px;bottom:80px;}
}

/* also activate same rules when JS marks body/html as mobile */
html.mobile, body.mobile {
  overflow:auto;height:auto;
}
body.mobile .page{overflow:auto;}
body.mobile #dashboard{flex-direction:column;}
body.mobile .sidebar, body.mobile .opt-side {
  width:100%;min-width:0;border-right:none;border-bottom:1px solid var(--border);
}
body.mobile .map-wrap{height:calc(100vh - 58px);}
body.mobile .map-ctrls{top:auto;bottom:12px;flex-direction:row;flex-wrap:wrap;}
body.mobile .map-chips{left:10px;bottom:80px;}

/* mobile sidebar drawer */
body.mobile .sidebar{
  position:fixed;
  top:58px;
  left:-100%;
  height:calc(100% - 58px);
  width:80%;
  max-width:320px;
  transition:left .3s ease;
  z-index:10001;
}
body.mobile.sidebar-open .sidebar{left:0;}

body.mobile #mobile-overlay{
  display:none;
  position:fixed;
  inset:58px 0 0 0;
  background:rgba(0,0,0,.4);
  z-index:10000;
}
body.mobile.sidebar-open #mobile-overlay{display:block;}

/* hamburger shown only on mobile */
.mobile-menu-btn{display:none;}
body.mobile .mobile-menu-btn{display:flex;}

/* mobile close button inside sidebar header */
.mobile-close-btn{display:none;}
body.mobile .mobile-close-btn{display:flex;width:32px;height:32px;align-items:center;justify-content:center;font-size:18px;}


/* ── NAV ── */
nav{
  height:58px;min-height:58px;display:flex;align-items:center;
  justify-content:space-between;padding:0 20px;
  background:linear-gradient(90deg,rgba(255,255,255,.72) 0%,rgba(255,255,255,.6) 50%,rgba(255,255,255,.72) 100%);
  border-bottom:1px solid rgba(255,255,255,.6);
  backdrop-filter:blur(24px);z-index:9999;position:relative;
  box-shadow:0 1px 20px rgba(58,71,87,.06);
}
[data-theme=dark] nav{box-shadow:0 1px 20px rgba(0,0,0,.22),0 0 0 1px rgba(255,255,255,.03) inset;}
.logo-svg{filter:drop-shadow(0 0 10px var(--royalGlow));}
.btn-primary,.auth-btn,.run-btn,.mbtn-save,.help-fab,.avatar-btn{
  box-shadow:0 10px 28px var(--shadow),0 0 0 1px rgba(255,255,255,.22) inset,0 0 0 1px rgba(215,181,109,.12);
}
.btn-primary:hover,.auth-btn:hover,.run-btn:hover,.mbtn-save:hover,.help-fab:hover{box-shadow:0 16px 38px var(--shadow),0 0 24px var(--royalGlow);}
[data-theme=dark] nav{
  background:linear-gradient(90deg,rgba(20,23,32,.9) 0%,rgba(20,23,32,.8) 50%,rgba(20,23,32,.9) 100%);
  border-bottom-color:rgba(255,255,255,.05);box-shadow:0 1px 20px rgba(0,0,0,.2);
}
.logo{display:flex;align-items:center;gap:9px;cursor:pointer;text-decoration:none;}
.logo-svg{width:32px;height:32px;}
.logo-txt{font-family:'Nunito',sans-serif;font-weight:900;font-size:19px;color:var(--accent);letter-spacing:-0.5px;}
.nav-tabs{display:flex;gap:3px;}
.nav-tab{
  padding:7px 16px;border-radius:8px;border:none;background:transparent;
  color:var(--muted);font-family:'Nunito',sans-serif;font-size:13px;font-weight:700;
  cursor:pointer;transition:all .18s;white-space:nowrap;
}
body.lang-ta .nav-tab{font-family:'Noto Sans Tamil','Nunito',sans-serif;font-size:11px;padding:7px 10px;}
.nav-tab.active{background:var(--accent);color:var(--bg);}
.nav-tab:hover:not(.active){background:rgba(58,71,87,.07);color:var(--text);}
[data-theme=dark] .nav-tab:hover:not(.active){background:rgba(255,255,255,.06);}
.nav-right{display:flex;align-items:center;gap:8px;}
.geo-badge{
  display:flex;align-items:center;gap:5px;padding:5px 10px;border-radius:100px;
  font-size:11px;font-weight:700;border:1px solid var(--border);
  color:var(--muted);background:var(--surface);white-space:nowrap;
}
.geo-badge.live{border-color:rgba(34,199,122,.4);color:var(--green);background:rgba(34,199,122,.08);}
.geo-dot{width:6px;height:6px;border-radius:50%;background:currentColor;animation:blink 1.4s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.15}}
.icon-btn{
  width:40px;height:40px;border-radius:50%;border:1.5px solid var(--border);
  background:rgba(255,255,255,.5);backdrop-filter:blur(8px);cursor:pointer;
  display:flex;align-items:center;justify-content:center;font-size:15px;
  transition:all .2s;color:var(--text);touch-action:manipulation;-webkit-tap-highlight-color:rgba(0,0,0,0);
}
[data-theme=dark] .icon-btn{background:rgba(255,255,255,.04);}
.icon-btn:hover{background:var(--card);border-color:var(--accent);transform:scale(1.08);}
.avatar-btn{background:var(--accent);color:var(--bg);font-family:'Nunito',sans-serif;font-weight:900;font-size:13px;border-color:var(--accent);}
.help-fab{background:var(--accent);color:var(--bg);font-family:'Nunito',sans-serif;font-weight:900;font-size:16px;border:none;box-shadow:0 4px 14px var(--shadow);width:54px;height:54px;border-radius:50%;display:flex;align-items:center;justify-content:center;}

.route-alerts{
  position:absolute;
  bottom:120px;
  left:20px;
  max-width:300px;
  background:rgba(255,255,255,0.9);
  padding:8px;
  border-radius:4px;
  font-size:12px;
  z-index:1000;
  color:#000;
  display:none;
}
.lang-btn{
  font-size:11px;font-weight:700;padding:5px 10px;border-radius:8px;
  border:1.5px solid var(--border);background:rgba(255,255,255,.5);backdrop-filter:blur(8px);
  color:var(--muted);cursor:pointer;transition:all .2s;white-space:nowrap;
  font-family:'Nunito',sans-serif;
}
[data-theme=dark] .lang-btn{background:rgba(255,255,255,.04);}
.lang-btn:hover{border-color:var(--accent);color:var(--accent);transform:scale(1.05);}

/* ── PAGES ── */
.page{display:none;flex:1;overflow:hidden;}
.page.active{display:flex;flex-direction:column;}

/* ── HOME ── */
#home{overflow-y:auto;flex-direction:column;}
.hero{
  min-height:calc(100vh - 58px);display:flex;flex-direction:column;
  align-items:center;justify-content:center;text-align:center;
  padding:60px 32px;position:relative;overflow:hidden;
  background:linear-gradient(180deg,var(--bg) 0%,rgba(240,220,80,.04) 50%,var(--bg) 100%);
}
.hero-pattern{
  position:absolute;inset:0;
  background-image:radial-gradient(circle,var(--border) 1px,transparent 1px);
  background-size:28px 28px;
  mask-image:radial-gradient(ellipse 80% 80% at 50% 50%,black,transparent);
  opacity:.5;
}
.orb{position:absolute;border-radius:50%;filter:blur(80px);pointer-events:none;}
.orb1{width:560px;height:560px;background:radial-gradient(circle,rgba(240,220,80,.14) 0,rgba(240,220,80,.04) 50%,transparent 70%);top:-180px;left:-140px;animation:float 9s ease-in-out infinite;}
.orb2{width:400px;height:400px;background:radial-gradient(circle,rgba(58,71,87,.08) 0,rgba(34,199,122,.04) 50%,transparent 70%);bottom:-80px;right:-80px;animation:float 13s ease-in-out infinite reverse;}
.orb3{width:300px;height:300px;background:radial-gradient(circle,rgba(45,127,249,.06) 0,transparent 70%);bottom:20%;left:10%;animation:float 11s ease-in-out 2s infinite;}
@keyframes float{0%,100%{transform:translate(0,0)}50%{transform:translate(18px,-28px)}}
.hero-logo-area{display:flex;align-items:center;justify-content:center;gap:14px;margin-bottom:16px;position:relative;}
.hero-truck{width:84px;height:84px;filter:drop-shadow(0 8px 24px rgba(58,71,87,.2));animation:float 6s ease-in-out infinite;}
.hero-brand{font-family:'Nunito',sans-serif;font-weight:900;font-size:clamp(48px,9vw,96px);color:var(--accent);letter-spacing:-3px;line-height:1;}
.hero-tagline{font-family:'Nunito',sans-serif;font-weight:800;font-size:20px;color:var(--accent);margin-bottom:14px;position:relative;opacity:.75;}
body.lang-ta .hero-tagline{font-family:'Noto Sans Tamil','Nunito',sans-serif;font-size:16px;}
.hero-sub{font-size:16px;color:var(--muted);max-width:480px;line-height:1.7;margin-bottom:36px;position:relative;}
body.lang-ta .hero-sub{font-family:'Noto Sans Tamil','DM Sans',sans-serif;font-size:14px;line-height:1.8;}
.hero-btns{display:flex;gap:12px;justify-content:center;position:relative;flex-wrap:wrap;}
.btn-primary{
  background:var(--accent);color:var(--bg);border:none;padding:14px 28px;
  border-radius:10px;font-family:'Nunito',sans-serif;font-weight:800;font-size:14px;
  cursor:pointer;transition:all .22s;box-shadow:0 6px 20px var(--shadow);
  white-space:nowrap;
}
body.lang-ta .btn-primary{font-family:'Noto Sans Tamil','Nunito',sans-serif;font-size:13px;padding:14px 22px;}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 12px 30px var(--shadow);}
.btn-outline{
  background:rgba(255,255,255,.6);backdrop-filter:blur(12px);
  color:var(--text);border:1.5px solid var(--border);
  padding:14px 28px;border-radius:10px;font-family:'Nunito',sans-serif;
  font-weight:700;font-size:14px;cursor:pointer;transition:all .22s;
  white-space:nowrap;
}
body.lang-ta .btn-outline{font-family:'Noto Sans Tamil','Nunito',sans-serif;font-size:13px;padding:14px 20px;}
.btn-outline:hover{border-color:var(--accent);transform:translateY(-2px);}
.stats-row{
  display:grid;grid-template-columns:repeat(3,1fr);
  background:var(--border);border-top:1px solid var(--border);border-bottom:1px solid var(--border);
}
.stat-cell{
  background:linear-gradient(135deg,var(--surface) 0%,var(--card) 100%);
  padding:28px;text-align:center;position:relative;overflow:hidden;
}
.stat-cell::before{content:'';position:absolute;top:-30px;right:-30px;width:100px;height:100px;border-radius:50%;background:radial-gradient(circle,var(--grad1),transparent 70%);pointer-events:none;}
.stat-n{font-family:'Nunito',sans-serif;font-size:48px;font-weight:900;color:var(--accent);letter-spacing:-2px;line-height:1;display:block;}
.stat-l{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;margin-top:6px;display:block;}
body.lang-ta .stat-l{font-family:'Noto Sans Tamil',sans-serif;font-size:10px;letter-spacing:.5px;text-transform:none;}
.feat-grid{
  display:grid;grid-template-columns:repeat(3,1fr);gap:2px;
  background:var(--border);max-width:1100px;margin:50px auto;padding:0 28px;
}
.feat-card{
  background:linear-gradient(135deg,var(--surface) 0%,var(--card) 100%);
  padding:28px;transition:all .3s cubic-bezier(.22,1,.36,1);position:relative;overflow:hidden;
}
.feat-card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,var(--grad3),var(--grad1));opacity:0;transition:opacity .35s;}
.feat-card:hover::before{opacity:1;}
.feat-card:hover{transform:translateY(-2px);box-shadow:0 12px 32px var(--shadow);}
.feat-card::after{content:'';position:absolute;top:0;left:0;width:3px;height:0;background:linear-gradient(180deg,var(--accent),var(--green));transition:height .35s;}
.feat-card:hover::after{height:100%;}
.feat-icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;margin-bottom:16px;background:rgba(255,255,255,.5);backdrop-filter:blur(8px);border:1.5px solid var(--border);position:relative;}
[data-theme=dark] .feat-icon{background:rgba(255,255,255,.04);}
.feat-title{font-family:'Nunito',sans-serif;font-size:15px;font-weight:800;margin-bottom:8px;}
body.lang-ta .feat-title{font-family:'Noto Sans Tamil','Nunito',sans-serif;font-size:13px;line-height:1.5;}
.feat-desc{font-size:13px;color:var(--muted);line-height:1.6;}
body.lang-ta .feat-desc{font-family:'Noto Sans Tamil',sans-serif;font-size:12px;line-height:1.7;}
.footer{text-align:center;padding:16px;font-size:11px;color:var(--muted);background:linear-gradient(90deg,var(--surface),var(--card),var(--surface));border-top:1px solid var(--border);}

/* ── DASHBOARD ── */
#dashboard{flex-direction:row;}
.sidebar{
  width:320px;min-width:320px;
  background:linear-gradient(180deg,var(--surface) 0%,rgba(255,255,255,.05) 100%);
  border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;
}
[data-theme=dark] .sidebar{background:linear-gradient(180deg,var(--surface) 0%,rgba(255,255,255,.01) 100%);}
.sidebar-hdr{
  padding:16px 18px 13px;border-bottom:1px solid var(--border);flex-shrink:0;
  display:flex;align-items:center;justify-content:space-between;
  background:rgba(255,255,255,.4);backdrop-filter:blur(12px);
}
[data-theme=dark] .sidebar-hdr{background:rgba(255,255,255,.02);}
.sidebar-title{font-family:'Nunito',sans-serif;font-size:14px;font-weight:800;margin-bottom:2px;}
body.lang-ta .sidebar-title{font-family:'Noto Sans Tamil','Nunito',sans-serif;font-size:13px;}
.sidebar-sub{font-size:11px;color:var(--muted);}
.add-btn{
  padding:6px 12px;border-radius:8px;border:1.5px solid var(--accent);
  background:transparent;color:var(--accent);font-family:'Nunito',sans-serif;
  font-weight:800;font-size:12px;cursor:pointer;transition:all .2s;white-space:nowrap;
}
body.lang-ta .add-btn{font-family:'Noto Sans Tamil','Nunito',sans-serif;font-size:11px;padding:6px 9px;}
.add-btn:hover{background:var(--accent);color:var(--bg);}
.kpi-strip{display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:var(--border);border-bottom:1px solid var(--border);flex-shrink:0;}
.kpi{background:linear-gradient(135deg,var(--surface) 0%,rgba(255,255,255,.04) 100%);padding:12px 14px;}
.kpi-lbl{font-size:9px;text-transform:uppercase;letter-spacing:1.4px;color:var(--muted);margin-bottom:4px;}
body.lang-ta .kpi-lbl{font-family:'Noto Sans Tamil',sans-serif;font-size:9px;letter-spacing:.3px;text-transform:none;}
.kpi-val{font-family:'Nunito',sans-serif;font-size:22px;font-weight:900;line-height:1;letter-spacing:-1px;}
.kv-y{color:var(--accent);}.kv-g{color:var(--green);}.kv-r{color:var(--red);}.kv-b{color:var(--blue);}
.kpi-sub{font-size:10px;color:var(--muted);margin-top:2px;}
body.lang-ta .kpi-sub{font-family:'Noto Sans Tamil',sans-serif;font-size:9px;}
.alert-bar{margin:8px;padding:10px 12px;background:rgba(229,57,53,.07);border:1px solid rgba(229,57,53,.25);border-radius:10px;font-size:12px;line-height:1.5;display:flex;gap:8px;align-items:flex-start;flex-shrink:0;}
.alert-close{margin-left:auto;cursor:pointer;color:var(--muted);font-size:14px;}
.del-scroll{flex:1;overflow-y:auto;}
.del-scroll::-webkit-scrollbar{width:3px;}
.del-scroll::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
.d-item{
  display:flex;align-items:center;gap:9px;padding:10px 14px;
  border-bottom:1px solid rgba(0,0,0,.04);cursor:pointer;
  transition:background .15s,transform .15s;
}
[data-theme=dark] .d-item{border-bottom-color:rgba(255,255,255,.03);}
.d-item:hover{background:rgba(58,71,87,.04);transform:translateX(2px);}
[data-theme=dark] .d-item:hover{background:rgba(255,255,255,.03);}
.d-av{width:34px;height:34px;border-radius:9px;display:flex;align-items:center;justify-content:center;flex-shrink:0;background:rgba(255,255,255,.4);backdrop-filter:blur(8px);border:1.5px solid var(--border);}
[data-theme=dark] .d-av{background:rgba(255,255,255,.04);}
.d-info{flex:1;min-width:0;}
.d-id{font-family:'Nunito',sans-serif;font-size:12px;font-weight:800;}
.d-addr{font-size:11px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:1px;}
.d-eta{font-size:10px;color:var(--accent);font-weight:700;margin-top:2px;}
.badge{font-size:10px;font-weight:700;padding:3px 8px;border-radius:100px;flex-shrink:0;white-space:nowrap;}
.b-on{background:rgba(34,199,122,.12);color:var(--green);}
.b-late{background:rgba(229,57,53,.12);color:var(--red);}
.b-wait{background:rgba(58,71,87,.1);color:var(--accent);}
[data-theme=dark] .b-wait{background:rgba(240,220,80,.1);color:var(--accent);}
.b-done{background:rgba(0,0,0,.06);color:var(--muted);}
[data-theme=dark] .b-done{background:rgba(255,255,255,.06);}
.d-actions{display:flex;flex-direction:column;gap:3px;align-items:flex-end;}
.d-act-btn{font-size:10px;color:var(--muted);cursor:pointer;padding:1px 3px;}
.d-act-btn:hover{color:var(--red);}
.d-act-btn.ok:hover{color:var(--green);}
.empty-dash{padding:40px 20px;text-align:center;color:var(--muted);}
.empty-dash svg{margin-bottom:10px;opacity:.4;}
.empty-title{font-family:'Nunito',sans-serif;font-weight:800;margin-bottom:4px;}
body.lang-ta .empty-title{font-family:'Noto Sans Tamil','Nunito',sans-serif;}
.map-wrap{flex:1;position:relative;overflow:hidden;}
#dash-map{width:100%;height:100%;}
.map-ctrls{position:absolute;top:12px;right:12px;z-index:1000;display:flex;flex-direction:column;gap:7px;}
.map-btn{
  padding:7px 13px;border-radius:8px;border:1px solid rgba(255,255,255,.5);
  background:rgba(255,255,255,.72);backdrop-filter:blur(16px);
  color:var(--text);font-family:'Nunito',sans-serif;
  font-weight:700;font-size:11px;cursor:pointer;
  transition:all .18s;white-space:nowrap;display:flex;align-items:center;gap:5px;
  box-shadow:0 2px 8px rgba(58,71,87,.08);
}
[data-theme=dark] .map-btn{background:rgba(20,23,32,.85);border-color:rgba(255,255,255,.07);}
body.lang-ta .map-btn{font-family:'Noto Sans Tamil','Nunito',sans-serif;font-size:10px;padding:7px 10px;}
.map-btn:hover{background:var(--card);border-color:var(--accent);color:var(--accent);}
.map-btn.live-on{background:rgba(34,199,122,.12);border-color:rgba(34,199,122,.4);color:var(--green);}
.map-chips{position:absolute;bottom:12px;left:12px;z-index:1000;display:flex;gap:7px;flex-wrap:wrap;}
.chip{
  padding:5px 11px;border-radius:100px;
  background:rgba(255,255,255,.72);backdrop-filter:blur(16px);
  border:1px solid rgba(255,255,255,.6);
  font-size:10px;font-weight:700;color:var(--muted);
  display:flex;align-items:center;gap:5px;
  box-shadow:0 2px 8px rgba(58,71,87,.06);
}
[data-theme=dark] .chip{background:rgba(20,23,32,.85);border-color:rgba(255,255,255,.07);}
body.lang-ta .chip{font-family:'Noto Sans Tamil',sans-serif;font-size:9px;}
.dot{width:6px;height:6px;border-radius:50%;}

/* ── MODAL ── */
.modal-bg{
  position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:10000;
  display:flex;align-items:center;justify-content:center;backdrop-filter:blur(6px);
  padding:20px;
}
.modal{
  background:rgba(255,255,255,.82);backdrop-filter:blur(28px);
  border:1px solid rgba(255,255,255,.9);border-radius:18px;
  padding:28px;width:100%;max-width:460px;
  box-shadow:0 24px 64px var(--shadow),inset 0 1px 0 rgba(255,255,255,.8);
  max-height:90vh;overflow-y:auto;
  animation:modalIn .3s cubic-bezier(.22,1,.36,1) both;
}
[data-theme=dark] .modal{background:rgba(26,29,40,.9);border-color:rgba(255,255,255,.07);}
@keyframes modalIn{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:none}}
.modal::-webkit-scrollbar{width:3px;}
.modal::-webkit-scrollbar-thumb{background:var(--border);}
.modal-ttl{font-family:'Nunito',sans-serif;font-weight:900;font-size:17px;margin-bottom:18px;display:flex;align-items:center;gap:8px;}
body.lang-ta .modal-ttl{font-family:'Noto Sans Tamil','Nunito',sans-serif;font-size:15px;}
.loc-choice-row{display:flex;gap:8px;margin-bottom:12px;}
.loc-choice{
  flex:1;padding:10px 8px;border:1.5px solid var(--border);border-radius:9px;
  background:rgba(255,255,255,.5);backdrop-filter:blur(8px);
  cursor:pointer;text-align:center;transition:all .15s;
  font-family:'Nunito',sans-serif;font-weight:700;font-size:12px;color:var(--muted);
}
body.lang-ta .loc-choice{font-family:'Noto Sans Tamil','Nunito',sans-serif;font-size:11px;}
[data-theme=dark] .loc-choice{background:rgba(255,255,255,.03);}
.loc-choice.sel{background:var(--accent);border-color:var(--accent);color:var(--bg);}
.loc-choice:hover:not(.sel){border-color:var(--accent);color:var(--accent);}
.geocoder-wrap{position:relative;margin-bottom:10px;}
.geocoder-input{
  width:100%;padding:11px 14px 11px 38px;border:1.5px solid var(--border);border-radius:9px;
  background:rgba(255,255,255,.6);backdrop-filter:blur(8px);
  color:var(--text);font-family:'DM Sans',sans-serif;
  font-size:13px;outline:none;transition:border-color .2s,box-shadow .2s;
}
[data-theme=dark] .geocoder-input{background:rgba(255,255,255,.04);}
.geocoder-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(58,71,87,.06);}
.geocoder-icon{position:absolute;left:11px;top:50%;transform:translateY(-50%);color:var(--muted);}
.geocoder-list{
  position:absolute;top:100%;left:0;right:0;background:rgba(255,255,255,.95);backdrop-filter:blur(16px);
  border:1px solid var(--border);border-radius:9px;margin-top:4px;
  box-shadow:0 8px 24px var(--shadow);z-index:100;max-height:200px;overflow-y:auto;display:none;
}
[data-theme=dark] .geocoder-list{background:rgba(26,29,40,.95);}
.geocoder-item{padding:10px 14px;cursor:pointer;font-size:13px;border-bottom:1px solid rgba(0,0,0,.05);transition:background .1s;display:flex;flex-direction:column;gap:2px;}
.geocoder-item:hover{background:var(--surface);}
.geocoder-item-main{font-weight:600;}
.geocoder-item-sub{font-size:11px;color:var(--muted);}
.geocoder-item:last-child{border-bottom:none;}
.map-pick-hint{
  background:rgba(34,199,122,.06);border:1px dashed rgba(34,199,122,.4);
  border-radius:8px;padding:10px 12px;font-size:12px;color:var(--green);
  display:flex;align-items:center;gap:8px;margin-bottom:10px;
}
body.lang-ta .map-pick-hint{font-family:'Noto Sans Tamil',sans-serif;font-size:11px;line-height:1.6;}
.map-pick-mini{width:100%;height:180px;border-radius:9px;border:1.5px solid var(--border);overflow:hidden;margin-bottom:10px;display:none;}
.coord-display{
  display:none;gap:6px;align-items:center;font-size:11px;color:var(--muted);
  background:rgba(255,255,255,.5);backdrop-filter:blur(8px);
  border-radius:7px;padding:7px 10px;margin-bottom:10px;border:1px solid var(--border);
}
[data-theme=dark] .coord-display{background:rgba(255,255,255,.03);}
.coord-display.shown{display:flex;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;}
.form-row.one{grid-template-columns:1fr;}
.finp-wrap{display:flex;flex-direction:column;gap:4px;}
.finp-lbl{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);font-weight:700;}
body.lang-ta .finp-lbl{font-family:'Noto Sans Tamil',sans-serif;font-size:9px;letter-spacing:.3px;text-transform:none;}
.finp{
  width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:9px;
  background:rgba(255,255,255,.6);backdrop-filter:blur(8px);
  color:var(--text);font-family:'DM Sans',sans-serif;
  font-size:13px;outline:none;transition:border-color .2s,box-shadow .2s;
}
[data-theme=dark] .finp{background:rgba(255,255,255,.04);}
.finp:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(58,71,87,.06);}
.fsel{appearance:none;cursor:pointer;}
.modal-btns{display:flex;gap:10px;margin-top:18px;}
.mbtn-cancel{flex:1;padding:11px;border:1.5px solid var(--border);background:transparent;color:var(--muted);border-radius:9px;font-family:'Nunito',sans-serif;font-weight:700;cursor:pointer;transition:all .2s;}
body.lang-ta .mbtn-cancel{font-family:'Noto Sans Tamil','Nunito',sans-serif;font-size:12px;}
.mbtn-cancel:hover{border-color:var(--red);color:var(--red);}
.mbtn-save{flex:2;padding:11px;border:none;background:var(--accent);color:var(--bg);border-radius:9px;font-family:'Nunito',sans-serif;font-weight:900;cursor:pointer;transition:all .2s;box-shadow:0 4px 14px var(--shadow);}
body.lang-ta .mbtn-save{font-family:'Noto Sans Tamil','Nunito',sans-serif;font-size:12px;}
.mbtn-save:hover{opacity:.88;transform:translateY(-1px);}

/* ── OPTIMIZER ── */
#optimizer{flex-direction:row;overflow:hidden;}
.opt-side{
  width:360px;min-width:360px;
  background:linear-gradient(180deg,var(--surface) 0%,rgba(255,255,255,.03) 100%);
  border-right:1px solid var(--border);overflow-y:auto;padding:20px 18px;
}
.opt-side::-webkit-scrollbar{width:3px;}
.opt-side::-webkit-scrollbar-thumb{background:var(--border);}
.opt-ttl{font-family:'Nunito',sans-serif;font-size:19px;font-weight:900;letter-spacing:-.5px;margin-bottom:3px;}
body.lang-ta .opt-ttl{font-family:'Noto Sans Tamil','Nunito',sans-serif;font-size:16px;letter-spacing:0;}
.opt-sub{font-size:12px;color:var(--muted);margin-bottom:20px;line-height:1.5;}
body.lang-ta .opt-sub{font-family:'Noto Sans Tamil',sans-serif;font-size:11px;line-height:1.7;}
.section-block{margin-bottom:18px;}
.sec-lbl{font-size:10px;text-transform:uppercase;letter-spacing:1.4px;color:var(--muted);margin-bottom:8px;font-weight:700;display:block;}
body.lang-ta .sec-lbl{font-family:'Noto Sans Tamil',sans-serif;font-size:10px;letter-spacing:.3px;text-transform:none;}
.order-box{
  background:rgba(255,255,255,.5);backdrop-filter:blur(12px);
  border:1.5px solid var(--border);border-radius:11px;padding:14px;margin-bottom:16px;
}
[data-theme=dark] .order-box{background:rgba(255,255,255,.03);}
.order-box-ttl{font-family:'Nunito',sans-serif;font-weight:800;font-size:13px;margin-bottom:10px;display:flex;align-items:center;gap:6px;}
body.lang-ta .order-box-ttl{font-family:'Noto Sans Tamil','Nunito',sans-serif;font-size:12px;}
.order-scroll{max-height:160px;overflow-y:auto;margin-bottom:8px;}
.order-scroll::-webkit-scrollbar{width:3px;}
.order-scroll::-webkit-scrollbar-thumb{background:var(--border);}
.ord-item{display:flex;align-items:center;gap:7px;padding:7px 9px;border-radius:8px;background:rgba(255,255,255,.4);backdrop-filter:blur(8px);margin-bottom:5px;font-size:11px;border:1px solid var(--border);}
[data-theme=dark] .ord-item{background:rgba(255,255,255,.02);}
.ord-id{font-family:'Nunito',sans-serif;font-weight:800;color:var(--accent);min-width:72px;}
.ord-addr{flex:1;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.ord-status{padding:2px 7px;border-radius:100px;font-size:10px;font-weight:700;flex-shrink:0;}
.s-late{background:rgba(229,57,53,.12);color:var(--red);}
.s-ok{background:rgba(34,199,122,.12);color:var(--green);}
.s-pend{background:rgba(58,71,87,.1);color:var(--accent);}
[data-theme=dark] .s-pend{background:rgba(240,220,80,.1);}
.rem-x{cursor:pointer;color:var(--red);font-size:14px;line-height:1;flex-shrink:0;}
.opt-no-orders{text-align:center;color:var(--muted);font-size:12px;padding:14px;}
body.lang-ta .opt-no-orders{font-family:'Noto Sans Tamil',sans-serif;font-size:11px;line-height:1.7;}
.add-ord-form{border-top:1px dashed var(--border);padding-top:10px;margin-top:4px;}
.add-ord-ttl{font-size:11px;color:var(--muted);font-weight:700;margin-bottom:8px;text-transform:uppercase;letter-spacing:1px;}
body.lang-ta .add-ord-ttl{font-family:'Noto Sans Tamil',sans-serif;font-size:10px;letter-spacing:.3px;text-transform:none;}
.opt-geocoder-wrap{position:relative;margin-bottom:8px;}
.opt-gc-input{
  width:100%;padding:9px 12px 9px 32px;border:1.5px solid var(--border);border-radius:8px;
  background:rgba(255,255,255,.6);backdrop-filter:blur(8px);
  color:var(--text);font-size:12px;font-family:'DM Sans',sans-serif;
  outline:none;transition:border-color .2s,box-shadow .2s;
}
[data-theme=dark] .opt-gc-input{background:rgba(255,255,255,.04);}
.opt-gc-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(58,71,87,.06);}
.opt-gc-icon{position:absolute;left:9px;top:50%;transform:translateY(-50%);color:var(--muted);}
.opt-gc-list{
  position:absolute;top:100%;left:0;right:0;background:rgba(255,255,255,.95);backdrop-filter:blur(16px);
  border:1px solid var(--border);border-radius:8px;margin-top:3px;
  box-shadow:0 8px 20px var(--shadow);z-index:200;max-height:160px;overflow-y:auto;display:none;
}
[data-theme=dark] .opt-gc-list{background:rgba(26,29,40,.95);}
.opt-gc-item{padding:8px 12px;cursor:pointer;font-size:12px;border-bottom:1px solid rgba(0,0,0,.05);}
.opt-gc-item:hover{background:var(--surface);}
.opt-gc-item:last-child{border-bottom:none;}
.opt-inp-row{display:flex;gap:7px;margin-bottom:7px;}
.opt-inp{
  flex:1;padding:8px 10px;border:1.5px solid var(--border);border-radius:8px;
  background:rgba(255,255,255,.6);backdrop-filter:blur(8px);
  color:var(--text);font-size:12px;font-family:'DM Sans',sans-serif;
  outline:none;transition:border-color .2s;
}
[data-theme=dark] .opt-inp{background:rgba(255,255,255,.04);}
.opt-inp:focus{border-color:var(--accent);}
.opt-add-btn{
  padding:8px 14px;background:var(--accent);color:var(--bg);border:none;
  border-radius:8px;font-family:'Nunito',sans-serif;font-weight:800;font-size:12px;
  cursor:pointer;transition:all .2s;white-space:nowrap;
  box-shadow:0 3px 10px var(--shadow);
}
body.lang-ta .opt-add-btn{font-family:'Noto Sans Tamil','Nunito',sans-serif;font-size:11px;}
.opt-add-btn:hover{opacity:.88;transform:translateY(-1px);}
.map-click-hint{
  font-size:10px;color:var(--muted);background:rgba(255,255,255,.4);backdrop-filter:blur(8px);
  border-radius:6px;padding:5px 8px;display:flex;align-items:center;gap:5px;border:1px solid var(--border);
}
[data-theme=dark] .map-click-hint{background:rgba(255,255,255,.03);}
body.lang-ta .map-click-hint{font-family:'Noto Sans Tamil',sans-serif;font-size:9px;line-height:1.6;}
.form-select{
  width:100%;background:rgba(255,255,255,.6);backdrop-filter:blur(8px);
  border:1.5px solid var(--border);border-radius:9px;
  padding:10px 12px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;
  transition:border-color .2s;appearance:none;cursor:pointer;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath d='M2 4l4 4 4-4' stroke='%23888' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 12px center;padding-right:32px;
}
[data-theme=dark] .form-select{background-color:rgba(255,255,255,.04);}
.form-select:focus{outline:none;border-color:var(--accent);}
.tgl-row{display:flex;gap:7px;flex-wrap:wrap;}
.tgl{
  flex:1;padding:8px 6px;border:1.5px solid var(--border);border-radius:8px;
  background:rgba(255,255,255,.4);backdrop-filter:blur(8px);
  color:var(--muted);font-size:12px;font-weight:600;
  cursor:pointer;text-align:center;transition:all .15s;font-family:'DM Sans',sans-serif;
  min-width:60px;white-space:nowrap;
}
body.lang-ta .tgl{font-family:'Noto Sans Tamil',sans-serif;font-size:11px;min-width:50px;padding:8px 4px;}
[data-theme=dark] .tgl{background:rgba(255,255,255,.03);}
.tgl.on{background:var(--accent);border-color:var(--accent);color:var(--bg);font-weight:700;}
.slider-row{display:flex;align-items:center;gap:10px;}
.slider{flex:1;-webkit-appearance:none;appearance:none;height:4px;border-radius:2px;background:var(--border);outline:none;}
.slider::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:var(--accent);cursor:pointer;border:2px solid var(--bg);box-shadow:0 2px 6px var(--shadow);}
.slv{font-family:'Nunito',sans-serif;font-size:13px;font-weight:900;color:var(--accent);min-width:44px;text-align:right;}
.run-btn{
  width:100%;padding:14px;background:linear-gradient(135deg,var(--accent) 0%,rgba(58,71,87,.9) 100%);
  border:none;border-radius:10px;
  font-family:'Nunito',sans-serif;font-weight:900;font-size:15px;color:var(--bg);
  cursor:pointer;transition:all .22s;display:flex;align-items:center;justify-content:center;
  gap:8px;margin-top:4px;box-shadow:0 6px 24px var(--shadow);
}
body.lang-ta .run-btn{font-family:'Noto Sans Tamil','Nunito',sans-serif;font-size:13px;}
[data-theme=dark] .run-btn{background:linear-gradient(135deg,#f0dc50 0%,#e8d040 100%);}
.run-btn:hover{box-shadow:0 12px 36px var(--shadow);transform:translateY(-1px);}
.run-btn:disabled{opacity:.6;cursor:not-allowed;transform:none;box-shadow:none;}
.spin{width:15px;height:15px;border:2.5px solid rgba(0,0,0,.2);border-top-color:var(--bg);border-radius:50%;animation:spin .7s linear infinite;display:none;}
@keyframes spin{to{transform:rotate(360deg)}}
.opt-map-area{flex:1;display:flex;flex-direction:column;overflow:hidden;position:relative;}
#opt-map{flex:1;}
.route-results{
  height:190px;min-height:190px;
  background:linear-gradient(180deg,var(--surface) 0%,rgba(255,255,255,.04) 100%);
  border-top:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;
}
.results-top{
  padding:10px 18px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;flex-shrink:0;
  background:rgba(255,255,255,.3);backdrop-filter:blur(12px);
}
[data-theme=dark] .results-top{background:rgba(255,255,255,.02);}
.res-lbl{font-family:'Nunito',sans-serif;font-size:13px;font-weight:800;}
body.lang-ta .res-lbl{font-family:'Noto Sans Tamil','Nunito',sans-serif;font-size:11px;}
.res-kpis{display:flex;background:var(--border);}
.r-kpi{flex:1;background:linear-gradient(135deg,var(--card) 0%,rgba(255,255,255,.06) 100%);padding:10px 14px;border-right:1px solid var(--border);text-align:center;}
.r-kpi:last-child{border-right:none;}
.r-kv{font-family:'Nunito',sans-serif;font-size:19px;font-weight:900;letter-spacing:-.5px;color:var(--green);}
.r-kl{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-top:2px;}
body.lang-ta .r-kl{font-family:'Noto Sans Tamil',sans-serif;font-size:9px;letter-spacing:.3px;text-transform:none;}
.stops-row{flex:1;display:flex;align-items:center;overflow-x:auto;padding:0 14px;scrollbar-width:thin;}
.stops-row::-webkit-scrollbar{height:3px;}
.stops-row::-webkit-scrollbar-thumb{background:var(--border);}
.rs-stop{display:flex;align-items:center;flex-shrink:0;}
.rs-dot{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:900;font-family:'Nunito',sans-serif;flex-shrink:0;border:2px solid var(--bg);}
.rs-dot.w{background:var(--accent);color:var(--bg);}
.rs-dot.d{background:var(--green);color:var(--bg);}
.rs-dot.s{background:var(--card);color:var(--text);border-color:var(--border);}
.rs-line{width:28px;height:2px;background:linear-gradient(90deg,var(--border),var(--accent),var(--border));opacity:.5;}
.rs-name{position:absolute;top:30px;left:50%;transform:translateX(-50%);font-size:8px;color:var(--muted);white-space:nowrap;max-width:68px;overflow:hidden;text-overflow:ellipsis;text-align:center;}
.rs-inner{position:relative;display:flex;flex-direction:column;align-items:center;}
.ai-route-badge{
  display:flex;align-items:center;gap:6px;padding:8px 12px;border-radius:8px;
  background:rgba(34,199,122,.06);border:1px solid rgba(34,199,122,.2);
  font-size:11px;color:var(--green);margin-bottom:14px;
  backdrop-filter:blur(8px);
}
body.lang-ta .ai-route-badge{font-family:'Noto Sans Tamil',sans-serif;font-size:10px;line-height:1.6;}
.ai-route-badge svg{flex-shrink:0;}

/* ── LEAFLET ── */
.leaflet-container{background:var(--surface) !important;}
[data-theme=dark] .leaflet-container{background:#0e0e18 !important;}
[data-theme=dark] .leaflet-tile.osm-tile{filter:brightness(.8) saturate(.7) hue-rotate(200deg);}
[data-theme=dark] .leaflet-tile.sat-tile{filter:none;}
.leaflet-popup-content-wrapper{background:rgba(255,255,255,.9);backdrop-filter:blur(16px);color:var(--text);border:1px solid var(--border);border-radius:10px;box-shadow:0 8px 24px var(--shadow);}
[data-theme=dark] .leaflet-popup-content-wrapper{background:rgba(26,29,40,.95);}
.leaflet-popup-tip{background:rgba(255,255,255,.9);}
[data-theme=dark] .leaflet-popup-tip{background:rgba(26,29,40,.95);}
.leaflet-popup-content{margin:10px 14px;font-family:'DM Sans',sans-serif;font-size:13px;}
.leaflet-routing-container{display:none!important;}
.leaflet-control, .leaflet-control a, .leaflet-bar a{touch-action:manipulation;-webkit-tap-highlight-color:rgba(0,0,0,0);}
.lpop-id{font-family:'Nunito',sans-serif;font-weight:800;font-size:14px;margin-bottom:3px;}
.lpop-addr{color:var(--muted);font-size:12px;margin-bottom:5px;}
.lpop-badge{display:inline-block;padding:2px 8px;border-radius:100px;font-size:11px;font-weight:700;}
.user-pulse{width:20px;height:20px;border-radius:50%;background:rgba(34,199,122,.3);border:3px solid var(--green);box-shadow:0 0 0 6px rgba(34,199,122,.1);animation:pulse 2s ease-out infinite;}
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(34,199,122,.4)}70%{box-shadow:0 0 0 14px rgba(34,199,122,0)}100%{box-shadow:0 0 0 0 rgba(34,199,122,0)}}

/* ── TOUR ── */
#tour-bg{position:fixed;inset:0;z-index:99996;background:rgba(0,0,0,.72);backdrop-filter:blur(3px);display:none;animation:fadeIn .3s ease;}
.tour-card{
  position:fixed;z-index:99997;
  background:rgba(255,255,255,.9);backdrop-filter:blur(24px);
  border:2px solid var(--accent);
  border-radius:16px;padding:22px 24px;width:340px;max-width:90vw;
  box-shadow:0 20px 60px rgba(0,0,0,.3);
  animation:tourIn .35s cubic-bezier(.22,1,.36,1) both;
}
[data-theme=dark] .tour-card{background:rgba(26,29,40,.95);}
@keyframes tourIn{from{opacity:0;transform:scale(.94) translateY(8px)}to{opacity:1;transform:none}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.tour-dots{display:flex;gap:4px;margin-bottom:10px;}
.td{width:6px;height:6px;border-radius:50%;background:var(--border);transition:all .3s;}
.td.a{background:var(--accent);width:18px;border-radius:3px;}
.tour-step-lbl{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;}
.tour-ttl{font-family:'Nunito',sans-serif;font-weight:900;font-size:17px;margin-bottom:8px;}
body.lang-ta .tour-ttl{font-family:'Noto Sans Tamil','Nunito',sans-serif;font-size:15px;line-height:1.4;}
.tour-body{font-size:13px;color:var(--muted);line-height:1.65;margin-bottom:18px;}
body.lang-ta .tour-body{font-family:'Noto Sans Tamil',sans-serif;font-size:12px;line-height:1.8;}
.tour-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
.t-prev{padding:7px 14px;border:1.5px solid var(--border);border-radius:7px;background:transparent;color:var(--muted);font-family:'Nunito',sans-serif;font-weight:700;cursor:pointer;transition:all .18s;}
.t-prev:hover{border-color:var(--accent);color:var(--accent);}
.t-next{padding:7px 16px;border:none;border-radius:7px;background:var(--accent);color:var(--bg);font-family:'Nunito',sans-serif;font-weight:900;cursor:pointer;transition:all .18s;}
.t-next:hover{transform:translateY(-1px);box-shadow:0 4px 12px var(--shadow);}
.t-skip{margin-left:auto;cursor:pointer;color:var(--muted);font-size:13px;white-space:nowrap;}
.t-skip:hover{color:var(--red);}

/* ── TOAST ── */
#toast{
  position:fixed;bottom:18px;right:18px;z-index:99998;
  background:rgba(255,255,255,.9);backdrop-filter:blur(20px);
  border:1px solid rgba(255,255,255,.8);border-radius:12px;
  padding:12px 16px;box-shadow:0 8px 28px var(--shadow);
  display:flex;align-items:center;gap:9px;font-size:13px;max-width:300px;
  transform:translateX(110%);transition:transform .35s cubic-bezier(.22,1,.36,1);
}
[data-theme=dark] #toast{background:rgba(26,29,40,.95);border-color:rgba(255,255,255,.07);}
#toast.show{transform:translateX(0);}

/* ── PAGE TRANSITION ANIMATION ── */
@keyframes pageSlideIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.page.active{animation:pageSlideIn .3s ease both;}

/* ── SHIMMER ANIMATION (for loading states) ── */
@keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
.shimmer{background:linear-gradient(90deg,var(--surface) 25%,var(--card) 50%,var(--surface) 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;}

/* ── SCROLLBAR GLOBAL ── */
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px;}
::-webkit-scrollbar-thumb:hover{background:var(--muted);}
/* ══ v5+ ADDITIONS: OFFLINE / VOICE / LANDMARKS / EXPORT ══ */
.offline-badge{
  position:fixed;top:10px;left:16px;z-index:99995;
  padding:8px 14px;border-radius:999px;
  background:rgba(229,57,53,.12);border:1px solid rgba(229,57,53,.35);
  color:var(--red);font-size:11px;font-weight:800;letter-spacing:.2px;
  display:none;align-items:center;gap:8px;backdrop-filter:blur(16px);
}
.offline-badge.show{display:flex;}
.offline-dot{width:8px;height:8px;border-radius:50%;background:var(--red);animation:blink 1s infinite;}

.traffic-alert{
  position:fixed;top:70px;right:16px;z-index:99994;
  background:linear-gradient(135deg,#ff6b6b,#e53935);color:white;
  padding:12px 14px;border-radius:12px;font-family:'Nunito',sans-serif;font-weight:900;
  box-shadow:0 10px 28px rgba(229,57,53,.35);
  animation:slideIn .25s cubic-bezier(.22,1,.36,1) both;
  max-width:min(360px,86vw);
}
@keyframes slideIn{from{transform:translateX(420px);opacity:0}to{transform:none;opacity:1}}
.traffic-alert .alert-close{margin-left:10px;cursor:pointer;font-size:18px;opacity:.9;}

.voice-indicator{
  position:fixed;bottom:22px;right:22px;z-index:99993;
  width:64px;height:64px;border-radius:50%;
  background:var(--accent);color:var(--bg);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;transition:transform .15s,opacity .2s,background .2s;
  box-shadow:0 10px 30px var(--shadow);
  font-size:24px;opacity:.92;pointer-events:auto;touch-action:manipulation;-webkit-tap-highlight-color:rgba(0,0,0,0);
}
.voice-indicator.active{pointer-events:auto;opacity:1;}
.voice-indicator.listening{opacity:1;background:var(--green);animation:pulseRing .55s infinite;}
@keyframes pulseRing{0%{box-shadow:0 0 0 0 rgba(34,199,122,.45),0 10px 30px var(--shadow)}70%{box-shadow:0 0 0 14px rgba(34,199,122,0),0 10px 30px var(--shadow)}100%{box-shadow:0 0 0 0 rgba(34,199,122,0),0 10px 30px var(--shadow)}}

.ai-assistant-panel{
  position:fixed;bottom:92px;right:22px;z-index:99993;
  width:min(360px,92vw);max-height:56vh;
  background:rgba(255,255,255,.9);backdrop-filter:blur(18px);
  border-radius:18px;border:1px solid rgba(255,255,255,.85);
  box-shadow:0 18px 50px var(--shadow);
  display:none;flex-direction:column;overflow:hidden;
}
/* when the assistant is shown as a full page we move the same panel into the page and override positioning */
#assistant .ai-assistant-panel{
  position:relative !important;
  bottom:auto !important;
  right:auto !important;
  width:100% !important;
  max-height:none !important;
  height:100%;
  border-radius:0 !important;
  box-shadow:none !important;
}
[data-theme=dark] .ai-assistant-panel{
  background:rgba(20,23,32,.94);border-color:rgba(255,255,255,.08);
}
.ai-assistant-header{
  padding:10px 14px;border-bottom:1px solid rgba(0,0,0,.06);
  display:flex;align-items:center;justify-content:space-between;
  font-family:'Nunito',sans-serif;font-weight:900;font-size:13px;color:var(--accent);
}
[data-theme=dark] .ai-assistant-header{border-bottom-color:rgba(255,255,255,.06);}
.ai-assistant-sub{
  font-size:11px;color:var(--muted);font-weight:600;
}
.ai-chat-log{
  flex:1;overflow-y:auto;padding:10px 12px;display:flex;flex-direction:column;gap:6px;
  font-size:12px;
}
.ai-msg{
  padding:7px 10px;border-radius:11px;max-width:92%;line-height:1.4;
  font-weight:600;
}
.ai-msg.user{
  margin-left:auto;
  background:linear-gradient(135deg,var(--accent),#ffb347);color:var(--bg);
}
.ai-msg.bot{
  margin-right:auto;
  background:rgba(240,245,255,.95);color:var(--text);
}
[data-theme=dark] .ai-msg.bot{
  background:rgba(255,255,255,.06);
}
.ai-input-row{
  padding:8px 10px;border-top:1px solid rgba(0,0,0,.06);
  display:flex;align-items:center;gap:6px;
}
[data-theme=dark] .ai-input-row{border-top-color:rgba(255,255,255,.08);}
.ai-input{
  flex:1;border-radius:999px;border:1px solid var(--border);
  padding:8px 11px;font-size:12px;background:rgba(255,255,255,.96);
}
[data-theme=dark] .ai-input{
  background:rgba(10,12,20,.96);color:var(--text);border-color:rgba(255,255,255,.12);
}
.ai-mic-btn,.ai-send-btn{
  width:44px;height:44px;min-width:44px;min-height:44px;border-radius:50%;border:none;cursor:pointer;
  display:flex;align-items:center;justify-content:center;padding:6px;
  background:var(--accent);color:var(--bg);font-size:17px;
  box-shadow:0 6px 18px var(--shadow);transition:transform .12s,box-shadow .12s,background .12s;
  flex-shrink:0;touch-action:manipulation;-webkit-tap-highlight-color:rgba(0,0,0,0);
}
.ai-send-btn{background:var(--blue);}
.ai-mic-btn.listening{background:var(--green);animation:pulseRing .55s infinite;}
.ai-mic-btn:hover,.ai-send-btn:hover{transform:translateY(-1px);box-shadow:0 8px 22px var(--shadow);}


.landmark-input{
  padding:9px 12px;border:1.5px dashed rgba(34,199,122,.55);border-radius:9px;width:100%;
  background:rgba(34,199,122,.06);color:var(--text);font-size:12px;
  outline:none;transition:border-color .2s,background .2s;
}
.landmark-input:focus{border-color:var(--green);background:rgba(34,199,122,.1);}
.landmark-badge{
  display:inline-flex;align-items:center;gap:7px;padding:6px 12px;border-radius:999px;
  background:rgba(34,199,122,.12);border:1px solid rgba(34,199,122,.28);
  color:var(--green);font-size:11px;font-weight:800;margin-top:8px;
}

.map-btn.export-btn{background:rgba(34,199,122,.12);border-color:rgba(34,199,122,.32);color:var(--green);}
.map-btn.export-btn:hover{background:rgba(34,199,122,.18);border-color:rgba(34,199,122,.42);color:var(--green);}
.map-btn.warn-btn{background:rgba(240,220,80,.15);border-color:rgba(240,220,80,.5);color:var(--accent);}
.map-btn.warn-btn:hover{background:rgba(240,220,80,.24);border-color:rgba(240,220,80,.62);}
</style>
</head>
<body>
<script>
(function(){
  function updateDeviceClass(){
    var isMobile = /Mobi|Android|iPhone|iPad|iPod|Windows Phone/i.test(navigator.userAgent) || window.innerWidth <= 800;
    document.documentElement.classList.toggle('mobile', isMobile);
    document.documentElement.classList.toggle('desktop', !isMobile);
    document.body.classList.toggle('mobile', isMobile);
    document.body.classList.toggle('desktop', !isMobile);
  }
  window.addEventListener('load', updateDeviceClass);
  window.addEventListener('resize', updateDeviceClass);
})();
</script>

<!-- ══ LANGUAGE SELECTOR ══ -->
<div id="lang-overlay">
  <div class="lang-box" style="position:relative;">
    <button class="icon-btn" id="lang-theme-btn" onclick="toggleTheme()" style="position:absolute;top:16px;right:16px;">☀️</button>
    <div class="lang-truck-row">
      <svg class="lang-truck-svg" viewBox="0 0 120 100" fill="none">
        <rect x="8" y="34" width="68" height="44" rx="6" stroke="var(--accent)" stroke-width="5" fill="none"/>
        <path d="M76 48 L98 48 L108 64 L108 78 L76 78 Z" stroke="var(--accent)" stroke-width="5" fill="none" stroke-linejoin="round"/>
        <circle cx="28" cy="84" r="8" stroke="var(--accent)" stroke-width="5" fill="none"/>
        <circle cx="86" cy="84" r="8" stroke="var(--accent)" stroke-width="5" fill="none"/>
        <circle cx="43" cy="18" r="11" stroke="var(--accent)" stroke-width="4.5" fill="none"/>
        <path d="M43 28 Q30 40 43 40 Q56 40 43 28Z" fill="var(--accent)" opacity=".55"/>
      </svg>
    </div>
    <div class="lang-brand">RouteX</div>
    <div class="lang-welcome">Welcome! Please choose your language.</div>
    <div class="lang-welcome-ta">வரவேற்கிறோம்! உங்கள் மொழியை தேர்ந்தெடுக்கவும்.</div>
    <div class="lang-divider"><span>Select Language / மொழி தேர்வு</span></div>
    <div class="lang-cards">
      <div class="lang-card" id="lang-en-card" onclick="selectLang('en')">
        <span class="lang-flag">🇬🇧</span>
        <span class="lang-name">English</span>
        <span class="lang-native">English</span>
      </div>
      <div class="lang-card" id="lang-ta-card" onclick="selectLang('ta')">
        <span class="lang-flag">🇮🇳</span>
        <span class="lang-name">தமிழ்</span>
        <span class="lang-native lang-native-ta">Tamil</span>
      </div>
    </div>
    <button class="lang-confirm-btn" id="lang-confirm-btn" onclick="confirmLang()">Continue →</button>
  </div>
</div>

<!-- ══ OFFLINE BADGE ══ -->
<div class="offline-badge" id="offline-badge">
  <div class="offline-dot"></div>
  <span id="offline-text">Offline Mode</span>
</div>

<!-- ── AUTH ── -->
<div id="auth-overlay" style="display:none">
  <div class="auth-box">
    <div class="auth-logo-row">
      <svg class="auth-truck-svg" viewBox="0 0 120 100" fill="none">
        <rect x="8" y="34" width="68" height="44" rx="6" stroke="var(--accent)" stroke-width="5" fill="none"/>
        <path d="M76 48 L98 48 L108 64 L108 78 L76 78 Z" stroke="var(--accent)" stroke-width="5" fill="none" stroke-linejoin="round"/>
        <circle cx="28" cy="84" r="8" stroke="var(--accent)" stroke-width="5" fill="none"/>
        <circle cx="86" cy="84" r="8" stroke="var(--accent)" stroke-width="5" fill="none"/>
        <circle cx="43" cy="18" r="11" stroke="var(--accent)" stroke-width="4.5" fill="none"/>
        <path d="M43 28 Q30 40 43 40 Q56 40 43 28Z" fill="var(--accent)" opacity=".55"/>
      </svg>
      <div class="auth-brand">RouteX</div>
    </div>
    <div class="auth-tag" data-i18n="tagline">Drive Easy, Delivery Happy</div>

        <!-- dark/light mode toggle on login portal -->
        <button class="icon-btn" id="login-theme-btn" onclick="toggleTheme()"
          style="position:absolute;top:16px;right:16px;font-size:18px;">☀️</button>

    <div id="login-screen">
      <div class="tab-row">
        <!-- mobile-only login, email removed -->
        <button class="atab on" id="tab-phone" onclick="switchTab('phone')" data-i18n="tab-phone">Mobile</button>
      </div>
      <div id="auth-err" class="auth-err"></div>
      <!-- email field removed, using phone only -->
      <div class="auth-field" id="phone-field">
        <label data-i18n="label-phone">Mobile Number</label>
        <input type="tel" id="inp-phone" data-i18n-ph="ph-phone" placeholder="+91 XXXXX XXXXX" autocomplete="tel">
      </div>
      <button class="auth-btn" onclick="sendOTP()"><span data-i18n="send-otp">Send OTP →</span></button>
    </div>

    <div id="otp-screen" style="display:none">
      <div class="otp-wrap">
        <div class="otp-hint" id="otp-hint"></div>
        <div class="otp-row">
          <input class="otp-box" id="o1" maxlength="1" type="tel" oninput="otpNext(this,'o2')" onkeydown="otpBack(event,this,'')">
          <input class="otp-box" id="o2" maxlength="1" type="tel" oninput="otpNext(this,'o3')" onkeydown="otpBack(event,this,'o1')">
          <input class="otp-box" id="o3" maxlength="1" type="tel" oninput="otpNext(this,'o4')" onkeydown="otpBack(event,this,'o2')">
          <input class="otp-box" id="o4" maxlength="1" type="tel" oninput="otpNext(this,'')"  onkeydown="otpBack(event,this,'o3')">
        </div>
      </div>
      <div id="auth-err2" class="auth-err"></div>
      <button class="auth-btn" onclick="verifyOTP()"><span data-i18n="verify-enter">Verify & Enter →</span></button>
      <div class="resend-row"><span data-i18n="didnt-get">Didn't get it?</span> <span class="resend-btn" onclick="resendOTP()" data-i18n="resend-otp">Resend OTP</span></div>
      <span class="auth-back" onclick="backToLogin()" data-i18n="change-contact">← Change mobile number</span>
    </div>
  </div>
</div>

<!-- ── NAV (hidden until login) ── -->
<nav id="main-nav" style="display:none">
  <a class="logo" onclick="showPage('home')">
    <svg class="logo-svg" viewBox="0 0 120 100" fill="none">
      <rect x="8" y="34" width="68" height="44" rx="6" stroke="var(--accent)" stroke-width="5" fill="none"/>
      <path d="M76 48 L98 48 L108 64 L108 78 L76 78 Z" stroke="var(--accent)" stroke-width="5" fill="none" stroke-linejoin="round"/>
      <circle cx="28" cy="84" r="8" stroke="var(--accent)" stroke-width="5" fill="none"/>
      <circle cx="86" cy="84" r="8" stroke="var(--accent)" stroke-width="5" fill="none"/>
      <circle cx="43" cy="18" r="11" stroke="var(--accent)" stroke-width="4.5" fill="none"/>
      <path d="M43 28 Q30 40 43 40 Q56 40 43 28Z" fill="var(--accent)" opacity=".55"/>
    </svg>
    <span class="logo-txt">RouteX</span>
  </a>
  <div class="nav-tabs">
    <button class="nav-tab active" id="tab-home" onclick="showPage('home')" data-i18n="nav-home">Home</button>
    <button class="nav-tab" id="tab-dashboard" onclick="showPage('dashboard')" data-i18n="nav-dashboard">Dashboard</button>
    <button class="nav-tab" id="tab-optimizer" onclick="showPage('optimizer')" data-i18n="nav-optimizer">Optimizer</button>
    <button class="nav-tab" id="tab-assistant" onclick="showPage('assistant')" data-i18n="nav-assistant">Assistant</button>
  </div>
  <div class="nav-right">
    <div class="geo-badge" id="geo-badge"><div class="geo-dot"></div><span id="geo-lbl" data-i18n="locating">Locating…</span></div>
    <button class="icon-btn" id="theme-btn" onclick="toggleTheme()">☀️</button>
    <button class="lang-btn" id="lang-switch-btn" onclick="switchLang()">🌐 தமிழ்</button>
    <button class="icon-btn avatar-btn" id="user-av" onclick="doLogout()">?</button>
    <button class="icon-btn help-fab" onclick="startTour()">?</button>
    <button class="icon-btn mobile-menu-btn" onclick="toggleSidebar()">☰</button>
  </div>
</nav>

<!-- ── HOME ── -->
<div id="home" class="page active" style="display:none">
  <div class="hero">
    <div class="hero-pattern"></div>
    <div class="orb orb1"></div><div class="orb orb2"></div><div class="orb orb3"></div>
    <div class="hero-logo-area">
      <svg class="hero-truck" viewBox="0 0 120 100" fill="none">
        <rect x="8" y="34" width="68" height="44" rx="6" stroke="var(--accent)" stroke-width="5" fill="none"/>
        <path d="M76 48 L98 48 L108 64 L108 78 L76 78 Z" stroke="var(--accent)" stroke-width="5" fill="none" stroke-linejoin="round"/>
        <circle cx="28" cy="84" r="8" stroke="var(--accent)" stroke-width="5" fill="none"/>
        <circle cx="86" cy="84" r="8" stroke="var(--accent)" stroke-width="5" fill="none"/>
        <circle cx="43" cy="18" r="11" stroke="var(--accent)" stroke-width="4.5" fill="none"/>
        <path d="M43 28 Q30 40 43 40 Q56 40 43 28Z" fill="var(--accent)" opacity=".55"/>
      </svg>
      <div class="hero-brand">RouteX</div>
    </div>
    <div class="hero-tagline" data-i18n="hero-tagline">Drive Easy, Delivery Happy</div>
    <p class="hero-sub" data-i18n="hero-sub">Intelligently plan, optimize, and continuously adapt urban delivery routes in real-time — reducing fuel, improving punctuality, scaling capacity.</p>
    <div class="hero-btns">
      <button class="btn-primary" onclick="showPage('dashboard')"><span data-i18n="btn-live-dash">Live Dashboard →</span></button>
      <button class="btn-outline" onclick="showPage('optimizer')"><span data-i18n="btn-optimizer">Run Optimizer</span></button>
    </div>
  </div>
  <div class="stats-row">
    <div class="stat-cell"><span class="stat-n" data-target="25">0%</span><span class="stat-l" data-i18n="stat-faster">Faster Deliveries</span></div>
    <div class="stat-cell"><span class="stat-n" data-target="22">0%</span><span class="stat-l" data-i18n="stat-distance">Less Distance</span></div>
    <div class="stat-cell"><span class="stat-n" data-target="20">0%</span><span class="stat-l" data-i18n="stat-fuel">Fuel Saved</span></div>
  </div>
  <div class="feat-grid">
    <div class="feat-card">
      <div class="feat-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><path d="M12 2a10 10 0 1 0 10 10"/><polyline points="12 6 12 12 16 14"/></svg></div>
      <div class="feat-title" data-i18n="feat1-title">Real-Time Re-Optimization</div>
      <div class="feat-desc" data-i18n="feat1-desc">Routes auto-recalculate live when traffic changes, orders arrive, or delays happen.</div>
    </div>
    <div class="feat-card">
      <div class="feat-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--blue)" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg></div>
      <div class="feat-title" data-i18n="feat2-title">Delay Prediction Engine</div>
      <div class="feat-desc" data-i18n="feat2-desc">Predicts late deliveries and reroutes nearby drivers to protect time-window orders.</div>
    </div>
    <div class="feat-card">
      <div class="feat-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg></div>
      <div class="feat-title" data-i18n="feat3-title">Smart Load Balancing</div>
      <div class="feat-desc" data-i18n="feat3-desc">Auto-redistributes orders when one driver is overloaded, maximizing daily capacity.</div>
    </div>
    <div class="feat-card">
      <div class="feat-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--blue)" stroke-width="2"><polygon points="3 11 22 2 13 21 11 13 3 11"/></svg></div>
      <div class="feat-title" data-i18n="feat4-title">Micro-Zone Intelligence</div>
      <div class="feat-desc" data-i18n="feat4-desc">City divided into smart zones — two-wheelers in congested lanes, vans in bulk corridors.</div>
    </div>
    <div class="feat-card">
      <div class="feat-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--red)" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
      <div class="feat-title" data-i18n="feat5-title">Time-Window Priority</div>
      <div class="feat-desc" data-i18n="feat5-desc">Automatically prioritizes urgent deliveries and reshuffles sequences when delays occur.</div>
    </div>
    <div class="feat-card">
      <div class="feat-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg></div>
      <div class="feat-title" data-i18n="feat6-title">Auto KPI Engine</div>
      <div class="feat-desc" data-i18n="feat6-desc">Real-time on-time rate, fuel efficiency, orders per driver — with savings per optimization.</div>
    </div>
  </div>
  <div class="footer">© Copyright 2026 · Created by Sanjay Sridhar Sivapugalvan · RouteX Delivery Intelligence</div>
</div>

<!-- ── DASHBOARD ── -->
<div id="dashboard" class="page" style="display:none">
  <div id="mobile-overlay" onclick="closeSidebar()"></div>
  <div class="sidebar">
    <div class="sidebar-hdr">
      <button class="icon-btn mobile-close-btn" onclick="closeSidebar()" style="margin-right:8px">×</button>
      <div>
        <div class="sidebar-title" data-i18n="fleet-overview">Fleet Overview</div>
        <div class="sidebar-sub" id="dash-time">Loading…</div>
      </div>
      <button class="add-btn" onclick="openModal()"><span data-i18n="add-order-btn">+ Add Order</span></button>
    </div>
    <div class="kpi-strip">
      <div class="kpi"><div class="kpi-lbl" data-i18n="kpi-ontime">On-Time</div><div class="kpi-val kv-y" id="kpi-ot">–</div><div class="kpi-sub" data-i18n="kpi-rate">rate</div></div>
      <div class="kpi"><div class="kpi-lbl" data-i18n="kpi-active">Active</div><div class="kpi-val kv-g" id="kpi-ac">0</div><div class="kpi-sub" data-i18n="kpi-enroute">en route</div></div>
      <div class="kpi"><div class="kpi-lbl" data-i18n="kpi-delayed">Delayed</div><div class="kpi-val kv-r" id="kpi-dl">0</div><div class="kpi-sub" data-i18n="kpi-pastdl">past deadline</div></div>
      <div class="kpi"><div class="kpi-lbl" data-i18n="kpi-pending">Pending</div><div class="kpi-val kv-b" id="kpi-pd">0</div><div class="kpi-sub" data-i18n="kpi-waiting">waiting</div></div>
      <div class="kpi"><div class="kpi-lbl" data-i18n="kpi-fuel">Fuel Saved</div><div class="kpi-val kv-g" id="kpi-fuel">0%</div><div class="kpi-sub" data-i18n="kpi-fromeco">from Eco</div></div>
      <div class="kpi"><div class="kpi-lbl" data-i18n="kpi-co2">CO₂ Prevented</div><div class="kpi-val kv-g" id="kpi-co2">0g</div><div class="kpi-sub" data-i18n="kpi-today">today</div></div>
    </div>
    <div class="alert-bar" id="alert-bar" style="display:none">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--red)" stroke-width="2" style="flex-shrink:0;margin-top:1px"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
      <span id="alert-text"></span>
      <span class="alert-close" onclick="this.closest('.alert-bar').style.display='none'">✕</span>
    </div>
    <div class="del-scroll" id="del-list">
      <div class="empty-dash">
        <svg width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
        <p class="empty-title" data-i18n="no-orders">No orders yet</p>
        <p style="font-size:12px" data-i18n="no-orders-sub">Click "+ Add Order" to begin</p>
      </div>
    </div>
  </div>
  <div class="map-wrap">
    <div id="dash-map"></div>
    <div class="map-ctrls">
      <button class="map-btn live-on" id="btn-track" onclick="toggleTracking()">
        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg><span data-i18n="tracking-on">Tracking ON</span>
      </button>
      <button class="map-btn" onclick="centerUser()">
        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="3 11 22 2 13 21 11 13 3 11"/></svg><span data-i18n="my-location">My Location</span>
      </button>
      <button class="map-btn" id="dash-sat-btn" onclick="toggleSatellite('dash')">🛰 <span data-i18n="btn-satellite">Satellite</span></button>
      <button class="map-btn" onclick="fitAll()">
        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="3"/></svg><span data-i18n="fit-all">Fit All</span>
      </button>
      <button class="map-btn" onclick="doSimulate()">
        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg><span data-i18n="simulate">Simulate</span>
      </button>
      <button class="map-btn warn-btn" onclick="toggleLandmarks()" title="Landmark Layer">🌳 Landmarks</button>
      <button class="map-btn export-btn" onclick="exportPDF()" title="Export Logistics Report">📄 Export PDF</button>
    </div>
    <div class="map-chips">
      <div class="chip"><div class="dot" style="background:var(--green)"></div><span data-i18n="chip-gps">GPS</span></div>
      <div class="chip"><div class="dot" style="background:var(--accent)"></div><span data-i18n="chip-van">Van</span></div>
      <div class="chip"><div class="dot" style="background:var(--blue)"></div><span data-i18n="chip-bike">Bike</span></div>
      <div class="chip"><div class="dot" style="background:var(--red)"></div><span data-i18n="chip-delayed">Delayed</span></div>
      <div class="chip lm-chip" id="lm-chip" style="display:none">🌳 Landmark layer</div>
    </div>
  </div>
</div>

<!-- ── ADD ORDER MODAL ── -->
<div id="add-modal" class="modal-bg" style="display:none" onclick="bgClose(event)">
  <div class="modal">
    <div class="modal-ttl">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
      <span data-i18n="modal-title">Add Delivery Order</span>
    </div>
    <div class="form-row">
      <div class="finp-wrap">
        <span class="finp-lbl" data-i18n="label-orderid">Order ID (auto)</span>
        <input class="finp" id="m-id" readonly style="opacity:.6">
      </div>
      <div class="finp-wrap">
        <span class="finp-lbl" data-i18n="label-product">Product / Item</span>
        <input class="finp" id="m-product" data-i18n-ph="ph-product" placeholder="What's being delivered?">
      </div>
    </div>
    <div class="finp-wrap" style="margin-bottom:10px">
      <span class="finp-lbl" data-i18n="label-delloc">Delivery Location</span>
    </div>
    <div class="loc-choice-row">
      <div class="loc-choice sel" id="lc-search" onclick="setLocMode('search')">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline;margin-right:4px"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><span data-i18n="loc-search">Search Address</span>
      </div>
      <div class="loc-choice" id="lc-map" onclick="setLocMode('map')">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline;margin-right:4px"><polygon points="3 11 22 2 13 21 11 13 3 11"/></svg><span data-i18n="loc-map">Click on Map</span>
      </div>
    </div>
    <div id="mode-search">
      <div class="geocoder-wrap">
        <svg class="geocoder-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input class="geocoder-input" id="gc-modal" data-i18n-ph="ph-geocoder" placeholder="Type address, area, or landmark…" oninput="geocodeSearch(this.value,'gc-modal-list','modal')" autocomplete="off">
        <div class="geocoder-list" id="gc-modal-list"></div>
      </div>
    </div>
    <div id="mode-map" style="display:none">
      <div class="map-pick-hint" id="map-pick-hint" style="display:flex">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="3 11 22 2 13 21 11 13 3 11"/></svg>
        <span data-i18n="map-pick-hint">Click anywhere on the map below to pin the delivery location</span>
      </div>
      <div class="map-pick-mini" id="modal-mini-map" style="display:block"></div>
    </div>
    <div class="coord-display" id="coord-display">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="10" r="3"/><path d="M12 21.7C17.3 17 20 13 20 10a8 8 0 1 0-16 0c0 3 2.7 6.9 8 11.7z"/></svg>
      <span id="coord-text" data-i18n="no-location">No location set</span>
      <span id="addr-display" style="flex:1;font-weight:600;color:var(--text)"></span>
    </div>
    <div class="finp-wrap" style="margin-top:10px">
      <span class="finp-lbl" data-i18n="label-landmark">Local Landmark (optional)</span>
      <input class="landmark-input" id="m-landmark" data-i18n-ph="ph-landmark" placeholder="e.g., Opposite big Banyan tree">
      <div class="landmark-badge" data-i18n="landmark-badge">🌳 Landmark Layer active — improves last-50m accuracy</div>
    </div>
    <div class="form-row" style="margin-top:8px">
      <div class="finp-wrap">
        <span class="finp-lbl" data-i18n="label-deadline">Deadline Time</span>
        <input class="finp" id="m-deadline" type="time">
      </div>
      <div class="finp-wrap">
        <span class="finp-lbl" data-i18n="label-vehicle">Vehicle</span>
        <select class="finp fsel" id="m-vehicle">
          <option value="van" data-i18n="opt-van">Van</option>
          <option value="bike" data-i18n="opt-bike">Two-Wheeler</option>
        </select>
      </div>
    </div>
    <input type="hidden" id="m-lat">
    <input type="hidden" id="m-lng">
    <input type="hidden" id="m-addr">
    <div class="modal-btns">
      <button class="mbtn-cancel" onclick="closeModal()"><span data-i18n="btn-cancel">Cancel</span></button>
      <button class="mbtn-save" onclick="saveOrder()"><span data-i18n="btn-save">Save Order →</span></button>
    </div>
  </div>
</div>

<!-- ── AI ASSISTANT PAGE ── -->
<div id="assistant" class="page" style="display:none">
  <!-- the panel will be moved here when the page is active -->
</div>

<!-- ── OPTIMIZER ── -->
<div id="optimizer" class="page" style="display:none">
  <div class="opt-side">
    <div class="opt-ttl" data-i18n="opt-title">Route Optimizer</div>
    <div class="opt-sub" data-i18n="opt-sub">Add orders, choose settings → get the smartest route</div>
    <div class="ai-route-badge">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2z"/><path d="M12 8v4l3 3"/></svg>
      <span data-i18n="ai-badge">Smart routing via OSRM + live traffic awareness</span>
    </div>
    <div class="order-box">
      <div class="order-box-ttl">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
        <span data-i18n="del-orders">Delivery Orders</span>
      </div>
      <div class="order-scroll" id="opt-order-list">
        <div class="opt-no-orders" data-i18n="no-opt-orders">No orders yet. Add below or from Dashboard.</div>
      </div>
      <div class="add-ord-form">
        <div class="add-ord-ttl" data-i18n="add-opt-title">Add Order to Optimizer</div>
        <div class="opt-geocoder-wrap">
          <svg class="opt-gc-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          <input class="opt-gc-input" id="opt-gc" data-i18n-ph="ph-opt-gc" placeholder="Search delivery address…" oninput="geocodeSearch(this.value,'opt-gc-list','opt')" autocomplete="off">
          <div class="opt-gc-list" id="opt-gc-list"></div>
        </div>
        <div class="map-click-hint">
          <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="3 11 22 2 13 21 11 13 3 11"/></svg>
          <span data-i18n="map-click-hint">Or click anywhere on the map to set location</span>
        </div>
        <div id="opt-coord-display" style="display:none;font-size:11px;color:var(--green);padding:5px 0;font-weight:700"></div>
        <div class="opt-inp-row" style="margin-top:8px">
          <input class="opt-inp" id="opt-product" data-i18n-ph="ph-product-opt" placeholder="Product name">
          <input class="opt-inp" id="opt-deadline" type="time" title="Deadline">
          <button class="opt-add-btn" onclick="addOptOrder()"><span data-i18n="btn-add">Add</span></button>
        </div>
        <div style="margin-top:8px">
          <input class="opt-inp" id="opt-landmark" data-i18n-ph="ph-opt-landmark" placeholder="Landmark (optional)">
        </div>
        <input type="hidden" id="opt-sel-lat">
        <input type="hidden" id="opt-sel-lng">
        <input type="hidden" id="opt-sel-addr">
      </div>
    </div>
    <div class="section-block">
      <span class="sec-lbl" data-i18n="lbl-vtype">Vehicle Type</span>
      <select class="form-select" id="sv-vtype">
        <option value="mixed" data-i18n="opt-mixed">Mixed Fleet</option>
        <option value="van" data-i18n="opt-vans">Vans Only</option>
        <option value="bike" data-i18n="opt-bikes">Two-Wheelers Only</option>
      </select>
    </div>
    <div class="section-block">
      <span class="sec-lbl" data-i18n="lbl-capacity">Vehicle Capacity (kg)</span>
      <div class="slider-row">
        <input type="range" class="slider" id="sv-cap-range" min="20" max="500" value="150" step="10"
          oninput="document.getElementById('sv-cap').textContent=this.value+'kg'">
        <span class="slv" id="sv-cap">150kg</span>
      </div>
    </div>
    <div class="section-block">
      <span class="sec-lbl" data-i18n="lbl-priority">Optimization Priority</span>
      <div class="tgl-row">
        <button class="tgl on" onclick="pickTgl(this)" data-i18n="tgl-fastest">Fastest</button>
        <button class="tgl" onclick="pickTgl(this)" data-i18n="tgl-shortest">Shortest</button>
        <button class="tgl" onclick="pickTgl(this)" data-i18n="tgl-eco">Eco</button>
      </div>
    </div>
    <div class="section-block">
      <span class="sec-lbl" data-i18n="lbl-startpt">Start Point</span>
      <div class="tgl-row">
        <button class="tgl on" id="tgl-mypos" onclick="pickTgl(this)" data-i18n="tgl-mygps">My GPS</button>
        <button class="tgl" id="tgl-hub" onclick="pickTgl(this)" data-i18n="tgl-hub">Salem Hub</button>
      </div>
    </div>
    <button class="run-btn" id="run-btn" onclick="runOptimizer()">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
      <span id="run-lbl" data-i18n="btn-generate">Generate Smart Route</span>
      <div class="spin" id="run-spin"></div>
    </button>
  </div>
  <div class="opt-map-area">
    <div id="opt-map"></div>
    <div class="map-ctrls" id="opt-map-ctrls" style="left:auto;right:12px;top:12px">
      <button class="map-btn" id="opt-sat-btn" onclick="toggleSatellite('opt')">🛰 <span data-i18n="btn-satellite">Satellite</span></button>
    </div>
    <div class="route-results">
      <div class="results-top">
        <span class="res-lbl" id="res-lbl" data-i18n="res-configure">Configure orders → Generate Routes</span>
        <span style="font-size:11px;color:var(--muted)" id="res-sub"></span>
      </div>
      <div id="res-kpis" style="display:none" class="res-kpis">
        <div class="r-kpi"><div class="r-kv" id="rk-dist">–</div><div class="r-kl" data-i18n="rkl-dist">Total km</div></div>
        <div class="r-kpi"><div class="r-kv" id="rk-time">–</div><div class="r-kl" data-i18n="rkl-time">Est. time</div></div>
        <div class="r-kpi"><div class="r-kv" id="rk-fuel">–</div><div class="r-kl" data-i18n="rkl-fuel">Fuel saved</div></div>
        <div class="r-kpi"><div class="r-kv" id="rk-ot">–</div><div class="r-kl" data-i18n="rkl-ot">On-time est.</div></div>
      </div>
      <div class="stops-row" id="res-stops"></div>
    </div>
  </div>
</div>

<!-- ── TOUR ── -->
<div id="tour-bg"></div>
<div class="tour-card" id="tour-card" style="display:none"></div>

<!-- ── TOAST ── -->
<div id="toast">
  <span id="toast-ic">✅</span>
  <span id="toast-tx"></span>
</div>

<!-- ══ AI ASSISTANT ══ -->
<div class="voice-indicator" id="ai-assistant-toggle" onclick="toggleAiAssistant()" title="AI Delivery Assistant">🤖</div>
<div class="ai-assistant-panel" id="ai-assistant-panel" aria-hidden="true">
  <div class="ai-assistant-header">
    <span>AI Delivery Assistant</span>
    <span class="ai-assistant-sub" id="ai-assistant-status">Voice + Chat · EN / தமிழ்</span>
  </div>
  <div class="ai-chat-log" id="ai-chat-log"></div>
  <div class="ai-input-row">
    <button class="ai-mic-btn" id="ai-mic-btn" type="button" title="Speak to assistant" onclick="aiStartVoice()">🎤</button>
    <input class="ai-input" id="ai-text-input" type="text"
      placeholder="Describe an order or ask about ETA…" autocomplete="off"
      onkeydown="if(event.key==='Enter'){sendAiText();}">
    <button class="ai-send-btn" type="button" onclick="sendAiText()" title="Send message">➤</button>
  </div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
<script>
// ══ LANGUAGE SYSTEM ══
let currentLang = 'en';
let selectedLangTemp = null;

const T = {
  en: {
    'tagline':'Drive Easy, Delivery Happy',
    'tab-phone':'Mobile',
    'label-phone':'Mobile Number',
    'ph-phone':'+91 XXXXX XXXXX',
    'send-otp':'Send OTP →','verify-enter':'Verify & Enter →',
    'didnt-get':"Didn't get it?",'resend-otp':'Resend OTP',
    'change-contact':'← Change mobile number',
    'nav-home':'Home','nav-dashboard':'Dashboard','nav-optimizer':'Optimizer','nav-assistant':'Assistant',
    'locating':'Locating…',
    'hero-tagline':'Drive Easy, Delivery Happy',
    'hero-sub':'Intelligently plan, optimize, and continuously adapt urban delivery routes in real-time — reducing fuel, improving punctuality, scaling capacity.',
    'btn-live-dash':'Live Dashboard →','btn-optimizer':'Run Optimizer',
    'stat-faster':'Faster Deliveries','stat-distance':'Less Distance','stat-fuel':'Fuel Saved',
    'feat1-title':'Real-Time Re-Optimization',
    'feat1-desc':'Routes auto-recalculate live when traffic changes, orders arrive, or delays happen.',
    'feat2-title':'Delay Prediction Engine',
    'feat2-desc':'Predicts late deliveries and reroutes nearby drivers to protect time-window orders.',
    'feat3-title':'Smart Load Balancing',
    'feat3-desc':'Auto-redistributes orders when one driver is overloaded, maximizing daily capacity.',
    'feat4-title':'Micro-Zone Intelligence',
    'feat4-desc':'City divided into smart zones — two-wheelers in congested lanes, vans in bulk corridors.',
    'feat5-title':'Time-Window Priority',
    'feat5-desc':'Automatically prioritizes urgent deliveries and reshuffles sequences when delays occur.',
    'feat6-title':'Auto KPI Engine',
    'feat6-desc':'Real-time on-time rate, fuel efficiency, orders per driver — with savings per optimization.',
    'fleet-overview':'Fleet Overview','add-order-btn':'+ Add Order',
    'kpi-ontime':'On-Time','kpi-active':'Active','kpi-delayed':'Delayed','kpi-pending':'Pending',
    'kpi-rate':'rate','kpi-enroute':'en route','kpi-pastdl':'past deadline','kpi-waiting':'waiting',
    'kpi-fuel':'Fuel Saved','kpi-co2':'CO₂ Prevented','kpi-fromeco':'from Eco','kpi-today':'today',
    'no-orders':'No orders yet','no-orders-sub':'Click "+ Add Order" to begin',
    'tracking-on':'Tracking ON','tracking-off':'Tracking OFF',
    'my-location':'My Location','fit-all':'Fit All','simulate':'Simulate',
    'btn-satellite':'Satellite',
    'chip-gps':'GPS','chip-van':'Van','chip-bike':'Bike','chip-delayed':'Delayed',
    'modal-title':'Add Delivery Order',
    'label-orderid':'Order ID (auto)','label-product':'Product / Item',
    'ph-product':"What's being delivered?",'label-delloc':'Delivery Location',
    'loc-search':'Search Address','loc-map':'Click on Map',
    'ph-geocoder':'Type address, area, or landmark…',
    'map-pick-hint':'Click anywhere on the map below to pin the delivery location',
    'no-location':'No location set',
    'label-landmark':'Local Landmark (optional)',
    'ph-landmark':'e.g., Opposite big Banyan tree',
    'landmark-badge':'🌳 Landmark Layer active — improves last-50m accuracy',
    'label-deadline':'Deadline Time','label-vehicle':'Vehicle',
    'opt-van':'Van','opt-bike':'Two-Wheeler',
    'btn-cancel':'Cancel','btn-save':'Save Order →',
    'opt-title':'Route Optimizer',
    'opt-sub':'Add orders, choose settings → get the smartest route',
    'ai-badge':'Smart routing via OSRM + live traffic awareness',
    'del-orders':'Delivery Orders',
    'no-opt-orders':'No orders yet. Add below or from Dashboard.',
    'add-opt-title':'Add Order to Optimizer',
    'ph-opt-gc':'Search delivery address…','map-click-hint':'Or click anywhere on the map to set location',
    'ph-product-opt':'Product name','btn-add':'Add',
    'ph-opt-landmark':'Landmark (optional)',
    'lbl-vtype':'Vehicle Type','opt-mixed':'Mixed Fleet','opt-vans':'Vans Only','opt-bikes':'Two-Wheelers Only',
    'lbl-capacity':'Vehicle Capacity (kg)','lbl-priority':'Optimization Priority',
    'tgl-fastest':'Fastest','tgl-shortest':'Shortest','tgl-eco':'Eco',
    'lbl-startpt':'Start Point','tgl-mygps':'My GPS','tgl-hub':'Salem Hub',
    'btn-generate':'Generate Smart Route','res-configure':'Configure orders → Generate Routes',
    'rkl-dist':'Total km','rkl-time':'Est. time','rkl-fuel':'Fuel saved','rkl-ot':'On-time est.',
        'lang-switch-label':'🌐 தமிழ்',
  },
  ta: {
    'tagline':'எளிதாக ஓட்டு, மகிழ்ச்சியாக டெலிவரி',
    'tab-phone':'மொபைல்',
    'label-phone':'மொபைல் எண்',
    'ph-phone':'+91 XXXXX XXXXX',
    'send-otp':'OTP அனுப்பு →','verify-enter':'சரிபார்த்து உள்ளே →',
    'didnt-get':'கிடைக்கவில்லையா?','resend-otp':'OTP மீண்டும் அனுப்பு',
    'change-contact':'← மொபைல் எண் மாற்று',
    'nav-home':'முகப்பு','nav-dashboard':'கட்டுப்பாடு','nav-optimizer':'திட்டமிடல்','nav-assistant':'உதவி',
    'locating':'கண்டறிகிறது…',
    'hero-tagline':'எளிதாக ஓட்டு, மகிழ்ச்சியாக டெலிவரி',
    'hero-sub':'நகர்ப்புற டெலிவரி பாதைகளை திட்டமிட்டு, மேம்படுத்தி, நிகழ்நேரத்தில் தகவமைக்கவும் — எரிபொருள் குறைக்கவும், நேர்மை மேம்படுத்தவும்.',
    'btn-live-dash':'நேரடி கட்டுப்பாடு →','btn-optimizer':'திட்டமிடல் இயக்கு',
    'stat-faster':'வேகமான டெலிவரி','stat-distance':'குறைந்த தூரம்','stat-fuel':'எரிபொருள் சேமிப்பு',
    'feat1-title':'நிகழ்நேர மறு-திட்டமிடல்',
    'feat1-desc':'போக்குவரத்து மாறும்போது, ஆர்டர்கள் வரும்போது அல்லது தாமதம் ஏற்படும்போது பாதைகள் தானாக மறு கணக்கீடு செய்யும்.',
    'feat2-title':'தாமத முன்னறிவிப்பு இயந்திரம்',
    'feat2-desc':'தாமத டெலிவரிகளை முன்கூட்டியே கண்டறிந்து, அருகிலுள்ள ஓட்டுநர்களை திரும்ப திசை திருப்பும்.',
    'feat3-title':'திறமையான சுமை சமநிலை',
    'feat3-desc':'ஒரு ஓட்டுநர் அதிக சுமையாக இருக்கும்போது ஆர்டர்களை தானாக மறுவிநியோகிக்கும், அதிகபட்ச தினசரி திறனை அதிகரிக்கும்.',
    'feat4-title':'நுண் மண்டல அறிவு',
    'feat4-desc':'நகரை திறமையான மண்டலங்களாகப் பிரிக்கும் — நெரிசல் பாதைகளில் இரு சக்கரங்கள், பெரிய பகுதிகளில் வேன்கள்.',
    'feat5-title':'நேர-சாளர முன்னுரிமை',
    'feat5-desc':'அவசர டெலிவரிகளுக்கு தானாக முன்னுரிமை அளிக்கும் மற்றும் தாமதம் ஏற்படும்போது வரிசையை மாற்றும்.',
    'feat6-title':'தானியங்கி KPI இயந்திரம்',
    'feat6-desc':'நிகழ்நேர நேர-வீதம், எரிபொருள் திறன், ஓட்டுநர் ஒன்றுக்கு ஆர்டர்கள் — ஒவ்வொரு மேம்படுத்தலிலும் சேமிப்புடன்.',
    'fleet-overview':'வாகன கண்ணோட்டம்','add-order-btn':'+ ஆர்டர் சேர்',
    'kpi-ontime':'நேரத்தில்','kpi-active':'செயலில்','kpi-delayed':'தாமதம்','kpi-pending':'நிலுவை',
    'kpi-rate':'வீதம்','kpi-enroute':'பயணத்தில்','kpi-pastdl':'கெடு தாண்டியது','kpi-waiting':'காத்திருக்கிறது',
    'kpi-fuel':'எரிபொருள் சேமிப்பு','kpi-co2':'CO₂ குறைப்பு','kpi-fromeco':'சேமிப்பு முறையில்','kpi-today':'இன்று',
    'no-orders':'ஆர்டர்கள் இல்லை','no-orders-sub':'"+ ஆர்டர் சேர்" கிளிக் செய்யுங்கள்',
    'tracking-on':'கண்காணிப்பு ஆன்','tracking-off':'கண்காணிப்பு ஆஃப்',
    'my-location':'என் இடம்','fit-all':'அனைத்தும் பொருத்து','simulate':'உருவகம்',
    'btn-satellite':'செயற்கைக்கோள்','btn-street':'தெரு காட்சி',
    'chip-gps':'GPS','chip-van':'வேன்','chip-bike':'பைக்','chip-delayed':'தாமதம்',
    'modal-title':'டெலிவரி ஆர்டர் சேர்',
    'label-orderid':'ஆர்டர் ID (தானியங்கி)','label-product':'பொருள் / வகை',
    'ph-product':'என்ன டெலிவரி செய்யப்படுகிறது?','label-delloc':'டெலிவரி இடம்',
    'loc-search':'முகவரி தேடு','loc-map':'வரைபடத்தில் கிளிக்',
    'ph-geocoder':'முகவரி, பகுதி அல்லது அடையாளம் தட்டச்சு செய்யுங்கள்…',
    'map-pick-hint':'டெலிவரி இடத்தை பின் செய்ய கீழே உள்ள வரைபடத்தில் கிளிக் செய்யுங்கள்',
    'no-location':'இடம் அமைக்கப்படவில்லை',
    'label-landmark':'உள்ளூர் அடையாளம் (விருப்பம்)',
    'ph-landmark':'உதா., பெரிய ஆலமரம் எதிரில்',
    'landmark-badge':'🌳 அடையாளம் அடுக்கு செயல்பாட்டில் — கடைசி 50மீ துல்லியம் மேம்படும்',
    'label-deadline':'கடைசி நேரம்','label-vehicle':'வாகனம்',
    'opt-van':'வேன்','opt-bike':'இரு சக்கர வாகனம்',
    'btn-cancel':'ரத்து செய்','btn-save':'ஆர்டர் சேமி →',
    'opt-title':'பாதை திட்டமிடல்',
    'opt-sub':'ஆர்டர்கள் சேர்க்கவும், அமைப்புகளை தேர்ந்தெடுக்கவும் → சிறந்த பாதை பெறுங்கள்',
    'ai-badge':'OSRM மூலம் திறமையான பாதைகள் + நேரடி போக்குவரத்து அறிவு',
    'del-orders':'டெலிவரி ஆர்டர்கள்',
    'no-opt-orders':'ஆர்டர்கள் இல்லை. கீழே அல்லது கட்டுப்பாட்டிலிருந்து சேர்க்கவும்.',
    'add-opt-title':'திட்டமிடலுக்கு ஆர்டர் சேர்',
    'ph-opt-gc':'டெலிவரி முகவரி தேடு…','map-click-hint':'இடத்தை அமைக்க வரைபடத்தில் எங்கும் கிளிக் செய்யுங்கள்',
    'ph-product-opt':'பொருளின் பெயர்','btn-add':'சேர்',
    'ph-opt-landmark':'அடையாளம் (விருப்பம்)',
    'lbl-vtype':'வாகன வகை','opt-mixed':'கலப்பு வாகனங்கள்','opt-vans':'வேன்கள் மட்டும்','opt-bikes':'இரு சக்கரங்கள் மட்டும்',
    'lbl-capacity':'வாகன திறன் (கிலோ)','lbl-priority':'மேம்படுத்தல் முன்னுரிமை',
    'tgl-fastest':'வேகமான','tgl-shortest':'குறுகிய','tgl-eco':'சேமிப்பு',
    'lbl-startpt':'தொடக்க புள்ளி','tgl-mygps':'என் GPS','tgl-hub':'சேலம் மையம்',
    'btn-generate':'திறமையான பாதை உருவாக்கு','res-configure':'ஆர்டர்களை அமைக்கவும் → பாதைகளை உருவாக்கவும்',
    'rkl-dist':'மொத்த கி.மீ','rkl-time':'மதிப்பிடப்பட்ட நேரம்','rkl-fuel':'எரிபொருள் சேமிப்பு','rkl-ot':'நேர மதிப்பீடு',
        'street-hint':'குறிப்பு: வரைபடத்தில் ஒரு இடத்தை கிளிக் செய்து பின்னர் “தெரு காட்சி” திறக்கவும்',
    'lang-switch-label':'🌐 English',
  }
};

// Tour in both languages
const TOUR_EN = [
  {title:'Welcome to RouteX! 👋',body:"RouteX is a smart delivery management app. It helps plan the best routes for drivers, track orders in real-time, and alert you when deliveries are late. Let's explore together!",page:'home',pos:{top:'50%',left:'50%',transform:'translate(-50%,-50%)'}},
  {title:'The Home Page',body:"This page shows what RouteX can do — 25% faster deliveries, less distance, less fuel! The big numbers count up to show the improvement over regular delivery planning.",page:'home',pos:{top:'130px',left:'50%',transform:'translateX(-50%)'}},
  {title:'Dashboard — Your Control Room',body:"The Dashboard is where you manage all deliveries. You can see every order on a live map, check if they're on time or late, and add new orders by clicking the \"+Add Order\" button.",page:'dashboard',pos:{top:'80px',right:'20px'}},
  {title:'Adding an Order',body:"Click \"+Add Order\". Enter the product being delivered. Choose how to set the location — either search for an address (like Google Maps!) or click directly on the mini-map. Set the deadline time too!",page:'dashboard',pos:{top:'80px',left:'20px'}},
  {title:'Order Status Colors',body:"Green = En Route (on time). Red = Delayed (past deadline). Blue = Pending (waiting). The app auto-detects status based on the clock — no manual updates needed!",page:'dashboard',pos:{top:'280px',left:'20px'}},
  {title:'The Optimizer ⚡',body:"The Optimizer plans the best route for all your deliveries. It automatically sorts stops by deadline — most urgent first — so no order gets missed!",page:'optimizer',pos:{top:'80px',right:'20px'}},
  {title:'Adding Stops to Optimizer',body:"Type an address in the search bar (autocomplete shows suggestions just like Google Maps!). Or click anywhere on the map to pick a location. Then click \"Add\" to add it to the route.",page:'optimizer',pos:{top:'120px',left:'370px'}},
  {title:'Generating the Route',body:"Click \"Generate Smart Route\" — the app connects to real road data (OSRM) and calculates the actual driving path, estimating time with a 25% traffic buffer for realism.",page:'optimizer',pos:{top:'50%',right:'20px',transform:'translateY(-50%)'}},
  {title:'Chat with AI 🤖',body:'Use the new Assistant tab to talk or type commands like "hi", "how many orders", or "order details". Voice input shows live text. Works offline via keywords.',page:'assistant',pos:{top:'50%',left:'50%',transform:'translate(-50%,-50%)'}},
  {title:'Traffic & Alerts',body:'Routes now predict red lights, road blocks, and diversions. The line turns red if a red signal is ahead and alerts show details.',page:'dashboard',pos:{top:'50%',left:'60%',transform:'translateX(-50%)'}},
  {title:"You're Ready! 🎉",body:"That's everything! Add orders from Dashboard → sync to Optimizer → generate the best route. The ? button in the top-right always brings back this tour. Drive Easy, Delivery Happy!",page:'home',pos:{top:'50%',left:'50%',transform:'translate(-50%,-50%)'}}
];

const TOUR_TA = [
  {title:'RouteX-க்கு வரவேற்கிறோம்! 👋',body:"RouteX ஒரு திறமையான டெலிவரி நிர்வாக பயன்பாடு. இது ஓட்டுநர்களுக்கு சிறந்த பாதைகளை திட்டமிட, ஆர்டர்களை நிகழ்நேரத்தில் கண்காணிக்க மற்றும் டெலிவரி தாமதமாகும்போது உங்களை எச்சரிக்க உதவுகிறது.",page:'home',pos:{top:'50%',left:'50%',transform:'translate(-50%,-50%)'}},
  {title:'முகப்பு பக்கம்',body:"இந்த பக்கம் RouteX என்ன செய்யலாம் என்று காட்டுகிறது — 25% வேகமான டெலிவரி, குறைந்த தூரம், குறைந்த எரிபொருள்! பெரிய எண்கள் வழக்கமான திட்டமிடலை விட மேம்பாட்டை காட்டுகின்றன.",page:'home',pos:{top:'130px',left:'50%',transform:'translateX(-50%)'}},
  {title:'கட்டுப்பாடு — உங்கள் கட்டுப்பாட்டு அறை',body:"கட்டுப்பாட்டு பகுதியில் நீங்கள் அனைத்து டெலிவரிகளையும் நிர்வகிக்கலாம். நேரடி வரைபடத்தில் ஒவ்வொரு ஆர்டரையும் பார்க்கலாம், நேரத்தில் இருக்கிறதா அல்லது தாமதமாகிறதா என்று சரிபார்க்கலாம்.",page:'dashboard',pos:{top:'80px',right:'20px'}},
  {title:'ஆர்டர் சேர்ப்பது',body:"\"+ ஆர்டர் சேர்\" கிளிக் செய்யுங்கள். டெலிவரி செய்யப்படும் பொருளை உள்ளிடவும். இடத்தை அமைக்க — முகவரி தேடுதல் அல்லது நேரடி வரைபடத்தில் கிளிக் செய்வது — இரண்டு முறைகளில் ஒன்றை தேர்ந்தெடுக்கவும். கடைசி நேரத்தையும் அமைக்கவும்!",page:'dashboard',pos:{top:'80px',left:'20px'}},
  {title:'ஆர்டர் நிலை வண்ணங்கள்',body:"பச்சை = பயணத்தில் (நேரத்தில்). சிவப்பு = தாமதம் (கடைசி நேரம் தாண்டியது). நீலம் = நிலுவையில் (காத்திருக்கிறது). பயன்பாடு கடிகாரத்தின் அடிப்படையில் நிலையை தானாக கண்டறிகிறது!",page:'dashboard',pos:{top:'280px',left:'20px'}},
  {title:'திட்டமிடல் ⚡',body:"திட்டமிடல் உங்கள் அனைத்து டெலிவரிகளுக்கும் சிறந்த பாதையை திட்டமிடுகிறது. இது கடைசி நேரத்தின் அடிப்படையில் நிறுத்தங்களை தானாக வரிசைப்படுத்துகிறது — மிக அவசரமானது முதலில்!",page:'optimizer',pos:{top:'80px',right:'20px'}},
  {title:'திட்டமிடலில் நிறுத்தங்கள் சேர்ப்பது',body:"தேடல் பட்டியில் ஒரு முகவரியை தட்டச்சு செய்யுங்கள் (தானியங்கி நிரப்புதல் பரிந்துரைகளை காட்டும்!). அல்லது இடத்தை தேர்வு செய்ய வரைபடத்தில் எங்கும் கிளிக் செய்யுங்கள். பிறகு \"சேர்\" கிளிக் செய்யுங்கள்.",page:'optimizer',pos:{top:'120px',left:'370px'}},
  {title:'பாதை உருவாக்குவது',body:"\"திறமையான பாதை உருவாக்கு\" கிளிக் செய்யுங்கள் — பயன்பாடு உண்மையான சாலை தரவுகளுடன் இணைக்கப்பட்டு உண்மையான ஓட்டுதல் பாதையை கணக்கிடுகிறது, யதார்த்தத்திற்காக 25% போக்குவரத்து இடையூறு சேர்க்கிறது.",page:'optimizer',pos:{top:'50%',right:'20px',transform:'translateY(-50%)'}},
  {title:'சாட்🤖',body:'Assistant தாவலைத் திறந்து "hi", "எத்தனை ஆர்டர்கள்" போன்ற வார்த்தைகளை பேசலாம் அல்லது টাইப் செய்யலாம். குரல் உள்ளீடு நேரடியாக மெய்ப்பாக எழுதப்படும்.',page:'assistant',pos:{top:'50%',left:'50%',transform:'translate(-50%,-50%)'}},
  {title:' போக்குவரத்து & எச்சரிக்கைகள்',body:'பாதைகள் இப்போது சிவப்பு விளக்கு, சாலை தடைகள் மற்றும் மாற்ற வழிகளை கணிக்கின்றன. சிவப்பு விளக்கு முன்னால் இருந்தால் பாதை சிவப்பாக மாறும் மற்றும் எச்சரிக்கைகள் காட்டப்படும்.',page:'dashboard',pos:{top:'50%',left:'60%',transform:'translateX(-50%)'}},
  {title:'நீங்கள் தயார்! 🎉',body:"அவ்வளவுதான்! கட்டுப்பாட்டிலிருந்து ஆர்டர்கள் சேர்க்கவும் → திட்டமிடலுடன் ஒத்திசைக்கவும் → சிறந்த பாதையை உருவாக்கவும். மேல் வலதில் உள்ள ? பொத்தான் எப்போதும் இந்த சுற்றுப்பயணத்தை மீண்டும் காட்டும்.",page:'home',pos:{top:'50%',left:'50%',transform:'translate(-50%,-50%)'}}
];

function getTour(){ return currentLang==='ta'?TOUR_TA:TOUR_EN; }

function selectLang(lang) {
  selectedLangTemp = lang;
  document.querySelectorAll('.lang-card').forEach(c=>c.classList.remove('selected'));
  document.getElementById('lang-'+(lang)+'-card').classList.add('selected');
  const btn = document.getElementById('lang-confirm-btn');
  btn.textContent = lang==='ta'?'தொடரவும் →':'Continue →';
  btn.classList.add('visible');
}

function confirmLang() {
  if(!selectedLangTemp) return;
  currentLang = selectedLangTemp;
  const overlay = document.getElementById('lang-overlay');
  overlay.style.opacity='0';
  overlay.style.pointerEvents='none';
  setTimeout(()=>{
    overlay.style.display='none';
    document.getElementById('auth-overlay').style.display='flex';
    applyLang();
  },500);
}

function applyLang() {
  const lang = currentLang;
  const map = T[lang];
  // Body class for font switching
  document.body.classList.toggle('lang-ta', lang==='ta');
  // Apply text content
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key = el.getAttribute('data-i18n');
    if(map[key]) el.textContent = map[key];
  });
  // Apply placeholders
  document.querySelectorAll('[data-i18n-ph]').forEach(el=>{
    const key = el.getAttribute('data-i18n-ph');
    if(map[key]) el.placeholder = map[key];
  });
  // Apply select option text
  document.querySelectorAll('option[data-i18n]').forEach(el=>{
    const key = el.getAttribute('data-i18n');
    if(map[key]) el.textContent = map[key];
  });
  // Language switch button
  const lsb = document.getElementById('lang-switch-btn');
  if(lsb) lsb.textContent = map['lang-switch-label'] || (lang==='ta'?'🌐 English':'🌐 தமிழ்');
  // Update run-lbl if not in progress
  const runLbl = document.getElementById('run-lbl');
  if(runLbl && runLbl.textContent !== (T.en['planning']||'Planning route…') && !document.getElementById('run-btn').disabled) {
    runLbl.textContent = map['btn-generate'];
  }
  // Tracking button
  const btnTrack = document.getElementById('btn-track');
  if(btnTrack){
    const span = btnTrack.querySelector('span[data-i18n]');
    if(span) span.textContent = trackOn ? map['tracking-on'] : map['tracking-off'];
  }
  // Re-render dynamic lists with new language
  if(ORDERS.length) renderList();
  if(optOrders.length) renderOptList();
}

function switchLang() {
  currentLang = currentLang==='en'?'ta':'en';
  applyLang();
  const langName = currentLang==='ta'?'தமிழ்':'English';
  toast('🌐', currentLang==='ta'?'மொழி தமிழ் ஆக மாற்றப்பட்டது!':'Language changed to English!');
}

// ══ GLOBAL STATE ══
let uLat=11.6643,uLng=78.1460,uMarker=null,trackOn=true,simTmr=null,simIdx=0;
let dashMap=null,optMap=null,dashInit=false,optInit=false;
let dashMarkers=[],dashRouteCtrl=[];
let optRouteCtrl=null,optMapMarkers=[];
let isDark=false;
let ORDERS=[];
let optOrders=[];
let orderCounter=1;
let pendingOTP=null,authMode='phone',currentUser=null;
let miniMap=null,miniMapMarker=null;
let locMode='search';
let optPendingLat=null,optPendingLng=null,optPendingAddr=null;
let optClickMode=false;
const HUB={lat:11.6643,lng:78.1460,name:'RouteX Hub, Salem'};
const DCOLS=['#3a4757','#22c77a','#2d7ff9','#9b59b6','#e67e22','#e53935'];
// AI backend configuration removed: using offline keyword responder only
// (previous DuckDuckGo/proxy code removed to allow opening via file://)

// ══ v5+ STATE (Landmarks / Offline / Eco / Voice / Route Cache) ══
let LANDMARKS=[]; // {id,lat,lng,text,ts}
let lmLayer=null,lmOn=true;
let ecoAgg={fuelSavedPct:0,co2PreventedG:0,lastPriority:'fastest',ts:0};
let dashRouteLine=null,dashRoutePts=[];
let optRouteLine=null,optStopLayer=null,optLastPlan=null; // optLastPlan: {stops,priority,route,alts}
let aiVoiceRec=null;
let navSteps=[],navStepIdx=0;
let mapBases={dash:null,opt:null,mini:null}; // {osm,sat,active}
let lastMapClick={dash:null,opt:null,mini:null}; // LatLng
let streetPoint=null; // {lat,lng}

// placeholder for legacy street-point tracking – no longer used
function setStreetPoint(latlng){ /* intentionally empty */ }

const STORE_KEY='routex_store_v6';

// ----- traffic & block prediction (simple offline simulation) -----
// sample signals with time cycles in hours (0-24)
const TRAFFIC_SIGNALS=[
  {lat:11.6645,lng:78.1465,cycles:[{from:0,to:7,colour:'green'},{from:7,to:9,colour:'red'},{from:9,to:17,colour:'green'},{from:17,to:19,colour:'red'},{from:19,to:24,colour:'green'}]},
  // add more signals as needed
];
const ROAD_BLOCKS=[
  {lat:11.6650,lng:78.1470,description:'Construction work - expect slow traffic',detour:'Use 2nd Street via East Road'},
  // add more road‑block entries if desired
];

function getCurrentSignalColor(sig){
  const h=new Date().getHours();
  for(const c of sig.cycles){
    if(h>=c.from && h<c.to) return c.colour;
  }
  return 'green';
}
function geoDist(a,b){ // approximate planar distance in degrees
  const dx=a[0]-b.lat;
  const dy=a[1]-b.lng;
  return Math.sqrt(dx*dx+dy*dy);
}
function analyzeRouteTraffic(coords){
  let foundSignal=false;
  const alerts=[];
  coords.forEach(pt=>{
    TRAFFIC_SIGNALS.forEach(sig=>{
      const d=geoDist(pt,sig);
      if(d<0.001){ // ~100m
        const col=getCurrentSignalColor(sig);
        if(col==='red'){
          foundSignal=true;
          alerts.push(`Red light ahead near ${sig.lat.toFixed(4)},${sig.lng.toFixed(4)}`);
        }
      }
    });
    ROAD_BLOCKS.forEach(blk=>{
      const d=geoDist(pt,blk);
      if(d<0.001){
        alerts.push(`Block: ${blk.description}. Detour: ${blk.detour}`);
      }
    });
  });
  return {state: foundSignal?'signal':'clear', alerts};
}

function showRouteAlerts(list){
  let el=document.getElementById('route-alerts');
  if(!el){
    el=document.createElement('div');
    el.id='route-alerts';
    el.className='route-alerts';
    document.body.appendChild(el);
  }
  if(!list.length){el.style.display='none';return;} 
  el.style.display='block';
  el.innerHTML=list.map(a=>`<div>${escHtml(a)}</div>`).join('');
}

// -----------------------------------------------------------------

function safeJsonParse(s,fallback){try{return JSON.parse(s);}catch{return fallback;}}
function escHtml(s){return String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}

function deg2rad(x){return x*Math.PI/180;}
function bearingBetween(a,b){
  const lat1=deg2rad(a[0]),lon1=deg2rad(a[1]);
  const lat2=deg2rad(b[0]),lon2=deg2rad(b[1]);
  const dLon=lon2-lon1;
  const y=Math.sin(dLon)*Math.cos(lat2);
  const x=Math.cos(lat1)*Math.sin(lat2)-Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLon);
  const brng=Math.atan2(y,x)*180/Math.PI;
  return (brng+360)%360;
}

function haversineMeters(a,b){
  const R=6371000;
  const dLat=deg2rad(b[0]-a[0]);
  const dLon=deg2rad(b[1]-a[1]);
  const lat1=deg2rad(a[0]);
  const lat2=deg2rad(b[0]);
  const sinDLat=Math.sin(dLat/2);
  const sinDLon=Math.sin(dLon/2);
  const h=sinDLat*sinDLat+Math.cos(lat1)*Math.cos(lat2)*sinDLon*sinDLon;
  const c=2*Math.atan2(Math.sqrt(h),Math.sqrt(1-h));
  return R*c;
}

function buildNavSteps(points){
  const out=[];
  if(!points || points.length<3) return out;
  let prevBearing=bearingBetween(points[0],points[1]);
  let distAccum=0;
  for(let i=1;i<points.length-1;i++){
    const cur=points[i],next=points[i+1];
    const b=bearingBetween(cur,next);
    const diff=((b-prevBearing+540)%360)-180; // -180..180
    const seg=haversionSafe(cur,next);
    distAccum+=seg;
    if(Math.abs(diff)>=35){
      const dir=diff>0?'right':'left';
      const metersAhead=Math.max(80,distAccum);
      const km=metersAhead/1000;
      // compute a more precise spoken distance rather than vague "few" so TTS remains smooth
      let enDist;
      if(km>0.6){
        enDist=`${km.toFixed(1)} kilometers`;
      } else if(metersAhead>900){
        enDist=`${Math.round(metersAhead/100)*100} meters`;
      } else {
        enDist=`${Math.round(metersAhead)} meters`;
      }
      const en=`In ${enDist}, turn ${dir}.`;
      let taDist;
      if(km>0.6){
        taDist=`${km.toFixed(1)} கிலோமீட்டரில்`;
      } else if(metersAhead>900){
        taDist=`${Math.round(metersAhead/100)*100} மீட்டரில்`;
      } else {
        taDist=`${Math.round(metersAhead)} மீட்டரில்`;
      }
      const ta=dir==='right'
        ? `${taDist} வலது பக்கம் திரும்புங்கள்.`
        : `${taDist} இடது பக்கம் திரும்புங்கள்.`;
      out.push({i,en,ta});
      distAccum=0;
      prevBearing=b;
    }
  }
  return out;
}

function haversionSafe(a,b){
  try{return haversineMeters(a,b);}catch{return 0;}
}
function storeLoad(){
  const d=safeJsonParse(localStorage.getItem(STORE_KEY),null);
  if(!d)return;
  if(Array.isArray(d.orders)) ORDERS=d.orders;
  if(Array.isArray(d.landmarks)) LANDMARKS=d.landmarks;
  if(d.ecoAgg) ecoAgg={...ecoAgg,...d.ecoAgg};
  if(d.theme==='dark'){isDark=true;document.documentElement.setAttribute('data-theme','dark');}
}
function storeSave(){
  try{
    localStorage.setItem(STORE_KEY,JSON.stringify({v:6,orders:ORDERS,landmarks:LANDMARKS,ecoAgg,theme:isDark?'dark':''}));
  }catch{}
}

function setOfflineBadge(show){
  const b=document.getElementById('offline-badge');
  if(!b)return;
  b.classList.toggle('show',!!show);
}

window.addEventListener('online',()=>{setOfflineBadge(false);toast('✅',currentLang==='ta'?'இணையம் மீண்டும் உள்ளது':'Back online');});
window.addEventListener('offline',()=>{setOfflineBadge(true);toast('📴',currentLang==='ta'?'ஆஃப்லைன் முறையில் இயங்குகிறது':'Working offline');});

// ══ THEME ══
function updateRoadMaps(){
  const url = isDark ? darkRoadUrl : lightRoadUrl;
  for(const key in mapBases){
    const b = mapBases[key];
    if(b && b.osm){
      try{ b.osm.setUrl(url); }catch{};
    }
  }
}

function toggleTheme(){
  isDark=!isDark;
  document.documentElement.setAttribute('data-theme',isDark?'dark':'');
  document.getElementById('theme-btn').textContent=isDark?'🌙':'☀️';
  // update any other toggles that may exist
  const lt=document.getElementById('login-theme-btn');
  if(lt) lt.textContent=isDark?'🌙':'☀️';
  const l2=document.getElementById('lang-theme-btn');
  if(l2) l2.textContent=isDark?'🌙':'☀️';
  // update browser theme color meta tag
  const m=document.querySelector('meta[name="theme-color"]');
  if(m) m.setAttribute('content', isDark?'#0d0f15':'#ffffff');
  // adjust road tile layers for maps
  updateRoadMaps();
  storeSave();
}

// ══ AUTH ══
let authTab='phone'; // only mobile login now
// switching removed since we only support phone
function switchTab(m){
  authTab='phone';
  document.getElementById('phone-field').style.display='block';
}


function showAuthErr(el,msg){
  const e=document.getElementById(el);
  e.textContent=msg;e.style.display='block';
  setTimeout(()=>e.style.display='none',4000);
}

function sendOTP(){
  const val=document.getElementById('inp-phone').value.trim();
  const errMsg = currentLang==='ta'
    ? 'மொபைல் எண் உள்ளிடவும்'
    : 'Please enter your mobile number';
  if(!val){showAuthErr('auth-err',errMsg);return;}
  // simple numeric check
  if(!/^\+?\d+$/.test(val)){showAuthErr('auth-err',currentLang==='ta'?'சரியான மொபைல் எண் உள்ளிடவும்':'Please enter a valid mobile number');return;}
  pendingOTP=String(Math.floor(1000+Math.random()*9000));
  currentUser=val;
  document.getElementById('login-screen').style.display='none';
  document.getElementById('otp-screen').style.display='block';
  const sentMsg = currentLang==='ta' ? val+'-க்கு 4 இலக்க OTP அனுப்பப்பட்டது' : 'We sent a 4-digit OTP to '+val;
  document.getElementById('otp-hint').textContent=sentMsg;
  // attempt to open SMS draft on mobile devices
  try{
    const uri = `sms:${val}?body=${encodeURIComponent('Your OTP is '+pendingOTP)}`;
    window.location.href = uri;
  }catch(e){ }
  document.getElementById('o1').focus();
}

function resendOTP(){
  pendingOTP=String(Math.floor(1000+Math.random()*9000));
  // open new SMS draft with updated code
  try{
    const uri = `sms:${currentUser}?body=${encodeURIComponent('Your OTP is '+pendingOTP)}`;
    window.location.href = uri;
  }catch(e){}
  toast('📨',currentLang==='ta'?'புதிய OTP உருவாக்கப்பட்டது':'New OTP generated',4000);
  ['o1','o2','o3','o4'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('o1').focus();
}

function otpNext(el,nextId){
  el.classList.toggle('filled',el.value.length===1);
  if(el.value.length===1&&nextId)document.getElementById(nextId).focus();
}
function otpBack(e,el,prevId){
  if(e.key==='Backspace'&&!el.value&&prevId)document.getElementById(prevId).focus();
}

function verifyOTP(){
  const entered=['o1','o2','o3','o4'].map(id=>document.getElementById(id).value).join('');
  if(entered.length<4){showAuthErr('auth-err2',currentLang==='ta'?'4 இலக்கங்களை உள்ளிடவும்':'Enter all 4 digits');return;}
  if(entered!==pendingOTP){showAuthErr('auth-err2',currentLang==='ta'?'தவறான OTP. மீண்டும் முயற்சிக்கவும்.':'Incorrect OTP. Try again or resend.');return;}
  const ov=document.getElementById('auth-overlay');
  ov.style.opacity='0';
  setTimeout(()=>{
    ov.style.display='none';
    document.getElementById('main-nav').style.display='flex';
    document.querySelectorAll('.page').forEach(p=>p.style.display='');
    document.getElementById('home').classList.add('active');
    document.getElementById('user-av').textContent=currentUser.substring(0,2).toUpperCase();
    startGeo();
    setTimeout(animCounters,400);
  },400);
}

function backToLogin(){
  document.getElementById('otp-screen').style.display='none';
  document.getElementById('login-screen').style.display='block';
  document.getElementById('auth-err').style.display='none';
  document.getElementById('auth-err2').style.display='none';
  ['o1','o2','o3','o4'].forEach(id=>{ const el=document.getElementById(id); el.value='';el.classList.remove('filled'); });
}

function doLogout(){
  const msg = currentLang==='ta' ? 'RouteX-இலிருந்து வெளியேற விரும்புகிறீர்களா?' : 'Logout from RouteX?';
  if(!confirm(msg))return;
  document.getElementById('auth-overlay').style.opacity='1';
  document.getElementById('auth-overlay').style.display='flex';
  document.getElementById('main-nav').style.display='none';
  document.querySelectorAll('.page').forEach(p=>p.style.display='none');
  backToLogin();
  document.getElementById('inp-phone').value='';
}

// ══ GEOCODING ══
let geocodeTimer=null;
function geocodeSearch(val,listId,ctx){
  clearTimeout(geocodeTimer);
  const list=document.getElementById(listId);
  if(!val||val.length<3){list.style.display='none';return;}
  geocodeTimer=setTimeout(async()=>{
    try{
      const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(val)}&countrycodes=in&limit=6&addressdetails=1`,{headers:{'Accept-Language':'en'}});
      const data=await r.json();
      if(!data.length){list.style.display='none';return;}
      list.innerHTML=data.map(d=>{
        const main=d.display_name.split(',').slice(0,2).join(', ');
        const sub=d.display_name.split(',').slice(2,4).join(', ');
        return `<div class="${ctx==='opt'?'opt-gc-item':'geocoder-item'}" onclick="selectGeoResult('${d.lat}','${d.lon}','${d.display_name.replace(/'/g,'`')}','${ctx}')">
          <div class="${ctx==='opt'?'':'geocoder-item-main'}">${main}</div>
          ${ctx!=='opt'?`<div class="geocoder-item-sub">${sub}</div>`:''}
        </div>`;
      }).join('');
      list.style.display='block';
    }catch(e){list.style.display='none';}
  },320);
}

function selectGeoResult(lat,lng,addr,ctx){
  if(ctx==='modal'){
    document.getElementById('m-lat').value=lat;
    document.getElementById('m-lng').value=lng;
    document.getElementById('m-addr').value=addr;
    document.getElementById('gc-modal').value=addr.split(',').slice(0,2).join(', ');
    document.getElementById('gc-modal-list').style.display='none';
    document.getElementById('coord-display').classList.add('shown');
    document.getElementById('coord-text').textContent=`${parseFloat(lat).toFixed(4)}, ${parseFloat(lng).toFixed(4)}`;
    document.getElementById('addr-display').textContent=addr.split(',').slice(0,2).join(', ');
    if(miniMap){miniMap.setView([lat,lng],15);if(miniMapMarker)miniMap.removeLayer(miniMapMarker);miniMapMarker=L.marker([lat,lng]).addTo(miniMap);}
  } else if(ctx==='opt'){
    document.getElementById('opt-sel-lat').value=lat;
    document.getElementById('opt-sel-lng').value=lng;
    document.getElementById('opt-sel-addr').value=addr;
    document.getElementById('opt-gc').value=addr.split(',').slice(0,2).join(', ');
    document.getElementById('opt-gc-list').style.display='none';
    document.getElementById('opt-coord-display').style.display='block';
    document.getElementById('opt-coord-display').textContent='📍 '+addr.split(',').slice(0,2).join(', ')+` (${parseFloat(lat).toFixed(4)}, ${parseFloat(lng).toFixed(4)})`;
    if(optMap){optMap.setView([lat,lng],15);toast('📍',currentLang==='ta'?'இடம் வரைபடத்தில் பின் செய்யப்பட்டது':'Location pinned on map');}
  }
}

// ══ MAP LAYERS (Road / Satellite) ══
const lightRoadUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
const darkRoadUrl  = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';

function buildBaseLayers(){
  // choose road URL based on current theme
  const roadUrl = isDark ? darkRoadUrl : lightRoadUrl;
  const osm=L.tileLayer(roadUrl,{
    attribution:'© OpenStreetMap, © Carto',
    maxZoom:19,
    className:'osm-tile'
  });
  const sat=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{
    attribution:'Tiles © Esri',
    maxZoom:19,
    className:'sat-tile'
  });
  return {osm,sat};
}

function attachBaseLayers(map,key){
  const {osm,sat}=buildBaseLayers();
  mapBases[key]={osm,sat,active:'osm'};
  osm.addTo(map);
  try{
    L.control.layers({'Road':osm,'Satellite':sat},null,{position:'topleft'}).addTo(map);
  }catch{}
  updateSatBtns();
}

function getMapByKey(key){
  return key==='dash'?dashMap:key==='opt'?optMap:key==='mini'?miniMap:null;
}

function setBaseLayer(key,which){
  const map=getMapByKey(key);
  const b=mapBases[key];
  if(!map||!b) return;
  const want=which==='sat'?'sat':'osm';
  if(b.active===want) return;
  try{
    if(want==='sat'){
      if(map.hasLayer(b.osm)) map.removeLayer(b.osm);
      if(!map.hasLayer(b.sat)) b.sat.addTo(map);
    }else{
      if(map.hasLayer(b.sat)) map.removeLayer(b.sat);
      if(!map.hasLayer(b.osm)) b.osm.addTo(map);
    }
    b.active=want;
  }catch{}
  updateSatBtns();
}

function toggleSatellite(key){
  const b=mapBases[key];
  if(!b) return;
  setBaseLayer(key,b.active==='osm'?'sat':'osm');
}

function updateSatBtns(){
  const dashBtn=document.getElementById('dash-sat-btn');
  if(dashBtn) dashBtn.classList.toggle('live-on',mapBases.dash?.active==='sat');
  const optBtn=document.getElementById('opt-sat-btn');
  if(optBtn) optBtn.classList.toggle('live-on',mapBases.opt?.active==='sat');
}




// ══ LOCATION MODE ══
let modalMiniMapInit=false;
function setLocMode(mode){
  locMode=mode;
  document.getElementById('lc-search').classList.toggle('sel',mode==='search');
  document.getElementById('lc-map').classList.toggle('sel',mode==='map');
  document.getElementById('mode-search').style.display=mode==='search'?'block':'none';
  document.getElementById('mode-map').style.display=mode==='map'?'block':'none';
  if(mode==='map'&&!modalMiniMapInit){
    modalMiniMapInit=true;
    setTimeout(()=>{
      miniMap=L.map('modal-mini-map',{center:[uLat,uLng],zoom:13,zoomControl:true});
      attachBaseLayers(miniMap,'mini');
      miniMap.on('click',e=>{
        lastMapClick.mini=e.latlng; setStreetPoint(e.latlng);
        const lat=e.latlng.lat.toFixed(5),lng=e.latlng.lng.toFixed(5);
        document.getElementById('m-lat').value=lat;document.getElementById('m-lng').value=lng;
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`,{headers:{'Accept-Language':'en'}})
          .then(r=>r.json()).then(d=>{
            const addr=d.display_name||`${lat}, ${lng}`;
            document.getElementById('m-addr').value=addr;
            document.getElementById('addr-display').textContent=addr.split(',').slice(0,2).join(', ');
          }).catch(()=>{document.getElementById('m-addr').value=`${lat},${lng}`;});
        document.getElementById('coord-display').classList.add('shown');
        document.getElementById('coord-text').textContent=`${parseFloat(lat).toFixed(4)}, ${parseFloat(lng).toFixed(4)}`;
        if(miniMapMarker)miniMap.removeLayer(miniMapMarker);
        miniMapMarker=L.marker([lat,lng]).addTo(miniMap);
      });
    },100);
  }
}

// ══ MOBILE SIDEBAR HELPERS ══
function toggleSidebar(){
  document.documentElement.classList.toggle('sidebar-open');
}
function closeSidebar(){
  document.documentElement.classList.remove('sidebar-open');
}

// ══ PAGE ROUTING ══
function showPage(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.getElementById('tab-'+id).classList.add('active');

  // close sidebar when navigating on mobile
  if(document.documentElement.classList.contains('mobile')){
    document.documentElement.classList.remove('sidebar-open');
  }

  // when switching to or from the assistant page we need to relocate the panel
  if(id==='assistant'){
    moveAiPanelIntoPage();
  } else {
    moveAiPanelToBody();
  }

  if(id==='home')animCounters();
  if(id==='dashboard'&&!dashInit)setTimeout(initDashMap,80);
  if(id==='optimizer'&&!optInit)setTimeout(initOptMap,80);
}

function moveAiPanelIntoPage(){
  const panel=document.getElementById('ai-assistant-panel');
  const fab=document.getElementById('ai-assistant-toggle');
  const container=document.getElementById('assistant');
  if(panel && container){
    container.appendChild(panel);
    panel.style.display='flex';
    panel.setAttribute('aria-hidden','false');
  }
  if(fab) fab.style.display='none';
}

function moveAiPanelToBody(){
  const panel=document.getElementById('ai-assistant-panel');
  const fab=document.getElementById('ai-assistant-toggle');
  if(panel){
    document.body.appendChild(panel);
    // hide panel when leaving page
    panel.style.display='none';
    panel.setAttribute('aria-hidden','true');
    if(fab) fab.classList.remove('active');
  }
  if(fab) fab.style.display='';
}

// ══ GEO ══
function startGeo(){
  if(!navigator.geolocation){setGeo(false,currentLang==='ta'?'GPS கிடைக்கவில்லை':'GPS unavailable');return;}
  setGeo(null,T[currentLang]['locating']);
  navigator.geolocation.watchPosition(
    p=>{uLat=p.coords.latitude;uLng=p.coords.longitude;setGeo(true,`${uLat.toFixed(4)}, ${uLng.toFixed(4)}`);updUserMarker();},
    ()=>setGeo(false,currentLang==='ta'?'GPS மறுக்கப்பட்டது':'GPS denied'),
    {enableHighAccuracy:true,maximumAge:3000,timeout:8000}
  );
}
function setGeo(ok,txt){
  document.getElementById('geo-lbl').textContent=txt;
  document.getElementById('geo-badge').className=ok===true?'geo-badge live':'geo-badge';
}
function updUserMarker(){
  if(!dashMap||!trackOn)return;
  const icon=L.divIcon({className:'',html:'<div class="user-pulse"></div>',iconSize:[20,20],iconAnchor:[10,10]});
  if(!uMarker){uMarker=L.marker([uLat,uLng],{icon,zIndexOffset:1000}).bindPopup('<div class="lpop-id">'+(currentLang==='ta'?'உங்கள் இடம்':'Your Location')+'</div>').addTo(dashMap);}
  else uMarker.setLatLng([uLat,uLng]);
}

// ══ DASHBOARD MAP ══
function initDashMap(){
  dashInit=true;
  dashMap=L.map('dash-map',{center:[uLat,uLng],zoom:13});
  attachBaseLayers(dashMap,'dash');
  const wi=L.divIcon({className:'',html:`<div style="width:32px;height:32px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;border:3px solid white;box-shadow:0 0 14px rgba(58,71,87,.4)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg></div>`,iconSize:[32,32],iconAnchor:[16,16]});
  L.marker([HUB.lat,HUB.lng],{icon:wi}).bindPopup('<div class="lpop-id">RouteX Hub</div><div class="lpop-addr">Salem Distribution Centre</div>').addTo(dashMap);
  const ui=L.divIcon({className:'',html:'<div class="user-pulse"></div>',iconSize:[20,20],iconAnchor:[10,10]});
  uMarker=L.marker([uLat,uLng],{icon:ui,zIndexOffset:1000}).bindPopup('<div class="lpop-id">'+(currentLang==='ta'?'உங்கள் இடம்':'Your Location')+'</div>').addTo(dashMap);
  lmLayer=L.layerGroup().addTo(dashMap);
  renderLandmarks();
  dashMap.on('click',e=>{lastMapClick.dash=e.latlng; setStreetPoint(e.latlng);});
  dashMap.on('contextmenu',e=>addLandmarkPrompt(e.latlng,'dash'));
  renderList();updKPIs();updateTime();
}

function renderLandmarks(){
  const chip=document.getElementById('lm-chip');
  if(chip) chip.style.display=lmOn?'flex':'none';
  if(!lmLayer) return;
  lmLayer.clearLayers();
  if(!lmOn) return;
  LANDMARKS.forEach(lm=>{
    const ic=L.divIcon({className:'',html:`<div style="width:28px;height:28px;border-radius:50%;background:rgba(34,199,122,.95);display:flex;align-items:center;justify-content:center;border:2px solid white;box-shadow:0 0 10px rgba(34,199,122,.4)">🌳</div>`,iconSize:[28,28],iconAnchor:[14,14]});
    L.marker([lm.lat,lm.lng],{icon:ic})
      .bindPopup(`<div class="lpop-id">Landmark</div><div class="lpop-addr">${(lm.text||'').replace(/</g,'&lt;')}</div><div style="margin-top:6px;font-size:11px;color:var(--muted)">Right‑click map to add more</div>`)
      .addTo(lmLayer);
  });
}

function toggleLandmarks(){
  lmOn=!lmOn;
  renderLandmarks();
  storeSave();
  toast('🌳',lmOn?(currentLang==='ta'?'அடையாளங்கள் காட்டப்படுகின்றன':'Landmarks shown'):(currentLang==='ta'?'அடையாளங்கள் மறைக்கப்பட்டது':'Landmarks hidden'));
}

function addLandmarkPrompt(latlng,src){
  const t=currentLang==='ta'?'உள்ளூர் அடையாளத்தை எழுதுங்கள் (உதா., ஆலமரம் எதிரில்):':'Enter a local landmark note (e.g., Opposite big Banyan tree):';
  const val=prompt(t);
  if(!val||!val.trim()) return;
  const lm={id:'LM-'+Date.now().toString(36),lat:+latlng.lat,lng:+latlng.lng,text:val.trim(),ts:Date.now()};
  LANDMARKS.unshift(lm);
  LANDMARKS=LANDMARKS.slice(0,80);
  storeSave();
  renderLandmarks();
  toast('🌳',currentLang==='ta'?'அடையாளம் சேமிக்கப்பட்டது':'Landmark saved');
}

function refreshDashMarkers(){
  dashMarkers.forEach(m=>dashMap&&dashMap.removeLayer(m));dashMarkers=[];
  if(!dashMap)return;
  ORDERS.forEach(o=>{
    const st=getStatus(o);
    const c={'on-route':getComputedStyle(document.documentElement).getPropertyValue('--green').trim()||'#22c77a','delayed':'#e53935','pending':'#2d7ff9','delivered':'#aaa'}[st]||'#888';
    const svg=o.vehicle==='bike'
      ?`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><circle cx="5" cy="19" r="3"/><circle cx="19" cy="19" r="3"/><path d="M5 19L9 7h5l2 5h4"/></svg>`
      :`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><rect x="1" y="8" width="15" height="10" rx="1"/><path d="M16 12l3 0l2 3l0 3l-5 0"/><circle cx="5.5" cy="18.5" r="1.5"/><circle cx="18.5" cy="18.5" r="1.5"/></svg>`;
    const icon=L.divIcon({className:'',html:`<div style="width:28px;height:28px;background:${c};border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid white;box-shadow:0 0 8px ${c}55">${svg}</div>`,iconSize:[28,28],iconAnchor:[14,14]});
    const stMap={'on-route':currentLang==='ta'?'பயணத்தில்':'En Route','delayed':currentLang==='ta'?'தாமதம்':'Delayed','pending':currentLang==='ta'?'நிலுவை':'Pending','delivered':currentLang==='ta'?'முடிந்தது':'Done'};
    const lm=o.landmark?`<div class="landmark-badge">🌳 ${escHtml(o.landmark)}</div>`:'';
    const m=L.marker([o.lat,o.lng],{icon}).bindPopup(`<div class="lpop-id">${escHtml(o.id)}</div><div class="lpop-addr">${escHtml(o.address)}${o.landmark?'<br>🌳 '+escHtml(o.landmark):''}</div>${lm}<span class="lpop-badge" style="background:${c}22;color:${c}">${stMap[st]||st}</span>`).addTo(dashMap);
    dashMarkers.push(m);
  });
}

function getStatus(o){
  if(o.status&&o.status!=='auto')return o.status;
  if(!o.deadline)return'pending';
  const now=new Date();
  const[h,m]=o.deadline.split(':').map(Number);
  const dl=new Date();dl.setHours(h,m,0,0);
  if(now>dl)return'delayed';
  const diff=(dl-now)/60000;
  return diff<30?'on-route':'pending';
}

function renderList(){
  const L=currentLang;
  if(!ORDERS.length){
    document.getElementById('del-list').innerHTML=`<div class="empty-dash"><svg width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg><p class="empty-title">${T[L]['no-orders']}</p><p style="font-size:12px">${T[L]['no-orders-sub']}</p></div>`;
    return;
  }
  const smap={'on-route':'b-on','delayed':'b-late','pending':'b-wait','delivered':'b-done'};
  const stxt={'on-route':L==='ta'?'பயணத்தில்':'En Route','delayed':L==='ta'?'தாமதம்':'Delayed','pending':L==='ta'?'நிலுவை':'Pending','delivered':L==='ta'?'முடிந்தது':'Done'};
  const dlLbl=L==='ta'?'கடைசி நேரம்: ':'Deadline: ';
  const noDlLbl=L==='ta'?'கடைசி நேரம் இல்லை':'No deadline';
  const doneLbl=L==='ta'?'✓ முடிந்தது':'✓ Done';
  document.getElementById('del-list').innerHTML=ORDERS.map((o,i)=>{
    const st=getStatus(o);
    const vsv=o.vehicle==='bike'
      ?`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--blue)" stroke-width="2"><circle cx="5" cy="19" r="3"/><circle cx="19" cy="19" r="3"/><path d="M5 19L9 7h5l2 5h4"/></svg>`
      :`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2"><rect x="1" y="8" width="15" height="10" rx="1"/><path d="M16 12l3 0l2 3l0 3l-5 0"/><circle cx="5.5" cy="18.5" r="1.5"/><circle cx="18.5" cy="18.5" r="1.5"/></svg>`;
    return`<div class="d-item" onclick="focusDel(${o.lat},${o.lng})">
      <div class="d-av">${vsv}</div>
      <div class="d-info">
        <div class="d-id">${o.id}</div>
        <div class="d-addr">${escHtml(o.address)}${o.product?' · '+escHtml(o.product):''}${o.landmark?' · 🌳 '+escHtml(o.landmark):''}</div>
        <div class="d-eta">${o.deadline?dlLbl+fmtTime(o.deadline):noDlLbl}</div>
      </div>
      <div class="d-actions">
        <div class="badge ${smap[st]||'b-wait'}">${stxt[st]||st}</div>
        <div style="display:flex;gap:5px;margin-top:3px">
          <span class="d-act-btn ok" onclick="event.stopPropagation();markDone(${i})">${doneLbl}</span>
          <span class="d-act-btn" onclick="event.stopPropagation();delOrder(${i})">✕</span>
        </div>
      </div>
    </div>`;
  }).join('');
  refreshDashMarkers();updKPIs();
}

function updKPIs(){
  const s=ORDERS.map(getStatus);
  document.getElementById('kpi-ac').textContent=s.filter(x=>x==='on-route').length;
  document.getElementById('kpi-dl').textContent=s.filter(x=>x==='delayed').length;
  document.getElementById('kpi-pd').textContent=s.filter(x=>x==='pending').length;
  const t=ORDERS.length,ok=s.filter(x=>x==='on-route'||x==='delivered').length;
  document.getElementById('kpi-ot').textContent=t?Math.round(ok/t*100)+'%':'–';
  const kf=document.getElementById('kpi-fuel'),kc=document.getElementById('kpi-co2');
  if(kf) kf.textContent=(ecoAgg?.fuelSavedPct||0)+'%';
  if(kc) kc.textContent=(ecoAgg?.co2PreventedG||0)+'g';
  const late=ORDERS.filter(o=>getStatus(o)==='delayed');
  if(late.length){
    document.getElementById('alert-bar').style.display='flex';
    const alertMsg=currentLang==='ta'
      ?`<strong>${late.length} ஆர்டர்கள் கடைசி நேரம் தாண்டியது!</strong> ${late[0].id} — ${late[0].address}`
      :`<strong>${late.length} order(s) past deadline!</strong> ${late[0].id} — ${late[0].address}`;
    document.getElementById('alert-text').innerHTML=alertMsg;
  }else document.getElementById('alert-bar').style.display='none';
}

function fmtTime(t){const[h,m]=t.split(':').map(Number);const s=h>=12?'PM':'AM';const hr=h>12?h-12:(h===0?12:h);return`${hr}:${String(m).padStart(2,'0')} ${s}`;}
function markDone(i){ORDERS[i].status='delivered';storeSave();renderList();syncOptOrders();toast('✅',currentLang==='ta'?`${ORDERS[i].id} டெலிவரி முடிந்தது!`:`${ORDERS[i].id} marked delivered!`);}
function delOrder(i){const id=ORDERS[i].id;ORDERS.splice(i,1);storeSave();renderList();syncOptOrders();toast('🗑️',currentLang==='ta'?`ஆர்டர் ${id} நீக்கப்பட்டது`:`Order ${id} removed`);}
function focusDel(lat,lng){if(dashMap)dashMap.setView([lat,lng],16,{animate:true});}
function toggleTracking(){
  trackOn=!trackOn;
  const b=document.getElementById('btn-track');
  b.className='map-btn'+(trackOn?' live-on':'');
  const span=b.querySelector('span[data-i18n]');
  const key=trackOn?'tracking-on':'tracking-off';
  if(span){span.setAttribute('data-i18n',key);span.textContent=T[currentLang][key];}
  if(trackOn&&dashMap)centerUser();
}
function centerUser(){if(dashMap)dashMap.setView([uLat,uLng],14,{animate:true});}
function fitAll(){if(!dashMap)return;const pts=[[uLat,uLng],[HUB.lat,HUB.lng],...ORDERS.map(o=>[o.lat,o.lng])];if(pts.length)dashMap.fitBounds(pts,{padding:[40,40]});}
let simPath=null;
function showTrafficAlert(msg){
  const el=document.createElement('div');
  el.className='traffic-alert';
  el.innerHTML=`⚠️ ${escHtml(msg)}<span class="alert-close" onclick="this.parentElement.remove()">✕</span>`;
  document.body.appendChild(el);
  setTimeout(()=>{try{el.remove();}catch{}},3200);
}

function setDashRouteColor(color){
  if(!dashRouteLine) return;
  dashRouteLine.setStyle({color,opacity:.9});
}

function buildStraightPts(nodes,steps=18){
  const out=[];
  for(let i=0;i<nodes.length-1;i++){
    const a=nodes[i],b=nodes[i+1];
    for(let s=0;s<steps;s++){
      const t=s/steps;
      out.push([a[0]+(b[0]-a[0])*t,a[1]+(b[1]-a[1])*t]);
    }
  }
  out.push(nodes[nodes.length-1]);
  return out;
}

async function osrmRoute(points,{alternatives=false}={}){
  const coords=points.map(p=>`${p[1]},${p[0]}`).join(';');
  const qs=new URLSearchParams({
    overview:'full',geometries:'geojson',steps:'false',
    alternatives:alternatives?'true':'false'
  });
  const url=`https://router.project-osrm.org/route/v1/driving/${coords}?${qs.toString()}`;
  const r=await fetch(url);
  if(!r.ok) throw new Error('osrm');
  return await r.json();
}

async function buildDashRoute(){
  const nodes=ORDERS.length?[[uLat,uLng],[ORDERS[0].lat,ORDERS[0].lng]]:[[uLat,uLng],[uLat+.01,uLng+.01]];
  try{
    if(!navigator.onLine) throw new Error('offline');
    const data=await osrmRoute(nodes);
    const coords=data?.routes?.[0]?.geometry?.coordinates;
    if(!coords?.length) throw new Error('noroute');
    return coords.map(c=>[c[1],c[0]]);
  }catch{
    return buildStraightPts(nodes,22);
  }
}

async function doSimulate(){
  if(simTmr){
    clearInterval(simTmr);simTmr=null;
    toast('⏹️',currentLang==='ta'?'உருவகம் நிறுத்தப்பட்டது':'Simulation stopped');
    if(dashRouteLine){try{dashMap.removeLayer(dashRouteLine);}catch{} dashRouteLine=null;}
    return;
  }
  dashRoutePts=await buildDashRoute();
  navSteps=buildNavSteps(dashRoutePts);
  navStepIdx=0;
  if(dashRouteLine){try{dashMap.removeLayer(dashRouteLine);}catch{}}
  // determine color based on predicted traffic signals/blocks
  const dashAnalysis = analyzeRouteTraffic(dashRoutePts);
  const dashColor = dashAnalysis.state==='signal' ? 'var(--red)' : 'var(--green)';
  dashRouteLine=L.polyline(dashRoutePts,{color:dashColor,weight:5,opacity:.9}).addTo(dashMap);
  showRouteAlerts(dashAnalysis.alerts);
  simIdx=0;
  toast('▶️',currentLang==='ta'?'ஓட்டுநர் உருவகம் தொடங்கியது':'Driver simulation started');
  // compute analysis once
  const simAnalysis = analyzeRouteTraffic(dashRoutePts);
  let lastNavSpoken='';
  simTmr=setInterval(()=>{
    if(simIdx>=dashRoutePts.length){
      clearInterval(simTmr);simTmr=null;
      // restore to predicted color
      setDashRouteColor(simAnalysis.state==='signal' ? 'var(--red)' : 'var(--green)');
      return;
    }
    const p=dashRoutePts[simIdx];
    uLat=p[0]+(Math.random()-.5)*.00018;
    uLng=p[1]+(Math.random()-.5)*.00018;
    updUserMarker();setGeo(true,`${uLat.toFixed(4)}, ${uLng.toFixed(4)}`);
    if(navStepIdx<navSteps.length && simIdx>=navSteps[navStepIdx].i){
      const step=navSteps[navStepIdx];
      const txt=currentLang==='ta'?step.ta:step.en;
      if(txt && txt!==lastNavSpoken){
        speakText(txt);
        lastNavSpoken=txt;
      }
      navStepIdx++;
    }
    // occasional traffic event
    if(simIdx>10 && simIdx%18===0 && Math.random()>.45){
      const road=['Main Road','Ring Road','Gandhi Street','NH‑44'][Math.floor(Math.random()*4)];
      showTrafficAlert((currentLang==='ta'?'போக்குவரத்து: ':'Traffic: ')+road);
      setDashRouteColor('#e53935');
      setTimeout(()=>setDashRouteColor('#f0dc50'),900);
      setTimeout(()=>setDashRouteColor(isDark?'#f0dc50':'#3a4757'),2600);
    }
    simIdx++;
  },800);
}
function updateTime(){const e=document.getElementById('dash-time');if(e)e.textContent=new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',second:'2-digit'})+' · Live';setTimeout(updateTime,1000);}

// ══ ADD ORDER MODAL ══
function openModal(){
  orderCounter=ORDERS.length+1;
  document.getElementById('m-id').value='ORD-'+String(orderCounter).padStart(3,'0');
  document.getElementById('m-lat').value='';document.getElementById('m-lng').value='';document.getElementById('m-addr').value='';
  document.getElementById('m-product').value='';document.getElementById('m-deadline').value='';
  if(document.getElementById('m-landmark')) document.getElementById('m-landmark').value='';
  document.getElementById('gc-modal').value='';document.getElementById('gc-modal-list').style.display='none';
  document.getElementById('coord-display').classList.remove('shown');
  document.getElementById('addr-display').textContent='';
  locMode='search';
  document.getElementById('lc-search').classList.add('sel');document.getElementById('lc-map').classList.remove('sel');
  document.getElementById('mode-search').style.display='block';document.getElementById('mode-map').style.display='none';
  modalMiniMapInit=false;
  document.getElementById('add-modal').style.display='flex';
}
function closeModal(){document.getElementById('add-modal').style.display='none';}
function bgClose(e){if(e.target.id==='add-modal')closeModal();}

function saveOrder(){
  const id=document.getElementById('m-id').value;
  const lat=parseFloat(document.getElementById('m-lat').value);
  const lng=parseFloat(document.getElementById('m-lng').value);
  const addr=document.getElementById('m-addr').value||document.getElementById('gc-modal').value;
  const product=document.getElementById('m-product').value.trim();
  const landmark=(document.getElementById('m-landmark')?.value||'').trim();
  const deadline=document.getElementById('m-deadline').value;
  const vehicle=document.getElementById('m-vehicle').value;
  if(!addr){toast('⚠️',currentLang==='ta'?'முதலில் டெலிவரி இடத்தை தேர்ந்தெடுக்கவும்!':'Please select a delivery location first!');return;}
  const fLat=isNaN(lat)?(11.6643+(Math.random()-.5)*.05):lat;
  const fLng=isNaN(lng)?(78.1460+(Math.random()-.5)*.05):lng;
  ORDERS.push({id,product,address:addr.split(',').slice(0,3).join(', '),landmark,deadline,vehicle,lat:fLat,lng:fLng,status:'auto',co2g:0});
  orderCounter++;
  storeSave();
  renderList();syncOptOrders();closeModal();toast('📦',currentLang==='ta'?`ஆர்டர் ${id} சேர்க்கப்பட்டது!`:`Order ${id} added!`);
}

// ══ OPTIMIZER ══
function syncOptOrders(){
  optOrders=ORDERS.map(o=>({...o}));
  renderOptList();
}

function renderOptList(){
  const el=document.getElementById('opt-order-list');
  if(!optOrders.length){el.innerHTML=`<div class="opt-no-orders">${T[currentLang]['no-opt-orders']}</div>`;return;}
  const smap={'on-route':'s-ok','delayed':'s-late','pending':'s-pend','delivered':'b-done'};
  const stxt={'on-route':currentLang==='ta'?'நேரத்தில்':'On Time','delayed':currentLang==='ta'?'தாமதம்':'Delayed','pending':currentLang==='ta'?'நிலுவை':'Pending','delivered':currentLang==='ta'?'முடிந்தது':'Done'};
  el.innerHTML=optOrders.map((o,i)=>{
    const st=getStatus(o);
    return`<div class="ord-item">
      <span class="ord-id">${o.id}</span>
      <span class="ord-addr">${o.address}</span>
      <span class="ord-status ${smap[st]||'s-pend'}">${stxt[st]||st}</span>
      <span class="rem-x" onclick="remOptOrd(${i})">✕</span>
    </div>`;
  }).join('');
}
function remOptOrd(i){optOrders.splice(i,1);renderOptList();}

function addOptOrder(){
  const addr=document.getElementById('opt-sel-addr').value||document.getElementById('opt-gc').value;
  const lat=parseFloat(document.getElementById('opt-sel-lat').value);
  const lng=parseFloat(document.getElementById('opt-sel-lng').value);
  const product=document.getElementById('opt-product').value.trim();
  const landmark=(document.getElementById('opt-landmark')?.value||'').trim();
  const deadline=document.getElementById('opt-deadline').value;
  if(!addr){toast('⚠️',currentLang==='ta'?'முதலில் முகவரி தேடுங்கள் அல்லது வரைபடத்தில் கிளிக் செய்யுங்கள்!':'Search for an address or click the map first!');return;}
  const fLat=isNaN(lat)?(11.6643+(Math.random()-.5)*.05):lat;
  const fLng=isNaN(lng)?(78.1460+(Math.random()-.5)*.05):lng;
  const id='ORD-'+String(Date.now()).slice(-4);
  optOrders.push({id,product,landmark,address:addr.split(',').slice(0,3).join(', '),deadline,lat:fLat,lng:fLng,vehicle:'van',status:'auto'});
  renderOptList();
  document.getElementById('opt-gc').value='';
  document.getElementById('opt-product').value='';document.getElementById('opt-deadline').value='';
  const lmEl=document.getElementById('opt-landmark'); if(lmEl) lmEl.value='';
  document.getElementById('opt-sel-lat').value='';document.getElementById('opt-sel-lng').value='';document.getElementById('opt-sel-addr').value='';
  document.getElementById('opt-coord-display').style.display='none';
  if(optMap)addOptMarker(fLat,fLng,id);
  toast('📍',currentLang==='ta'?`${id} பாதையில் சேர்க்கப்பட்டது`:`${id} added to route`);
}

function initOptMap(){
  optInit=true;
  optMap=L.map('opt-map',{center:[uLat,uLng],zoom:12});
  attachBaseLayers(optMap,'opt');
  const ui=L.divIcon({className:'',html:'<div class="user-pulse"></div>',iconSize:[20,20],iconAnchor:[10,10]});
  L.marker([uLat,uLng],{icon:ui}).bindPopup('<div class="lpop-id">'+(currentLang==='ta'?'உங்கள் இடம்':'Your Location')+'</div>').addTo(optMap);
  optMap.on('contextmenu',e=>addLandmarkPrompt(e.latlng,'opt'));
  optMap.on('click',e=>{
    lastMapClick.opt=e.latlng; setStreetPoint(e.latlng);
    const lat=e.latlng.lat.toFixed(5),lng=e.latlng.lng.toFixed(5);
    document.getElementById('opt-sel-lat').value=lat;document.getElementById('opt-sel-lng').value=lng;
    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`,{headers:{'Accept-Language':'en'}})
      .then(r=>r.json()).then(d=>{
        const addr=d.display_name||`${lat},${lng}`;
        document.getElementById('opt-sel-addr').value=addr;
        document.getElementById('opt-gc').value=addr.split(',').slice(0,2).join(', ');
        document.getElementById('opt-coord-display').style.display='block';
        document.getElementById('opt-coord-display').textContent='📍 '+addr.split(',').slice(0,2).join(', ');
      }).catch(()=>{
        document.getElementById('opt-sel-addr').value=`${lat},${lng}`;
        document.getElementById('opt-gc').value=`${lat},${lng}`;
        document.getElementById('opt-coord-display').style.display='block';
        document.getElementById('opt-coord-display').textContent='📍 '+lat+', '+lng;
      });
    toast('📌',currentLang==='ta'?'இடம் தேர்ந்தெடுக்கப்பட்டது! பொருள் சேர்த்து "சேர்" கிளிக் செய்யுங்கள்.':'Coordinates selected! Fill product/deadline and click Add.');
  });
  syncOptOrders();
}

function addOptMarker(lat,lng,name){
  const idx=optMapMarkers.length;
  const c=DCOLS[idx%DCOLS.length];
  const icon=L.divIcon({className:'',html:`<div style="width:24px;height:24px;background:${c};border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:900;font-family:'Nunito',sans-serif;color:white;border:2px solid white">${idx+1}</div>`,iconSize:[24,24],iconAnchor:[12,12]});
  const m=L.marker([lat,lng],{icon,draggable:true}).bindPopup(`<div class="lpop-id">${name}</div><div class="lpop-addr">${parseFloat(lat).toFixed(4)}, ${parseFloat(lng).toFixed(4)}</div>`).addTo(optMap);
  optMapMarkers.push(m);
}

// ══ ROUTE OPTIMIZER ══
async function runOptimizer(){
  if(!optOrders.length){toast('⚠️',currentLang==='ta'?'முதலில் ஒரு டெலிவரி ஆர்டர் சேர்க்கவும்!':'Add at least one delivery order first!');return;}
  const btn=document.getElementById('run-btn');
  const lbl=document.getElementById('run-lbl');
  const spin=document.getElementById('run-spin');
  const useMyPos=document.getElementById('tgl-mypos').classList.contains('on');
  const sLat=useMyPos?uLat:HUB.lat;
  const sLng=useMyPos?uLng:HUB.lng;
  const sName=useMyPos?(currentLang==='ta'?'உங்கள் இடம்':'Your Location'):(currentLang==='ta'?'சேலம் மையம்':'Salem Hub');
  const now=new Date();

  const sortedOrders=[...optOrders].sort((a,b)=>{
    if(!a.deadline&&!b.deadline)return 0;
    if(!a.deadline)return 1;if(!b.deadline)return-1;
    return a.deadline.localeCompare(b.deadline);
  });
  const lateCount=sortedOrders.filter(o=>{
    if(!o.deadline)return false;
    const[h,m]=o.deadline.split(':').map(Number);
    const dl=new Date();dl.setHours(h,m,0,0);
    return now>dl;
  }).length;

  const tglOn=document.querySelector('#optimizer .tgl.on');
  const priKey=tglOn?tglOn.getAttribute('data-i18n'):'tgl-fastest';
  const priority=priKey==='tgl-eco'?'eco':priKey==='tgl-shortest'?'shortest':'fastest';

  const stops=[{lat:sLat,lng:sLng,name:sName},...sortedOrders.map(o=>({lat:o.lat,lng:o.lng,name:o.address,landmark:o.landmark||''})),{lat:sLat,lng:sLng,name:(currentLang==='ta'?'திரும்பு: ':'Return to ')+sName}];
  const nodes=stops.map(s=>[s.lat,s.lng]);

  // clear old LRM control if present
  if(optRouteCtrl){try{optMap.removeControl(optRouteCtrl);}catch{} optRouteCtrl=null;}
  if(optRouteLine){try{optMap.removeLayer(optRouteLine);}catch{} optRouteLine=null;}
  if(optStopLayer){try{optMap.removeLayer(optStopLayer);}catch{} optStopLayer=null;}

  btn.disabled=true; lbl.textContent=currentLang==='ta'?'பாதை திட்டமிடுகிறது…':'Planning route…'; spin.style.display='block';
  toast('⚡',currentLang==='ta'?'OSRM மூலம் பல பாதைகள் கணக்கிடுகிறது…':'Computing route (alternatives)…',2600);

  const angle=(a,b,c)=>{
    const ux=b[0]-a[0],uy=b[1]-a[1],vx=c[0]-b[0],vy=c[1]-b[1];
    const du=Math.hypot(ux,uy),dv=Math.hypot(vx,vy);
    if(!du||!dv) return 180;
    const dot=(ux*vx+uy*vy)/(du*dv);
    const cl=Math.max(-1,Math.min(1,dot));
    return Math.acos(cl)*180/Math.PI;
  };
  const sharpTurns=(coords)=>{
    let n=0;
    for(let i=1;i<coords.length-1;i+=6){
      const a=coords[i-1],b=coords[i],c=coords[i+1];
      const ang=angle(a,b,c);
      if(ang<110) n++;
    }
    return n;
  };
  const ecoScore=(coords,distM,durS)=>{
    const turns=sharpTurns(coords);
    // heuristic: penalize sharp turns + stop/go; keep distance dominant
    return distM + turns*120 + durS*0.35;
  };
  const approxDistM=(pts)=>{
    let d=0;
    for(let i=0;i<pts.length-1;i++){
      const a=pts[i],b=pts[i+1];
      const dx=(a[0]-b[0])*111000,dy=(a[1]-b[1])*111000*Math.cos((a[0]+b[0])*Math.PI/360);
      d+=Math.hypot(dx,dy);
    }
    return d;
  };

  let routes=[];
  try{
    if(!navigator.onLine) throw new Error('offline');
    const data=await osrmRoute(nodes,{alternatives:true});
    routes=(data?.routes||[]).map(r=>{
      const coords=(r.geometry?.coordinates||[]).map(c=>[c[1],c[0]]);
      return {distance:r.distance||0,duration:r.duration||0,coords};
    }).filter(r=>r.coords.length>2);
    if(!routes.length) throw new Error('noroute');
  }catch{
    const coords=buildStraightPts(nodes,24);
    const dist=approxDistM(coords);
    routes=[{distance:dist,duration:dist/9,coords}]; // ~32km/h
  }

  routes=routes.map(r=>({...r,turns:sharpTurns(r.coords),eco:ecoScore(r.coords,r.distance,r.duration)}));
  const fastest=routes.reduce((a,b)=>b.duration<a.duration?b:a,routes[0]);
  const shortest=routes.reduce((a,b)=>b.distance<a.distance?b:a,routes[0]);
  const eco=routes.reduce((a,b)=>b.eco<a.eco?b:a,routes[0]);
  const chosen=priority==='eco'?eco:(priority==='shortest'?shortest:fastest);

  // KPIs (real, not random)
  const distKm=(chosen.distance/1000);
  const timeH=(chosen.duration*1.25/3600); // traffic buffer
  const base=fastest;
  const fuelSavedPct=Math.max(0,Math.min(35,Math.round(((base.eco-chosen.eco)/Math.max(base.eco,1))*100)));
  const avgRateGkm=(()=>{
    if(!sortedOrders.length) return 150;
    const sum=sortedOrders.reduce((s,o)=>s+(o.vehicle==='bike'?85:160),0);
    return sum/sortedOrders.length;
  })();
  const co2PreventedG=Math.max(0,Math.round(((base.distance-chosen.distance)/1000)*avgRateGkm));

  ecoAgg={fuelSavedPct,co2PreventedG,lastPriority:priority,ts:Date.now()};
  const per=Math.round(co2PreventedG/Math.max(sortedOrders.length,1));
  sortedOrders.forEach(o=>{o.co2g=per;});
  // sync to ORDERS by id
  ORDERS=ORDERS.map(o=>{
    const u=sortedOrders.find(x=>x.id===o.id);
    return u?{...o,landmark:u.landmark||o.landmark||'',co2g:u.co2g||0}:o;
  });
  storeSave();

  // draw route + stop markers
  // analyze signals/blocks so we can color the route and show alerts
  const optAnalysis = analyzeRouteTraffic(chosen.coords);
  const optColor = optAnalysis.state==='signal' ? 'var(--red)' : 'var(--green)';
  optRouteLine=L.polyline(chosen.coords,{color:optColor,weight:5,opacity:.92}).addTo(optMap);
  showRouteAlerts(optAnalysis.alerts);
  optStopLayer=L.layerGroup().addTo(optMap);
  stops.forEach((s,i)=>{
    const isS=i===0,isE=i===stops.length-1;
    const c=isS||isE?'#f0dc50':DCOLS[i%DCOLS.length];
    const lbl=isS?'S':isE?'R':i;
    const icon=L.divIcon({className:'',html:`<div style="width:26px;height:26px;background:${c};border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:900;font-family:'Nunito',sans-serif;color:#1e2a35;border:2px solid white">${lbl}</div>`,iconSize:[26,26],iconAnchor:[13,13]});
    const ord=sortedOrders[i-1];
    const lm=ord?.landmark?`<div class="landmark-badge">🌳 ${escHtml(ord.landmark)}</div>`:'';
    const isLate=!!(ord?.deadline && (()=>{const[h,m]=ord.deadline.split(':').map(Number);const dl=new Date();dl.setHours(h,m,0,0);return now>dl;})());
    const dlTxt=ord?.deadline?(currentLang==='ta'?(isLate?'⚠️ கடைசி நேரம் கடந்தது':'⏰ கடைசி நேரம்: '+fmtTime(ord.deadline)):(isLate?'⚠️ PAST deadline':'⏰ Deadline: '+fmtTime(ord.deadline))):'';
    const dlNote=dlTxt?`<div style="font-size:11px;color:${isLate?'var(--red)':'var(--green)'}">${dlTxt}</div>`:'';
    L.marker([s.lat,s.lng],{icon}).bindPopup(`<div class="lpop-id">${escHtml(s.name.split(',')[0])}</div>${dlNote}${lm}`).addTo(optStopLayer);
  });
  optMap.fitBounds(optRouteLine.getBounds(),{padding:[30,30]});

  const ontime=Math.max(0,Math.round((sortedOrders.length-lateCount)/Math.max(sortedOrders.length,1)*100));
  document.getElementById('rk-dist').textContent=distKm.toFixed(1)+' km';
  document.getElementById('rk-time').textContent=timeH.toFixed(1)+' h';
  document.getElementById('rk-fuel').textContent=fuelSavedPct+'%';
  document.getElementById('rk-ot').textContent=ontime+'%';
  document.getElementById('res-kpis').style.display='flex';
  document.getElementById('res-lbl').textContent=currentLang==='ta'?`பாதை தயார் · ${priority==='eco'?'🌱 சேமிப்பு':''}`:`Route ready · ${priority==='eco'?'🌱 Eco':''}`;
  document.getElementById('res-sub').textContent=currentLang==='ta'?`${stops.length-1} நிறுத்தங்கள் · ${navigator.onLine?'OSRM':'Offline'} · CO₂ ${co2PreventedG}g`:`${stops.length-1} stops · ${navigator.onLine?'OSRM':'Offline'} · CO₂ ${co2PreventedG}g`;
  document.getElementById('res-stops').innerHTML=stops.map((s,i)=>{
    const isF=i===0,isL=i===stops.length-1;
    const cls=isF||isL?'w':i<3?'d':'s';
    const lb=isF?'S':isL?'R':i;
    const ord=sortedOrders[i-1];
    const late=ord&&ord.deadline&&(()=>{const[h,m]=ord.deadline.split(':').map(Number);const dl=new Date();dl.setHours(h,m,0,0);return now>dl;})();
    return`<div class="rs-stop"><div class="rs-inner"><div class="rs-dot ${cls}" style="${late?'background:var(--red)!important;':''}">${lb}</div><div class="rs-name">${escHtml(s.name.split(',')[0])}</div></div>${i<stops.length-1?'<div class="rs-line"></div>':''}</div>`;
  }).join('');

  btn.disabled=false; lbl.textContent=T[currentLang]['btn-generate']; spin.style.display='none';
  updKPIs(); renderList();
  toast('✅',currentLang==='ta'?`பாதை தயார்! ${distKm.toFixed(1)}கி.மீ · ${timeH.toFixed(1)}மணி · CO₂ ${co2PreventedG}g`:`Route ready! ${distKm.toFixed(1)}km · ${timeH.toFixed(1)}h · CO₂ ${co2PreventedG}g`);

  // optionally ask the local assistant for a brief summary/suggestion
  try{
    const summaryQ = currentLang==='ta' ? 'தயவு செய்து இந்த டெலிவரிகளை சுருக்கமாகப் பகிரவும்.' : 'Please provide brief insights for these deliveries.';
    await aiHandleModelQnA(summaryQ,{});
  }catch(e){/* ignore */}
}

function pickTgl(el){
  el.closest('.tgl-row').querySelectorAll('.tgl').forEach(b=>b.classList.remove('on'));
  el.classList.add('on');
}

// ══ HOME COUNTERS ══
function animCounters(){
  document.querySelectorAll('[data-target]').forEach(el=>{
    let cur=0;const target=parseInt(el.dataset.target);const step=target/35;
    const t=setInterval(()=>{cur=Math.min(cur+step,target);el.textContent=Math.round(cur)+'%';if(cur>=target)clearInterval(t);},28);
  });
}

// ══ TOAST ══
let toastTmr=null;
function toast(icon,text,dur=3000){
  document.getElementById('toast-ic').textContent=icon;
  document.getElementById('toast-tx').textContent=text;
  document.getElementById('toast').classList.add('show');
  clearTimeout(toastTmr);
  toastTmr=setTimeout(()=>document.getElementById('toast').classList.remove('show'),dur);
}

// ══ VOICE COMMANDS (Web Speech API) ══
let voiceFocusIdx=0;
function toggleAiAssistant(){
  const panel=document.getElementById('ai-assistant-panel');
  const fab=document.getElementById('ai-assistant-toggle');
  if(!panel||!fab) return;
  const open=panel.style.display==='flex';
  panel.style.display=open?'none':'flex';
  panel.setAttribute('aria-hidden',open?'true':'false');
  fab.classList.toggle('active',!open);
}

function appendAiMessage(sender,text){
  const log=document.getElementById('ai-chat-log');
  if(!log) return;
  const div=document.createElement('div');
  div.className='ai-msg '+(sender==='user'?'user':'bot');
  div.textContent=String(text||'').trim();
  log.appendChild(div);
  log.scrollTop=log.scrollHeight;
}

function aiEtaText(){
  const rk=document.getElementById('rk-time');
  const val=rk?rk.textContent.trim():'';
  if(val && val!=='–'){
    return currentLang==='ta'
      ? `தற்போதைய optimize செய்யப்பட்ட பாதை சராசரி நேரம் ${val}.`
      : `The current optimized route is estimated to take ${val}.`;
  }
  return currentLang==='ta'
    ? 'முதலில் Optimizer பக்கத்தில் பாதையை உருவாக்குங்கள்; அதன் பின் நேரத்தை நான் சொல்லுவேன்.'
    : 'Generate a route on the Optimizer page first, then I can tell you the estimated time.';
}

function aiNextStopText(){
  if(!ORDERS.length){
    return currentLang==='ta'?'இப்போது எந்த ஆர்டர்களும் இல்லை.':'There are no delivery orders right now.';
  }
  const idx=ORDERS.findIndex(o=>getStatus(o)!=='delivered');
  const o=idx>=0?ORDERS[idx]:ORDERS[0];
  const addr=o.address||'';
  return currentLang==='ta'
    ? `அடுத்த நிறுத்தம் ${o.id}, ${addr}.`
    : `Your next stop is ${o.id} at ${addr}.`;
}

async function callAiBackend(payload){
  // Offline keyword responder (works when opening HTML directly)
  const question = (payload?.question||'').toString().toLowerCase();
  const lang = currentLang==='ta' ? 'ta' : 'en';

  const map = {
    en: [
      {keys:['eta','how long','time to','reach','arrive'], reply:'Generate a route using the Optimizer first; then use the route KPIs to estimate ETA.'},
      {keys:['how many orders','total orders','how many','orders'], reply: ()=>`You currently have ${ORDERS.length} delivery orders.`},
      {keys:['next stop','next order'], reply: ()=>{ const idx=ORDERS.findIndex(o=>getStatus(o)!=='delivered'); const o=idx>=0?ORDERS[idx]:ORDERS[0]; return o?`Next stop: ${o.id} — ${o.address||'address not set'}`:'No orders available.';}},
      {keys:['order details','details of orders','order info'], reply: ()=>{
          if(!ORDERS.length) return 'No orders at the moment.';
          return ORDERS.map((o,i)=>`${i+1}. ${o.product||'item'} to ${o.address||'unknown'} (${getStatus(o)})`).join('; ');
        }
      },
      {keys:['create order','place order','add order'], reply:'To create an order, provide product and address or use the Add Order form.'},
      {keys:['help','hello','hi'], reply:'Hi — ask about ETA, total orders, or say "create order" to add one.'},
      {keys:['bye','goodbye','see you'], reply:'Goodbye! Come back anytime.'}
    ],
    ta: [
      {keys:['எவ்வளவு','எத்தனை நேரம்','எப்போ'], reply:'முதலில் Optimizer இல் பாதையை உருவாக்கவும்; அதன் பின் நேரத்தை கணக்கிடலாம்.'},
      {keys:['அனைத்தும்','மொத்தம்','ஆர்டர்','எத்தனை'], reply: ()=>`தற்போது மொத்தம் ${ORDERS.length} ஆர்டர்கள் உள்ளன.`},
      {keys:['அடுத்த','அடுத்த நிறுத்தம்'], reply: ()=>{ const idx=ORDERS.findIndex(o=>getStatus(o)!=='delivered'); const o=idx>=0?ORDERS[idx]:ORDERS[0]; return o?`அடுத்த நிறுத்தம்: ${o.id} — ${o.address||'முகவரி இல்லை'}`:'ஆர்டர்கள் இல்லை.';}},
      {keys:['ஆர்டர் விவரம்','விவரங்கள்','அந்தோர் தகவல்'], reply: ()=>{
          if(!ORDERS.length) return 'தற்போது எந்த ஆர்டர்களும் இல்லை.';
          return ORDERS.map((o,i)=>`${i+1}. ${o.product||'பொருள்'} -> ${o.address||'தகவல் இல்லை'} (${getStatus(o)})`).join('; ');
        }
      },
      {keys:['உதவி','வணக்கம்'], reply:'வணக்கம் — ETA, ஆர்டர் எண்ணிக்கை போன்றவற்றை கேட்டுக்கொள்ளலாம்.'},
      {keys:['போதா','மீண்டும் வரலாம்'], reply:'பிரியா! எப்போதும் வரலாம்.'}
    ]
  };

  const pool = map[lang] || map['en'];
  for(const item of pool){
    for(const k of item.keys){
      if(question.includes(k)){
        try{ const out = typeof item.reply==='function' ? item.reply() : item.reply; return {text: out}; }catch(e){return {text: String(item.reply)}}
      }
    }
  }

  if(!question.trim()) return {text: lang==='ta' ? 'தயவுசெய்து கேள்வியை உள்ளிடுக.' : 'Please enter a question.'};
  return {text: lang==='ta' ? 'மன்னிக்கவும், அதை புரிந்துகொள்ள முடியவில்லை.' : 'Sorry, I cannot answer that yet. Try asking about ETA, orders, or creating an order.'};
}

// Removed external DuckDuckGo helper; using offline responder instead.

async function aiHandleModelQnA(userText,slots){
  const etaLabel=document.getElementById('rk-time')?.textContent?.trim()||'';
  const ctx={
    lang:currentLang,
    eta:etaLabel&&etaLabel!=='-'?etaLabel:null,
    totalOrders:ORDERS.length,
    pendingOrders:ORDERS.filter(o=>getStatus(o)!=='delivered').length,
    sampleOrders:ORDERS.slice(0,5).map(o=>({
      id:o.id,product:o.product,address:o.address,deadline:o.deadline,vehicle:o.vehicle,status:getStatus(o)
    })),
  };
  const payload={
    question:userText,
    slots,
    context:ctx,
  };
  const {text}=await callAiBackend(payload);
  appendAiMessage('bot',text);
  speakText(text);
}

async function aiHandleOrder(slots,rawText){
  if(!slots.product && !slots.address && !slots.landmark){
    appendAiMessage('bot',currentLang==='ta'
      ? 'ஆர்டர் உருவாக்க தயாராக இருக்கிறேன். தயவுசெய்து பொருள் மற்றும் முகவரியை சொல்லுங்கள்.'
      : 'I can place an order for you. Please mention the product and delivery address.');
    return;
  }
  if(!isModalOpen()) openModal();
  if(slots.product) setInp('m-product',slots.product);
  if(slots.landmark) setInp('m-landmark',slots.landmark);
  if(slots.address){
    await voiceGeocodeAndSelect(slots.address,'modal');
  }
  saveOrder();
  const last=ORDERS[ORDERS.length-1];
  const summaryEn=`I have created order ${last.id} for "${last.product||'item'}" to ${last.address||'the selected address'}.`;
  const summaryTa=`"${last.product||'பொருள்'}" க்கான ஆர்டர் ${last.id} ${last.address||'தேர்ந்தெடுக்கப்பட்ட முகவரிக்கு'} உருவாக்கப்பட்டது.`;
  appendAiMessage('bot',currentLang==='ta'?summaryTa:summaryEn);
  speakText(currentLang==='ta'?summaryTa:summaryEn);
}

async function aiHandleInput(text){
  const t=(text||'').trim();
  if(!t) return;
  appendAiMessage('user',t);
  const lower=t.toLowerCase();

  // greetings
  if(/\b(hi|hello|hey|வணக்கம்|ஹலோ|hello there|hi there)\b/i.test(lower)){
    const msg=currentLang==='ta'?'வணக்கம்! எப்படி உதவலாம்?':'Hello! How can I help you?';
    appendAiMessage('bot',msg);
    speakText(msg);
    return;
  }
  // farewells
  if(/\b(bye|goodbye|see you|thanks|thank you|paalam|போதா)\b/i.test(lower)){
    const msg=currentLang==='ta'?'பிரியா! மீண்டும் பேசலாம்.':'Goodbye! Talk soon.';
    appendAiMessage('bot',msg);
    speakText(msg);
    return;
  }

  // details query
  if(/\b(order\s*details?|details\s*of\s*orders?|order\s*info|order\s*status)\b/i.test(lower)){
    if(ORDERS.length===0){
      const msg=currentLang==='ta'?'எந்த ஆர்டர்களும் இல்லை':'No orders at the moment.';
      appendAiMessage('bot',msg);
      speakText(msg);
      return;
    }
    const list=ORDERS.map((o,i)=>{
      const status=getStatus(o);
      return `${i+1}. ${o.product||'item'} to ${o.address||'unknown'} (${status})`;
    }).join('. ');
    const msg=currentLang==='ta'
      ? `உங்கள் ஆர்டர்கள்: ${list}`
      : `Your orders: ${list}`;
    appendAiMessage('bot',msg);
    speakText(msg);
    return;
  }

  const orderHints=['order','deliver','delivery','place','send','ship','drop','ஆர்டர்','டெலிவரி','அனுப்பு','கொடு'];
  const isOrderIntent=orderHints.some(k=>lower.includes(k));

  const isEta=/\b(how long|eta|reach|arrive|time to|எவ்வளவு நேரம்|எப்போ வரும்|எத்தனை நேரத்தில்)\b/i.test(lower);
  if(isEta){
    const msg=aiEtaText();
    appendAiMessage('bot',msg);
    speakText(msg);
    return;
  }

  if(/(next stop|next order|அடுத்த\s*நிறுத்தம்|அடுத்த\s*ஆர்டர்)/i.test(lower)){
    const msg=aiNextStopText();
    appendAiMessage('bot',msg);
    speakText(msg);
    return;
  }

  if(/(how many orders|total orders|எத்தனை\s*ஆர்டர்)/i.test(lower)){
    const n=ORDERS.length;
    const msg=currentLang==='ta'
      ? `இப்போது மொத்தம் ${n} ஆர்டர்கள் உள்ளன.`
      : `You currently have ${n} delivery orders.`;
    appendAiMessage('bot',msg);
    speakText(msg);
    return;
  }

  const slots=parseVoiceSlots(t);
  if(isOrderIntent || slots.product || slots.address || slots.landmark){
    await aiHandleOrder(slots,t);
    return;
  }
  await aiHandleModelQnA(t,slots);
}

function aiStartVoice(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){toast('❌',currentLang==='ta'?'இந்த சாதனத்தில் குரல் ஆதரவு இல்லை':'Voice not supported');return;}
  if(aiVoiceRec){try{aiVoiceRec.abort();}catch{}}
  aiVoiceRec=new SR();
  aiVoiceRec.lang=currentLang==='ta'?'ta-IN':'en-IN';
  aiVoiceRec.continuous=true;
  aiVoiceRec.interimResults=true;
  aiVoiceRec.maxAlternatives=1;
  const mic=document.getElementById('ai-mic-btn');
  const input=document.getElementById('ai-text-input');
  if(mic){mic.classList.add('listening');}
  let finalTranscript='',listeningStarted=false,baseInput='';
  aiVoiceRec.onstart=()=>{
    listeningStarted=true;
    finalTranscript='';
    baseInput = input?input.value:''; // preserve any typed text
    if(input) input.placeholder=currentLang==='ta'?'கேட்கிறது...':'Listening...';
    if(mic) mic.style.animation='pulseRing 0.55s infinite';
  };
  aiVoiceRec.onresult=e=>{
    let interim='';
    for(let i=e.resultIndex;i<e.results.length;i++){
      const txt=(e.results[i]?.[0]?.transcript||'').trim();
      if(e.results[i].isFinal){finalTranscript+=txt+' ';}else{interim+=txt;}
    }
    if(input) input.value=baseInput + finalTranscript + interim;
  };
  aiVoiceRec.onerror=e=>{
    if(mic){mic.classList.remove('listening');mic.style.animation='none';}
    const errMsg={
      'network-error':currentLang==='ta'?'நெட்வொர்க் பிழை':'Network error. Check connection.',
      'permission-denied':currentLang==='ta'?'மைக் அனுமதி மறுக்கப்பட்டது':'Mic permission denied. Enable in settings.',
      'no-speech':currentLang==='ta'?'குரல் உணரப்படவில்லை':'No speech detected. Try again.',
      'audio-capture':currentLang==='ta'?'மைக் கணித்ய முடிவில்லை':'No mic. Check hardware.',
      'service-not-allowed':currentLang==='ta'?'இந்த சாதனத்தில் குரல் ஆதரவு இல்லை':'Voice not available on this device.'
    }[e.error]||(currentLang==='ta'?'குரல் பிழை':'Voice error: '+e.error);
    toast('❌',errMsg);
  };
  aiVoiceRec.onend=()=>{
    if(mic){mic.classList.remove('listening');mic.style.animation='none';}
    if(!listeningStarted) return;
    finalTranscript=finalTranscript.trim();
    if(!finalTranscript){
      if(input) input.placeholder=currentLang==='ta'?'ஒரு ஆணையை விவரிக்கவும் அல்லது கேள்வைக்கவும்...':'Describe an order or ask about ETA…';
      return;
    }
    if(input) input.value=finalTranscript;
    aiHandleInput(finalTranscript);
    if(input){
      input.placeholder=currentLang==='ta'?'ஒரு ஆணையை விவரிக்கவும் அல்லது கேள்வைக்கவும்...':'Describe an order or ask about ETA…';
      input.value='';
    }
  };
  try{aiVoiceRec.start();}catch(err){
    toast('❌',currentLang==='ta'?'குரல் தொடங்க முடியவில்லை':'Voice start failed');
    if(mic){mic.classList.remove('listening');mic.style.animation='none';}
  }
}

function sendAiText(){
  const inp=document.getElementById('ai-text-input');
  if(!inp) return;
  const v=inp.value.trim();
  if(!v){toast('ℹ️',currentLang==='ta'?'வெற்றுக் கேள்வி':'Empty message');return;}
  if(v.length>500){toast('⚠️',currentLang==='ta'?'500 எழுத்துக்கு மேல் அனுமதிக்கப்பட்டதில்லை':'Max 500 characters');return;}
  inp.value='';
  inp.placeholder=currentLang==='ta'?'ஒரு ஆணையை விவரிக்கவும் அல்லது கேளவைக்கவும்...':'Describe an order or ask about ETA…';
  aiHandleInput(v);
}

function isModalOpen(){
  const m=document.getElementById('add-modal');
  return !!(m && m.style.display && m.style.display!=='none');
}

function activePageId(){
  const p=document.querySelector('.page.active');
  return p?p.id:null;
}

async function voiceGeocodeAndSelect(query,ctx){
  const q=(query||'').trim();
  if(q.length<3) return;
  // Optimistic UI update so users see the address immediately
  if(ctx==='modal'){
    const el=document.getElementById('gc-modal'); if(el) el.value=q;
  }else if(ctx==='opt'){
    const el=document.getElementById('opt-gc'); if(el) el.value=q;
  }
  if(!navigator.onLine){toast('📴',currentLang==='ta'?'ஆஃப்லைன்: முகவரி தேட முடியவில்லை':'Offline: cannot search address');return;}
  const doSearch=async(q2)=>{
    const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q2)}&countrycodes=in&limit=1&addressdetails=1`,{headers:{'Accept-Language':'en'}});
    return await r.json();
  };
  const tryTranslateTaToEn=async(t)=>{
    const url=(localStorage.getItem('routex_translate_url')||'').trim();
    if(!url) return '';
    try{
      const r=await fetch(url,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({q:t,source:'ta',target:'en',format:'text'})
      });
      const d=await r.json();
      return (d?.translatedText||d?.translation||'').toString().trim();
    }catch{return '';}
  };
  try{
    let data=await doSearch(q);
    if(!data?.length && /[\u0B80-\u0BFF]/.test(q)){
      const en=await tryTranslateTaToEn(q);
      if(en) data=await doSearch(en);
    }
    if(!data?.length){toast('🔎',currentLang==='ta'?'முகவரி கிடைக்கவில்லை':'No match found');return;}
    const d=data[0];
    selectGeoResult(d.lat,d.lon,d.display_name,ctx);
    toast('📍',currentLang==='ta'?'இடம் அமைக்கப்பட்டது':'Location set');
  }catch{
    toast('❌',currentLang==='ta'?'முகவரி தேடல் தோல்வி':'Address search failed');
  }
}

function setInp(id,val){
  const el=document.getElementById(id);
  if(!el) return false;
  el.value=val;
  try{el.dispatchEvent(new Event('input',{bubbles:true}));}catch{}
  try{el.dispatchEvent(new Event('change',{bubbles:true}));}catch{}
  return true;
}

function setPriority(p){
  const row=document.querySelector('#optimizer .section-block .tgl-row');
  if(!row) return false;
  const map={fastest:'tgl-fastest',shortest:'tgl-shortest',eco:'tgl-eco'};
  const key=map[p];
  const btn=[...document.querySelectorAll('#optimizer .tgl-row .tgl')].find(b=>b.getAttribute('data-i18n')===key);
  if(btn){btn.click(); return true;}
  return false;
}

function parseVoiceSlots(t){
  const txt=(t||'').trim();
  const slots={};
  const isTamil=/[\u0B80-\u0BFF]/.test(txt);
  slots.langHint=isTamil?'ta':'en';

  const lower=txt.toLowerCase();
  const startsWithAny=(arr)=>arr.some(k=>lower.startsWith(k));
  const stopKeys=[
    'address','location','deliver to','drop at','product','item','landmark','vehicle','capacity','priority',
    'முகவரி','இடம்','டெலிவரி','பொருள்','அடையாள','லேண்ட்மார்க்','வாகனம்','திறன்','முன்னுரிமை',
  ];
  function capture(keys){
    let best=null, bestKey=null;
    for(const k of keys){
      const i=lower.indexOf(k);
      if(i>=0 && (best===null || i<best)){best=i; bestKey=k;}
    }
    if(best===null) return '';
    let rest=txt.slice(best+bestKey.length).trim().replace(/^[:\-–]\s*/,'');
    let end=rest.length;
    const restLower=rest.toLowerCase();
    for(const sk of stopKeys){
      const j=restLower.indexOf(sk);
      if(j>0 && j<end) end=j;
    }
    return rest.slice(0,end).trim();
  }

  const addr=capture(['address','location','deliver to','drop at','முகவரி','இடம்','டெலிவரி இடம்','லொகேஷன்','லோகேஷன்']);
  if(addr) slots.address=addr;
  const product=capture(['product','item','பொருள்']);
  if(product) slots.product=product;
  const landmark=capture(['landmark','லேண்ட்மார்க்','அடையாளம்','அடையாள']);
  if(landmark) slots.landmark=landmark;

  if(/(\bvan\b|வேன்)/i.test(txt)) slots.vehicle='van';
  if(/(\bbike\b|two[- ]?wheeler|பைக்|இரு\s*சக்கர)/i.test(txt)) slots.vehicle='bike';
  if(/(mixed|கலப்பு)/i.test(txt)) slots.vehicleType='mixed';

  const capMatch=txt.match(/(\d{2,4})\s*(kg|kgs|kilogram|கிலோ)/i) || txt.match(/capacity\s*(\d{2,4})/i) || txt.match(/திறன்\s*(\d{2,4})/i);
  if(capMatch){
    const n=parseInt(capMatch[1],10);
    if(Number.isFinite(n)) slots.capacityKg=Math.max(20,Math.min(500,n));
  }

  if(/(fastest|வேக)/i.test(txt)) slots.priority='fastest';
  else if(/(shortest|குறுகிய|குறைந்த\s*தூர)/i.test(txt)) slots.priority='shortest';
  else if(/(\beco\b|எகோ|சேமிப்பு|சூழல்)/i.test(txt)) slots.priority='eco';

  // Map view commands
  if(/(satellite|செயற்கைக்கோள்)/i.test(txt)) slots.view='sat';
  if(/(road|normal|map view|சாலை|வரைபடம்)/i.test(txt)) slots.view='osm';

  // Quick context hint
  if(/(optimizer|optimize|திட்டமிடல்)/i.test(txt)) slots.ctx='opt';
  if(/(add order|order|ஆர்டர்|dashboard|கட்டுப்பாடு)/i.test(txt)) slots.ctx=slots.ctx||'modal';

  // If user just says an address while modal is open, treat it as address
  if(!slots.address && isModalOpen() && !startsWithAny(['home','dashboard','optimizer','export','landmark','simulate','stop','next','done'])){
    if(lower.length>=6 && !product && !landmark) slots.address=txt;
  }
  return slots;
}

function applyVoiceSlots(slots){
  const page=activePageId();
  const ctx=slots.ctx || (isModalOpen()?'modal':(page==='optimizer'?'opt':null));
  let did=false;

  if(slots.view){
    if(page==='optimizer') setBaseLayer('opt',slots.view==='sat'?'sat':'osm');
    else if(page==='dashboard') setBaseLayer('dash',slots.view==='sat'?'sat':'osm');
    did=true;
  }

  if(slots.product){
    if(ctx==='modal') did=setInp('m-product',slots.product) || did;
    if(ctx==='opt') did=setInp('opt-product',slots.product) || did;
  }
  if(slots.landmark){
    if(ctx==='modal') did=setInp('m-landmark',slots.landmark) || did;
    if(ctx==='opt') did=setInp('opt-landmark',slots.landmark) || did;
  }
  if(slots.vehicle){
    if(ctx==='modal') did=setInp('m-vehicle',slots.vehicle) || did;
    // Optimizer "vehicle type" is fleet-level selector (mixed/van/bike)
    did=setInp('sv-vtype',slots.vehicle==='bike'?'bike':'van') || did;
  }
  if(slots.vehicleType){
    did=setInp('sv-vtype',slots.vehicleType) || did;
  }
  if(slots.capacityKg){
    const r=document.getElementById('sv-cap-range');
    if(r){
      r.value=String(slots.capacityKg);
      try{r.dispatchEvent(new Event('input',{bubbles:true}));}catch{}
      did=true;
    }
  }
  if(slots.priority){
    did=setPriority(slots.priority) || did;
  }
  if(slots.address && (ctx==='modal' || ctx==='opt')){
    voiceGeocodeAndSelect(slots.address,ctx);
    did=true;
  }
  return did;
}

function handleVoiceCommand(t){
  const say=(en,ta)=>toast('🎤',currentLang==='ta'?ta:en);
  const is=(...w)=>w.some(x=>t.includes(x));

  // Auto-fill mode (address/product/landmark/vehicle/capacity/priority + map views)
  try{
    const slots=parseVoiceSlots(t);
    if(applyVoiceSlots(slots)) return;
  }catch{}

  if(is('home','முகப்பு')){showPage('home');say('Home','முகப்பு');return;}
  if(is('dashboard','கட்டுப்பாடு')){showPage('dashboard');say('Dashboard','கட்டுப்பாடு');return;}
  if(is('optimizer','optimize','திட்டமிடல்')){showPage('optimizer');say('Optimizer','திட்டமிடல்');return;}
  if(is('export','report','pdf','அறிக்கை')){exportPDF();return;}
  if(is('landmark','landmarks','அடையாள')){toggleLandmarks();return;}
  if(is('help','tour','உதவி')){startTour();say('Help tour opened','உதவி தொடங்கியது');return;}
  if(is('simulate','start','go','உருவகம்','தொடங்கு')){doSimulate();return;}
  if(is('stop','pause','நிறுத்த')){if(simTmr)doSimulate();return;}
  if(is('next','அடுத்து')){
    if(!ORDERS.length){say('No orders','ஆர்டர்கள் இல்லை');return;}
    const next=ORDERS.findIndex(o=>getStatus(o)!=='delivered');
    voiceFocusIdx=(next>=0?next:(voiceFocusIdx+1)%ORDERS.length);
    const o=ORDERS[voiceFocusIdx];
    focusDel(o.lat,o.lng);
    say('Next stop','அடுத்த நிறுத்தம்');
    return;
  }
  if(is('done','delivered','complete','முடிந்த')){
    const idx=ORDERS.findIndex(o=>getStatus(o)!=='delivered');
    if(idx<0){say('All delivered','அனைத்தும் முடிந்தது');return;}
    markDone(idx);
    say('Marked delivered','டெலிவரி முடிந்தது');
    return;
  }
  say('Command: '+t,'கட்டளை: '+t);
}

// ══ PDF EXPORT (Manager report) ══
function exportPDF(){
  try{
    const {jsPDF}=window.jspdf||{};
    if(!jsPDF){toast('❌',currentLang==='ta'?'PDF நூலகம் இல்லை':'PDF library missing');return;}
    const doc=new jsPDF({unit:'pt',format:'a4'});
    const now=new Date();
    const title=`RouteX Logistics Report`;
    doc.setFont('helvetica','bold');doc.setFontSize(18);doc.text(title,40,46);
    doc.setFont('helvetica','normal');doc.setFontSize(10);
    doc.text(`Generated: ${now.toLocaleString()}`,40,66);
    doc.text(`Orders: ${ORDERS.length} · On-Time: ${document.getElementById('kpi-ot')?.textContent||'–'} · Fuel Saved: ${ecoAgg.fuelSavedPct||0}% · CO₂ Prevented: ${ecoAgg.co2PreventedG||0}g`,40,82);
    const rows=ORDERS.map(o=>[
      o.id||'',
      (o.product||'–').toString(),
      (o.address||'').toString(),
      (o.landmark||'–').toString(),
      getStatus(o),
      (o.vehicle||'').toString()
    ]);
    doc.autoTable({
      startY:100,
      head:[['Order','Product','Address','Landmark','Status','Vehicle']],
      body:rows,
      styles:{fontSize:9,cellPadding:4},
      headStyles:{fillColor:[58,71,87],textColor:255},
      columnStyles:{2:{cellWidth:180},3:{cellWidth:120}}
    });
    doc.save(`RouteX-Report-${now.toISOString().slice(0,10)}.pdf`);
    toast('📄',currentLang==='ta'?'PDF அறிக்கை உருவாக்கப்பட்டது':'PDF exported');
  }catch(e){
    toast('❌',currentLang==='ta'?'PDF உருவாக்கம் தோல்வியடைந்தது':'PDF export failed');
  }
}

// ══ PWA / OFFLINE (Service Worker) ══
function initPWA(){
  setOfflineBadge(!navigator.onLine);
  if(location.protocol==='file:'){
    setOfflineBadge(!navigator.onLine);
    return; // SW cannot run on file://
  }
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  }
}

document.addEventListener('DOMContentLoaded',()=>{
  storeLoad();
  initPWA();
  // make sure any theme toggle icons match current state
  const tb=document.getElementById('theme-btn'); if(tb) tb.textContent=isDark?'🌙':'☀️';
  const lt=document.getElementById('login-theme-btn'); if(lt) lt.textContent=isDark?'🌙':'☀️';
  const lg=document.getElementById('lang-theme-btn'); if(lg) lg.textContent=isDark?'🌙':'☀️';
});

// ══ TOUR ══
let tourIdx=0;
let tourSpeaking=false;

function canSpeak(){return 'speechSynthesis' in window && 'SpeechSynthesisUtterance' in window;}
function stopSpeak(){try{speechSynthesis.cancel();}catch{} tourSpeaking=false;}
function speakText(txt){
  if(!canSpeak()){toast('❌',currentLang==='ta'?'இந்த சாதனத்தில் வாசிப்பு ஆதரவு இல்லை':'Text-to-speech not supported');return;}
  stopSpeak();
  const u=new SpeechSynthesisUtterance(String(txt||''));
  u.lang=currentLang==='ta'?'ta-IN':'en-IN';
  u.rate=1;u.pitch=1;u.volume=1;
  u.onend=()=>{tourSpeaking=false;};
  tourSpeaking=true;
  speechSynthesis.speak(u);
}
function toggleTourSpeak(){
  if(!canSpeak()){toast('❌',currentLang==='ta'?'இந்த சாதனத்தில் வாசிப்பு ஆதரவு இல்லை':'Text-to-speech not supported');return;}
  if(speechSynthesis.speaking){stopSpeak();toast('🔇',currentLang==='ta'?'நிறுத்தப்பட்டது':'Stopped');return;}
  const TOUR=getTour();
  const s=TOUR[tourIdx]; if(!s) return;
  const clean=(x)=>String(x||'').replace(/[👋🎉⚡]/g,'').trim();
  speakText(`${clean(s.title)}. ${clean(s.body)}`);
}

function startTour(){tourIdx=0;showTour();}
function showTour(){
  const TOUR=getTour();
  const s=TOUR[tourIdx];if(!s){endTour();return;}
  showPage(s.page);
  document.getElementById('tour-bg').style.display='block';
  const c=document.getElementById('tour-card');c.style.display='block';
  ['top','left','right','bottom','transform'].forEach(p=>c.style[p]='');
  Object.assign(c.style,s.pos);
  const stepLbl=currentLang==='ta'?`படி ${tourIdx+1} / ${TOUR.length}`:`Step ${tourIdx+1} of ${TOUR.length}`;
  const nextLbl=currentLang==='ta'?(tourIdx===TOUR.length-1?'முடி ✓':'அடுத்து →'):(tourIdx===TOUR.length-1?'Finish ✓':'Next →');
  const prevLbl=currentLang==='ta'?'← முந்தைய':'← Back';
  const skipLbl=currentLang==='ta'?'✕ தவிர்':'✕ Skip tour';
  const spkLbl=currentLang==='ta'?'🔊 கேளுங்கள்':'🔊 Listen';
  const dots=TOUR.map((_,i)=>`<div class="td ${i===tourIdx?'a':''}"></div>`).join('');
  c.innerHTML=`<div class="tour-dots">${dots}</div>
    <div class="tour-step-lbl">${stepLbl}</div>
    <div class="tour-ttl">${s.title}</div>
    <div class="tour-body">${s.body}</div>
    <div class="tour-row">
      ${tourIdx>0?`<button class="t-prev" onclick="tourIdx--;showTour()">${prevLbl}</button>`:''}
      <button class="t-prev" onclick="toggleTourSpeak()">${spkLbl}</button>
      <button class="t-next" onclick="tourIdx++;tourIdx>=${TOUR.length}?endTour():showTour()">${nextLbl}</button>
      <span class="t-skip" onclick="endTour()">${skipLbl}</span>
    </div>`;
}
function endTour(){stopSpeak();document.getElementById('tour-bg').style.display='none';document.getElementById('tour-card').style.display='none';showPage('home');}
</script>
</body>
</html>